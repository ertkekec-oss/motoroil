generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------
// SAAS CORE & TENANT MANAGEMENT
// ------------------------------------------

model Tenant {
  id         String @id @default(cuid())
  name       String // Hesap/Müşteri Adı
  ownerEmail String // Ana Hesap Sahibi
  phone      String? // İletişim Telefonu (WhatsApp için)
  status     String @default("ACTIVE") // ACTIVE, SUSPENDED, TRIAL
  setupState String @default("PENDING") // PENDING, COMPLETED

  subscription Subscription?
  companies    Company[]
  users        User[]
  upsellEvents  UpsellEvent[]
  growthEvents  GrowthEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Company {
  id        String  @id @default(cuid())
  tenantId  String
  name      String
  vkn       String
  taxOffice String?
  address       String?
  district      String?
  city          String?

  integratorSettings IntegratorSettings?

  tenant Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users  UserCompanyAccess[]

  // Operational Relationships - Modified to include relations
  invoices         SalesInvoice[]
  purchaseInvoices PurchaseInvoice[]
  products         Product[]
  customers        Customer[]
  suppliers        Supplier[]
  accounts         Account[]
  transactions     Transaction[]
  stockMovements   StockMovement[]
  kasalar          Kasa[]
  checks           Check[]
  serviceRecords   ServiceRecord[]
  quotes           Quote[]
  paymentPlans     PaymentPlan[]
  orders           Order[]
  stockTransfers   StockTransfer[]
  branches         Branch[]
  routes           Route[]
  visits           SalesVisit[]
  salesOrders      SalesOrder[]
  staffTargets     StaffTarget[]

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  Journal           Journal[]
  staff            Staff[]
  MarketplaceConfig MarketplaceConfig[]

  // Fintech Core Relations
  domainEvents      DomainEvent[]
  journalEntries    JournalEntry[]
  inventoryLayers   InventoryLayer[]
  orderFinances     MarketplaceOrderFinance[]
  settlements       MarketplaceSettlement[]
  bankStatements    BankStatement[]
  transactionLedgers MarketplaceTransactionLedger[]
  marketplacePnls   MarketplaceProductPnl[]
  smartPricingRules SmartPricingRule[]
  bankConnections   BankConnection[]
  bankTransactions  BankTransaction[]
  autopilotConfigs  PricingAutopilotConfig[]
  paymentMatches    PaymentMatch[]
  matchingRules     MatchingRule[]
  cashflowForecasts CashflowForecast[]
  fintechAudits     FintechAudit[]

  @@unique([tenantId, vkn])
  @@index([vkn])
}

// ------------------------------------------
// ENTEGRATOR & SETTINGS
// ------------------------------------------

model IntegratorSettings {
  id          String  @id @default(cuid())
  companyId   String  @unique
  provider    String // NILVERA, SOVOS...
  credentials String // Encrypted JSON
  isActive    Boolean @default(true)
  environment String  @default("PRODUCTION")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

// ------------------------------------------
// SUBSCRIPTION & PLAN MANAGEMENT
// ------------------------------------------

model Plan {
  id          String  @id @default(cuid())
  name        String
  description     String?
  price           Decimal  @default(0) @db.Decimal(10, 2)
  currency        String   @default("TRY")
  interval        String   @default("MONTHLY") // MONTHLY, YEARLY
  iyzicoPlanCode  String?  // Iyzico Product Code
  isActive        Boolean  @default(true)

  features      PlanFeature[]
  limits        PlanLimit[]
  subscriptions Subscription[]
}

model Feature {
  id          String  @id @default(cuid())
  key         String  @unique
  name        String
  description String?

  plans PlanFeature[]
}

model PlanFeature {
  planId    String
  featureId String

  plan    Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@id([planId, featureId])
}

model PlanLimit {
  id       String @id @default(cuid())
  planId   String
  resource String
  limit    Int // -1 = Unlimited

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, resource])
}

model Subscription {
  id       String @id @default(cuid())
  tenantId String @unique
  externalId String? @unique // Iyzico Reference Code
  planId   String

  status String
  period String

  startDate DateTime
  endDate   DateTime

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id])

  history SubscriptionHistory[]
}

model SubscriptionHistory {
  id             String   @id @default(cuid())
  subscriptionId String
  action         String
  prevPlanId     String?
  newPlanId      String
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
}

// ------------------------------------------
// EXISTING MODELS WITH RELATION UPDATES
// ------------------------------------------

model User {
  id        String   @id @default(cuid())
  tenantId  String
  email     String   @unique
  name      String?
  password  String
  role      String   @default("USER")
  permissions String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastActiveAt DateTime? 

  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accessibleCompanies UserCompanyAccess[]
  notifications       Notification[]
}

model UserCompanyAccess {
  userId    String
  companyId String
  role      String // COMPANY_ADMIN, ACCOUNTANT, VIEWER

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  @@id([userId, companyId])
}

// --- Operational Models ---

model Order {
  id              String    @id @default(cuid())
  companyId       String
  marketplaceId   String
  orderNumber     String
  marketplace     String
  customerName    String
  customerEmail   String?
  totalAmount     Decimal   @db.Decimal(10, 2)
  currency        String    @default("TRY")
  status          String
  orderDate       DateTime
  items           Json
  shippingAddress Json?
  invoiceAddress  Json?
  cargoTrackingNo String?
  cargoProvider   String?
  rawData         Json?
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  branch          String?   @default("Merkez")

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, orderNumber])
  @@index([marketplace, orderNumber])
  @@index([customerName])
  @@index([orderDate])
  @@index([status])
  @@index([companyId])
}

model Product {
  id                  String    @id @default(cuid())
  companyId           String
  name                String
  code                String
  barcode             String?
  price               Decimal   @db.Decimal(10, 2)
  currency            String    @default("TRY")
  buyPrice            Decimal   @default(0) @db.Decimal(10, 2)
  purchaseCurrency    String    @default("TRY")
  stock               Int       @default(0)
  category            String?
  description         String?
  imageUrl            String?
  minStock            Int       @default(5)
  brand               String?
  type                String?   @default("Ürün")
  supplierName        String? // Changed from 'supplier' to match relation removal if conflict, but keeping as string field for now or linking? Original was String?
  branch              String?   @default("Merkez")
  salesVat            Int?      @default(20)
  salesVatIncluded    Boolean?  @default(true)
  purchaseVat         Int?      @default(20)
  purchaseVatIncluded Boolean?  @default(true)
  salesOiv            Decimal?  @default(0) @db.Decimal(10, 2)
  salesOtv            Decimal?  @default(0) @db.Decimal(10, 2)
  otvType             String?   @default("Ö.T.V yok")
  gtip                String?
  purchaseDiscount    Decimal?  @default(0) @db.Decimal(5, 2)
  otvCode             String?   @default("7")
  unit                String?   @default("Adet")
  deletedAt           DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Variants Support
  isParent      Boolean               @default(false)
  parentId      String?
  parent        Product?              @relation("ProductVariants", fields: [parentId], references: [id])
  variants      Product[]             @relation("ProductVariants")
  variantValues ProductVariantValue[]

  marketplaceMaps MarketplaceProductMap[]
  stocks          Stock[]
  movements       StockMovement[]
  salesOrderItems SalesOrderItem[]
  marketplacePnls MarketplaceProductPnl[]
  pricingRules    SmartPricingRule[]
  
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([code, branch, companyId]) // Updated unique constraint for multi-company
  @@index([name])
  @@index([barcode])
  @@index([code])
  @@index([category])
  @@index([parentId])
  @@index([companyId])
}

model VariantAttribute {
  id        String                  @id @default(cuid())
  companyId String?
  name      String // "Renk", "Beden"
  branch    String?                 @default("Merkez")
  values    VariantAttributeValue[]

  @@unique([name, branch, companyId])
}

model VariantAttributeValue {
  id          String                @id @default(cuid())
  attributeId String
  value       String // "Kırmızı", "XL"
  attribute   VariantAttribute      @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  products    ProductVariantValue[]

  @@index([attributeId])
}

model ProductVariantValue {
  productId        String
  attributeValueId String
  product          Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeValue   VariantAttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)

  @@id([productId, attributeValueId])
}

model StockMovement {
  id          String   @id @default(cuid())
  companyId   String?
  productId   String
  branch      String
  quantity    Int // + for in, - for out
  price       Decimal  @db.Decimal(10, 2) // Purchase price or cost price
  type        String // 'PURCHASE', 'SALE', 'ADJUSTMENT', 'TRANSFER'
  referenceId String? // ID of PurchaseInvoice, SalesInvoice, etc.
  createdAt   DateTime @default(now())
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([branch])
  @@index([createdAt])
  @@index([companyId])
}

model Stock {
  id        String   @id @default(cuid())
  // companyId implied via product
  productId String
  branch    String
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, branch])
  @@index([branch])
}

model MarketplaceProductMap {
  id              String   @id @default(cuid())
  marketplace     String
  marketplaceCode String
  productId       String
  createdAt       DateTime @default(now())
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([marketplace, marketplaceCode])
  @@index([productId])
}

model Supplier {
  id            String            @id @default(cuid())
  companyId     String
  name          String
  phone         String?
  email         String?
  address       String?
  district      String?
  city          String?
  category      String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal           @default(0) @db.Decimal(12, 2)
  branch        String?           @default("Merkez")
  isActive      Boolean           @default(true)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  checks        Check[]
  invoices      PurchaseInvoice[]
  transactions  Transaction[]

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([name])
  @@index([taxNumber])
  @@index([phone])
  @@index([companyId])
}

model PurchaseInvoice {
  id          String    @id @default(cuid())
  companyId   String
  invoiceNo   String
  invoiceDate DateTime
  dueDate     DateTime?
  amount      Decimal   @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  description String?
  supplierId  String
  items       Json?
  status      String    @default("Bekliyor")
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  supplier    Supplier  @relation(fields: [supplierId], references: [id])
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([invoiceNo])
  @@index([invoiceDate])
  @@index([supplierId])
  @@index([status])
  @@index([companyId])
}

model SalesInvoice {
  id           String    @id @default(cuid())
  companyId    String
  invoiceNo    String    @unique
  invoiceDate  DateTime  @default(now())
  amount       Decimal   @db.Decimal(10, 2)
  taxAmount    Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount  Decimal   @db.Decimal(10, 2)
  description  String?
  customerId   String
  items        Json
  status       String    @default("Taslak")
  isFormal     Boolean   @default(false)
  formalType   String?
  formalId     String?   @unique
  formalUuid   String?   @unique
  formalStatus String?
  branch       String?   @default("Merkez")
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  customer     Customer  @relation(fields: [customerId], references: [id])
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([invoiceDate])
  @@index([invoiceNo])
  @@index([status])
  @@index([companyId])
}

model Customer {
  id            String             @id @default(cuid())
  companyId     String
  name          String
  email         String?
  phone         String?
  address       String?
  district      String?
  city          String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal            @default(0) @db.Decimal(12, 2)
  points        Decimal            @default(0) @db.Decimal(10, 2)
  branch        String?            @default("Merkez")
  categoryId    String?
  supplierClass String?
  customerClass String?
  deletedAt     DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  referralCode  String?            @unique
  portalPassword  String?
  isPortalActive  Boolean            @default(false)
  lastPortalLogin DateTime?
  checks        Check[]
  coupons       Coupon[]
  category      CustomerCategory?  @relation(fields: [categoryId], references: [id])
  documents     CustomerDocument[]
  invoices      SalesInvoice[]
  services      ServiceRecord[]
  transactions  Transaction[]
  warranties    Warranty[]
  quotes        Quote[]
  routeStops    RouteStop[]
  visits        SalesVisit[]
  salesOrders   SalesOrder[]

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([name])
  @@index([phone])
  @@index([email])
  @@index([taxNumber])
  @@index([companyId])
}

model ServiceRecord {
  id            String    @id @default(cuid())
  companyId     String?
  customerId    String
  plate         String?
  km            Int?
  nextKm        Int?
  nextDate      DateTime?
  vehicleBrand  String?
  vehicleSerial String?
  notes         String?
  status        String    @default("Tamamlandı")
  totalAmount   Decimal   @db.Decimal(10, 2)
  items         Json
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  customer      Customer  @relation(fields: [customerId], references: [id])
  company       Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([plate])
  @@index([nextDate])
  @@index([status])
  @@index([companyId])
}

model CustomerDocument {
  id         String   @id @default(cuid())
  customerId String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model CustomerCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customers   Customer[]
}

model Kasa {
  id           String        @id @default(cuid())
  companyId    String
  name         String
  type         String        @default("Nakit")
  balance      Decimal       @default(0) @db.Decimal(12, 2)
  currency     String        @default("TRY")
  iban         String?
  isActive     Boolean       @default(true)
  deletedAt    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  branch           String?        @default("Merkez")
  bankConnectionId String?        @unique
  bankConnection   BankConnection? @relation(fields: [bankConnectionId], references: [id])
  transactions     Transaction[]

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([name, branch, companyId])
  @@index([companyId])
}

model Transaction {
  id           String    @id @default(cuid())
  companyId    String
  type         String
  amount       Decimal   @db.Decimal(12, 2)
  description  String?
  date         DateTime  @default(now())
  kasaId       String?
  targetKasaId String?
  customerId   String?
  supplierId   String?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  branch       String?   @default("Merkez")
  customer     Customer? @relation(fields: [customerId], references: [id])
  kasa         Kasa?     @relation(fields: [kasaId], references: [id])
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([supplierId])
  @@index([date])
  @@index([type])
  @@index([kasaId])
  @@index([branch])
  @@index([companyId])
  @@index([createdAt])
}

model Check {
  id          String    @id @default(cuid())
  companyId   String
  type        String
  number      String
  bank        String?
  dueDate     DateTime
  amount      Decimal   @db.Decimal(12, 2)
  status      String    @default("Beklemede")
  description String?
  customerId  String?
  supplierId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  branch      String?   @default("Merkez")
  customer    Customer? @relation(fields: [customerId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([dueDate])
  @@index([status])
  @@index([number])
  @@index([branch])
  @@index([companyId])
}

model AuditLog {
  id        String   @id @default(cuid()) // Keeping cuid as used throughout the project
  tenantId  String?
  userId    String?
  userName  String?
  action    String   // 'CREATE', 'UPDATE', 'DELETE', etc.
  entity    String   // 'Customer', 'Product', 'Transaction', etc.
  entityId  String?
  before    Json?    // RENAMED from oldData for alignment
  after     Json?    // RENAMED from newData for alignment
  details   String?
  ipAddress String?
  userAgent String?  // ADDED
  branch    String?
  createdAt DateTime @default(now())

  @@index([action, entity])
  @@index([entityId])
  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
}

model LoginAttempt {
  id        String   @id @default(cuid())
  ip        String
  username  String
  success   Boolean
  createdAt DateTime @default(now())

  @@index([ip, createdAt])
  @@index([username, createdAt])
}

model Branch {
  id        Int              @id @default(autoincrement())
  companyId String
  name      String
  type      String           @default("Şube")
  city      String?
  district  String?
  address   String?
  phone     String?
  manager   String?
  status    String           @default("Aktif")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  deletedAt DateTime? // Soft delete
  documents BranchDocument[]
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
}

model BranchDocument {
  id         String   @id @default(cuid())
  branchId   Int
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
}

model SuspendedSale {
  id        String   @id @default(cuid())
  label     String
  items     Json
  customer  Json?
  total     Decimal  @db.Decimal(12, 2)
  branch    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Staff {
  id               String          @id @default(cuid())
  tenantId         String?         @default("PLATFORM_ADMIN")
  companyId        String?
  username         String          @unique
  password         String?
  email            String?
  phone            String?
  name             String
  role             String?
  branch           String?         @default("Merkez")
  type             String?         @default("service")
  
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([companyId])
  @@index([username])

  status           String?         @default("Boşta")
  currentJob       String?
  permissions      String[]        @default([])
  performance      Int?            @default(100)
  lastActive       DateTime?       @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?
  salary           Decimal?        @default(17002) @db.Decimal(10, 2)
  address          String?
  age              Int?
  leaveRequests    LeaveRequest[]
  payrolls         Payroll[]
  shifts           Shift[]
  documents        StaffDocument[]
  sentMessages     Message[]       @relation("SentMessages")
  receivedMessages Message[]       @relation("ReceivedMessages")
  routes           Route[]
  visits           SalesVisit[]
  salesOrders      SalesOrder[]
  targets          StaffTarget[]

}

model Message {
  id         String   @id @default(cuid())
  content    String
  senderId   String
  receiverId String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  sender   Staff  @relation("SentMessages", fields: [senderId], references: [id])
  receiver Staff? @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@index([senderId])
  @@index([receiverId])
}

model StaffDocument {
  id         String   @id @default(cuid())
  staffId    String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
}

model Shift {
  id        String   @id @default(cuid())
  staffId   String
  start     DateTime
  end       DateTime
  type      String   @default("Normal")
  branch    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([start])
}

model LeaveRequest {
  id         String   @id @default(cuid())
  staffId    String
  type       String
  startDate  DateTime
  endDate    DateTime
  days       Int
  reason     String?
  status     String   @default("Bekliyor")
  approvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([status])
}

model Payroll {
  id         String    @id @default(cuid())
  staffId    String
  period     String
  salary     Decimal   @db.Decimal(10, 2)
  bonus      Decimal   @default(0) @db.Decimal(10, 2)
  deductions Decimal   @default(0) @db.Decimal(10, 2)
  netPay     Decimal   @db.Decimal(10, 2)
  status     String    @default("Bekliyor")
  paidAt     DateTime?
  note       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  staff      Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, period])
  @@index([period])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("INFO") // INFO, WARNING, SUCCESS, ERROR
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}

model PendingProduct {
  id          String   @id @default(cuid())
  productData Json
  requestedBy String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PendingTransfer {
  id           String   @id @default(cuid())
  transferData Json
  requestedBy  String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model StockTransfer {
  id          String    @id @default(cuid())
  companyId   String?
  productId   String
  productName String
  productCode String
  qty         Int
  fromBranch  String
  toBranch    String
  status      String    @default("IN_TRANSIT")
  requestedBy String?
  shippedAt   DateTime  @default(now())
  receivedAt  DateTime?
  receivedBy  String?
  trackingNo  String?
  notes       String?
  
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([companyId])
  @@index([fromBranch])
  @@index([toBranch])
}

model InventoryAudit {
  id         String    @id @default(cuid())
  branch     String
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  status     String    @default("in_progress")
  items      Json
  reportedBy String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model AppSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

model Warranty {
  id          String   @id @default(cuid())
  customerId  String
  productName String
  serialNo    String
  startDate   DateTime
  endDate     DateTime
  period      String
  status      String   @default("Active")
  invoiceNo   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([serialNo])
}

model SecurityEvent {
  id                String   @id @default(cuid())
  timestamp         DateTime @default(now())
  detectedPhrase    String
  confidence        Float
  hasSaleInLast5Min Boolean  @default(false)
  branch            String
  staff             String
  details           String?
  createdAt         DateTime @default(now())

  @@index([timestamp])
  @@index([branch])
}

model Campaign {
  id           String    @id @default(cuid())
  name         String
  type         String
  description  String?
  conditions   Json
  discountRate Float?
  pointsRate   Float?
  startDate    DateTime  @default(now())
  endDate      DateTime?
  isActive     Boolean   @default(true)
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([type])
  @@index([isActive])
}

model Coupon {
  id                 String    @id @default(cuid())
  code               String    @unique
  type               String
  value              Float
  minPurchaseAmount  Decimal   @default(0) @db.Decimal(10, 2)
  customerCategoryId String?
  customerId         String?
  expiryDate         DateTime?
  isUsed             Boolean   @default(false)
  usedAt             DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  campaignName       String?
  conditions         Json?
  startDate          DateTime  @default(now())
  usageLimit         Int       @default(1)
  usedCount          Int       @default(0)
  customer           Customer? @relation(fields: [customerId], references: [id])

  @@index([code])
  @@index([customerId])
  @@index([isUsed])
}

model PaymentPlan {
  id               String        @id @default(cuid())
  companyId        String?
  title            String
  totalAmount      Decimal       @db.Decimal(12, 2)
  installmentCount Int
  startDate        DateTime
  description      String?
  type             String        @default("Kredi")
  status           String        @default("Active")
  branch           String?       @default("Merkez")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  customerId       String?
  direction        String        @default("OUT")
  supplierId       String?
  installments     Installment[]

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Installment {
  id            String      @id @default(cuid())
  paymentPlanId String
  installmentNo Int
  dueDate       DateTime
  amount        Decimal     @db.Decimal(12, 2)
  status        String      @default("Pending")
  paidAt        DateTime?
  transactionId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  paymentPlan   PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([status])
}

// --- RESMİ MUHASEBE (ACCOUNTING CORE) ---

model Account {
  id         String  @id @default(cuid())
  companyId  String?
  code       String // Örn: "100.01.001"
  name       String // Örn: "Merkez Nakit Kasa"
  parentCode String? // Örn: "100.01" (Ağaç yapısı için)

  // Muhasebe Standartları (Yeni Alanlar)
  accountClass  String? // AKTIF | PASIF | OZKAYNAK | GELIR | GIDER
  normalBalance String? // BORC | ALACAK
  reportGroup   String? // Dönen Varlık, Satış, Finansman vb.
  reportType    String? // BILANCO | GELIR_TABLOSU

  type     String // Eski tip (Uyum için tutuluyor: "Borç" / "Alacak")
  balance  Decimal @default(0) @db.Decimal(15, 2)
  isActive Boolean @default(true)

  // Ön Muhasebe ile Eşleştirme (Mapping)
  kasaId     String? @unique
  bankId     String? @unique // Kasa tablosundaki 'Banka' tipli kayıtlar için
  customerId String?
  supplierId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Branching support for accounts
  branch String? @default("Merkez")

  journalItems JournalItem[]
  company      Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([code, branch, companyId])
  @@index([code])
  @@index([parentCode])
  @@index([companyId])
}

model Journal {
  id          String   @id @default(cuid())
  companyId   String?
  date        DateTime @default(now())
  fisNo       String // Unique per company/year usually, but keep simple unique first
  description String? // Fiş Açıklaması
  type        String   @default("Mahsup") // Tahsil, Tediye, Mahsup

  totalDebt   Decimal @db.Decimal(15, 2)
  totalCredit Decimal @db.Decimal(15, 2)
  isBalanced  Boolean // Borç == Alacak kontrolü

  status String  @default("Draft") // Draft, Approved, Locked (Deftere Yazıldı)
  branch String? @default("Merkez")

  sourceType String? // "Sales", "Purchase", "Payment", "Collection"
  sourceId   String? // Transaction ID, Invoice ID vb.

  isReversal Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items   JournalItem[]
  company Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([fisNo, companyId, branch])
  @@index([date])
  @@index([fisNo])
  @@index([branch])
  @@index([companyId])
}

model JournalItem {
  id          String  @id @default(cuid())
  journalId   String
  accountId   String
  description String?

  debt   Decimal @default(0) @db.Decimal(15, 2) // Borç
  credit Decimal @default(0) @db.Decimal(15, 2) // Alacak

  // e-Defter Required Fields
  documentType  String? // Örn: "FATURA", "MAKBUZ", "CEK", "BANKA_ISLEM"
  documentNo    String? // Belge No
  documentDate  DateTime? // Belge Tarihi
  paymentMethod String? // Örn: "NAKIT", "KREDI_KARTI", "HAVALE"

  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id])
  journal Journal @relation(fields: [journalId], references: [id], onDelete: Cascade)

  @@index([journalId])
  @@index([accountId])
}

model Quote {
  id          String    @id @default(cuid())
  companyId   String?
  quoteNo     String    @unique
  date        DateTime  @default(now())
  validUntil  DateTime?
  customerId  String
  items       Json
  subTotal    Decimal   @default(0) @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @default(0) @db.Decimal(10, 2)
  status      String    @default("Draft") // Draft, Sent, Accepted, Rejected, Converted
  description String?
  branch      String?   @default("Merkez")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  customer    Customer  @relation(fields: [customerId], references: [id])
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([quoteNo])
  @@index([status])
  @@index([companyId])
}

model MarketplaceConfig {
  id        String    @id @default(cuid())
  companyId String?
  type      String    @unique
  settings  Json
  isActive  Boolean   @default(false)
  lastSync  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model ExternalRequest {
  id              String   @id @default(cuid())
  provider        String   // "NILVERA", "IYZICO"
  idempotencyKey  String
  entityType      String   // "SALES_INVOICE", "SUBSCRIPTION"
  entityId        String
  status          String   // PENDING | SUCCESS | FAILED
  responsePayload Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([provider, idempotencyKey])
  @@index([entityId])
  @@index([status])
}

// ------------------------------------------
// GROWTH & AUTOMATION (PHASE 9)
// ------------------------------------------

model GrowthEvent {
  id        String   @id @default(cuid())
  tenantId  String
  type      String   // INACTIVITY_7D, INACTIVITY_14D, LIMIT_80, GROWTH_SIGNAL
  status    String   @default("PENDING") // PENDING, SENT, FAILED, IGNORED
  payload   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([status])
}

model UpsellEvent {
  id           String   @id @default(cuid())
  tenantId     String
  type         String   // SOFT, CONTEXTUAL, HARD
  source       String   // DASHBOARD, INVOICE_PAGE, LIMIT_LOCK
  targetPlanId String?
  converted    Boolean  @default(false)
  payload      Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([converted])
}

// ------------------------------------------
// CMS & WEBSITE MANAGEMENT (NEW)
// ------------------------------------------

model CmsPage {
  id            String       @id @default(cuid())
  slug          String       @unique // "index", "privacy", etc.
  title         String
  description   String?      // SEO Meta Description
  keywords      String?      // SEO Keywords
  isActive      Boolean      @default(true)
  sections      CmsSection[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model CmsSection {
  id          String   @id @default(cuid())
  pageId      String
  type        String   // HERO, FEATURES, COMPARISON, ROLES, STATS, FAQ, CONTACT, FOOTER
  order       Int      @default(0)
  content     Json     // { title: "", subtitle: "", items: [], settings: { fontSize: "16px", ... } }
  isActive    Boolean  @default(true)
  
  page        CmsPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
}

model CmsMenu {
  id        String   @id @default(cuid())
  name      String   // "Header", "Footer"
  items     Json     // [{ label: "Hizmetler", link: "/#features" }, ...]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CmsGeneralSettings {
  id            String   @id @default(cuid())
  logoUrl       String?
  faviconUrl    String?
  siteTitle     String   @default("Periodya")
  footerText    String?
  primaryColor  String   @default("#446ee7")
  contactEmail  String?
  whatsappNumber String?
  customCss     String?
  updatedAt     DateTime @updatedAt
}

// ------------------------------------------
// FIELD SALES & ROUTE MANAGEMENT
// ------------------------------------------

model Route {
  id        String      @id @default(cuid())
  companyId String
  staffId   String
  name      String
  date      DateTime
  status    String      @default("PENDING") // PENDING, ACTIVE, COMPLETED, CANCELLED
  stops     RouteStop[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff     Staff       @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([staffId])
  @@index([date])
}

model RouteStop {
  id         String      @id @default(cuid())
  routeId    String
  customerId String
  sequence   Int
  status     String      @default("PENDING") // PENDING, SKIPPED, VISITED
  plannedTime DateTime?
  
  route      Route       @relation(fields: [routeId], references: [id], onDelete: Cascade)
  customer   Customer    @relation(fields: [customerId], references: [id])
  visits     SalesVisit[]

  @@index([routeId])
  @@index([customerId])
}

model SalesVisit {
  id               String   @id @default(cuid())
  companyId        String
  routeStopId      String?
  customerId       String
  staffId          String
  checkInTime      DateTime @default(now())
  checkOutTime     DateTime?
  checkInLocation  Json?    // {lat, lng, acc}
  checkOutLocation Json?
  notes            String?
  photos           String[]
  isOutOfRange     Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stop       RouteStop? @relation(fields: [routeStopId], references: [id])
  customer   Customer   @relation(fields: [customerId], references: [id])
  staff      Staff      @relation(fields: [staffId], references: [id])
  orders     SalesOrder[]

  @@index([companyId])
  @@index([staffId])
  @@index([customerId])
  @@index([checkInTime])
}

model SalesOrder {
  id          String   @id @default(cuid())
  companyId   String
  visitId     String?
  customerId  String
  staffId     String
  totalAmount Decimal  @db.Decimal(10, 2)
  status      String   @default("PENDING") // PENDING, APPROVED, INVOICED, CANCELLED
  items       SalesOrderItem[]
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  visit     SalesVisit? @relation(fields: [visitId], references: [id])
  customer  Customer   @relation(fields: [customerId], references: [id])
  staff     Staff      @relation(fields: [staffId], references: [id])

  @@index([companyId])
  @@index([visitId])
  @@index([customerId])
}

model SalesOrderItem {
  id           String     @id @default(cuid())
  orderId      String
  productId    String
  productName  String
  quantity     Int
  unitPrice    Decimal    @db.Decimal(10, 2)
  totalPrice   Decimal    @db.Decimal(10, 2)

  order   SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product    @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model StaffTarget {
  id            String   @id @default(cuid())
  staffId       String
  companyId     String
  type          String   // 'TURNOVER', 'VISIT', 'ORDER_COUNT'
  targetValue   Decimal  @db.Decimal(12, 2)
  currentValue  Decimal  @default(0) @db.Decimal(12, 2)
  period        String   // 'MONTHLY', 'WEEKLY'
  month         Int?     // 1-12
  year          Int?
  startDate     DateTime
  endDate       DateTime
  status        String   @default("ACTIVE") // ACTIVE, COMPLETED, FAILED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  staff         Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

// ------------------------------------------
// FINTECH IMMUTABLE CORE (PHASE 10)
// ------------------------------------------

model DomainEvent {
  id            String   @id @default(cuid())
  companyId     String
  tenantId      String?
  eventType     String   // Örn: "PURCHASE_CREATED", "SALE_COMPLETED"
  aggregateType String   // Örn: "ORDER", "INVENTORY", "JOURNAL"
  aggregateId   String
  payload       Json     // Tüm event verisi
  metadata      Json?    // IP, UserAgent vb.
  createdAt     DateTime @default(now())
  createdBy     String?

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, aggregateType, createdAt])
  @@index([aggregateId])
}

model InventoryLayer {
  id                String   @id @default(cuid())
  companyId         String
  productId         String
  sourceEventId     String   // DomainEvent ID referansı
  quantityInitial   Decimal  @db.Decimal(15, 4)
  quantityRemaining Decimal  @db.Decimal(15, 4)
  unitCost          Decimal  @db.Decimal(15, 4)
  branch            String?  @default("Merkez")
  createdAt         DateTime @default(now())

  company   Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  consumptions InventoryConsumption[]

  @@index([productId, quantityRemaining, createdAt])
  @@index([companyId])
}

model InventoryConsumption {
  id                 String   @id @default(cuid())
  companyId          String
  layerId            String
  consumptionEventId String   // DomainEvent ID referansı (Örn: SALE_COMPLETED)
  quantity           Decimal  @db.Decimal(15, 4)
  unitCostAtTime     Decimal  @db.Decimal(15, 4) // Tüketim anındaki maliyet kaydı
  createdAt          DateTime @default(now())

  layer InventoryLayer @relation(fields: [layerId], references: [id])

  @@index([layerId])
  @@index([consumptionEventId])
}

model JournalEntry {
  id            String   @id @default(cuid())
  entryNumber   Int      @unique @default(autoincrement())
  companyId     String
  sourceEventId String?  @unique // Idempotency: Hangi event bu fişi oluşturdu?
  description   String
  date          DateTime @default(now())
  createdAt     DateTime @default(now())
  createdBy     String?

  company Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines   JournalLine[]

  @@index([companyId, date])
}

model JournalLine {
  id                String  @id @default(cuid())
  journalEntryId    String
  accountCode       String
  debit             Decimal @default(0) @db.Decimal(15, 2)
  credit            Decimal @default(0) @db.Decimal(15, 2)
  externalReference String? // Trendyol Transaction ID vb.
  companyId         String
  isOpen            Boolean @default(true) // Reconcile edilip edilmediğini takip eder

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@index([accountCode, companyId, isOpen])
}

model MarketplaceOrderFinance {
  id                String    @id @default(cuid())
  companyId         String
  orderId           String    @unique
  orderNumber       String
  marketplace       String
  commissionRate    Decimal   @db.Decimal(5, 2)
  commissionAmount  Decimal   @db.Decimal(15, 2)
  shippingFee       Decimal   @db.Decimal(15, 2)
  otherFees         Decimal   @db.Decimal(15, 2)
  netProfit         Decimal   @db.Decimal(15, 2)
  receivableBalance Decimal   @db.Decimal(15, 2)
  isSettled         Boolean   @default(false)
  currency          String    @default("TRY")
  lastMatchedAt     DateTime?
  createdAt         DateTime  @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, marketplace])
}

model MarketplaceSettlement {
  id                String    @id @default(cuid())
  companyId         String
  marketplace       String
  settlementId      String    @unique
  periodStart       DateTime
  periodEnd         DateTime
  totalAmount       Decimal   @db.Decimal(15, 2)
  commissionTotal   Decimal   @db.Decimal(15, 2)
  payoutAmount      Decimal   @db.Decimal(15, 2)
  status            String    @default("PENDING") // PENDING, RECONCILED, ERROR
  externalReference String?
  journalEntryId    String?
  reconciledAt      DateTime?
  createdAt         DateTime  @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, marketplace, status])
}

model MarketplaceTransactionLedger {
  id                     String   @id @default(cuid())
  companyId              String
  marketplace            String
  externalReference      String   @unique
  orderId                String?
  orderNumber            String?
  transactionType        String   // SALE, COMMISSION, CARGO, REFUND, PAYOUT
  amount                 Decimal  @db.Decimal(15, 2)
  transactionDate        DateTime
  processingStatus       String   @default("PENDING") // PENDING, MATCHED, RECONCILED, SUSPENSE
  reconciliationStatus   String?  // FULL, PARTIAL, TOLERATED, MISMATCH
  journalEntryId         String?
  matchedBankStatementId String?
  createdAt              DateTime @default(now())

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bankStatement BankStatement? @relation(fields: [matchedBankStatementId], references: [id])

  @@index([companyId, marketplace, processingStatus])
  @@index([externalReference])
}

model BankStatement {
  id               String   @id @default(cuid())
  companyId        String
  bankAccountCode  String   // 102.01 vb.
  statementDate    DateTime
  referenceNo      String   @unique
  description      String
  debit            Decimal  @db.Decimal(15, 2)
  credit           Decimal  @db.Decimal(15, 2)
  balance          Decimal? @db.Decimal(15, 2)
  isMatched        Boolean  @default(false)
  matchedJournalId String?
  createdAt        DateTime @default(now())

  company      Company                        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transLedgers MarketplaceTransactionLedger[]

  @@index([companyId, statementDate])
  @@index([referenceNo])
}

model MarketplaceProductPnl {
  id                String   @id @default(cuid())
  companyId         String
  productId         String
  marketplace       String   // Trendyol, HepsiBurada, vb.
  
  grossRevenue      Decimal  @default(0) @db.Decimal(15, 2)
  commissionTotal   Decimal  @default(0) @db.Decimal(15, 2)
  shippingTotal     Decimal  @default(0) @db.Decimal(15, 2)
  otherFeesTotal    Decimal  @default(0) @db.Decimal(15, 2)
  fifoCostTotal     Decimal  @default(0) @db.Decimal(15, 2)
  refundCostTotal   Decimal  @default(0) @db.Decimal(15, 2)
  
  netProfit         Decimal  @default(0) @db.Decimal(15, 2)
  profitMargin      Decimal  @default(0) @db.Decimal(5, 2) // % bazında
  
  saleCount         Int      @default(0)
  refundCount       Int      @default(0)
  refundedQuantity  Int      @default(0)
  
  lastUpdatedAt     DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, marketplace])
  @@index([companyId, marketplace])
}

model SmartPricingRule {
  id              String   @id @default(cuid())
  companyId       String
  productId       String
  marketplace     String
  targetMargin    Decimal  @db.Decimal(5, 2) // Hedeflenen net kâr marjı (%)
  minPrice        Decimal  @db.Decimal(15, 2)
  maxPrice        Decimal  @db.Decimal(15, 2)
  isActive        Boolean  @default(true)
  lastUpdated     DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, marketplace])
}

model BankConnection {
  id                  String   @id @default(cuid())
  companyId           String
  bankName            String
  bankId             String?  // BANK_FORM_DEFINITIONS key (AKBANK, GARANTI, etc.)
  iban                String   @unique
  currency            String   @default("TRY")
  status              String   @default("ACTIVE") // ACTIVE, ERROR, PENDING_ONBOARDING
  lastSyncAt          DateTime?
  connectionType      String   @default("OPEN_BANKING") // OPEN_BANKING, XML_IMPORT, AUTO_PULL
  integrationMethod   String   @default("MANUAL_UPLOAD") // PULL_HTTP, SFTP_PULL, etc.
  
  // SECURE CREDENTIALS
  credentialsEncrypted Json?    // Encryption at rest (KMS/AES-256)
  credentialsVersion   Int      @default(1)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  company      Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  balances     BankAccountBalance[]
  transactions BankTransaction[]
  kasalar      Kasa[]

  @@index([companyId])
  @@index([companyId, bankId])
}

model BankAccountBalance {
  id               String         @id @default(cuid())
  bankConnectionId String
  balance          Decimal        @db.Decimal(15, 2)
  currency         String
  asOf             DateTime
  createdAt        DateTime       @default(now())
  
  connection       BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
}

model BankTransaction {
  id              String   @id @default(cuid())
  companyId       String
  bankConnectionId String
  transactionId   String   // External Bank ID if provided
  transactionFingerprint String // IBAN + Date + Amount + Desc Hash for Idempotency
  amount          Decimal  @db.Decimal(14, 2)
  currency        String
  description     String?
  transactionDate DateTime
  valueDate       DateTime?
  direction       String   // IN, OUT
  bankRef         String?
  rawPayload      Json
  createdAt       DateTime @default(now())

  company    Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  connection BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
  matches    PaymentMatch[]

  @@unique([bankConnectionId, transactionFingerprint])
  @@index([companyId, transactionDate])
}

model PricingAutopilotConfig {
  id                    String   @id @default(cuid())
  companyId             String
  marketplace           String
  enabled               Boolean  @default(false)
  minMargin             Decimal  @db.Decimal(5, 2)
  maxDailyChangePct     Decimal  @db.Decimal(5, 2)
  pauseOnNegativeStock  Boolean  @default(true)
  pauseOnHighReturnRate Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, marketplace])
}

model PaymentMatch {
  id                String   @id @default(cuid())
  companyId         String
  bankTransactionId String
  ledgerId          String?   // MarketplaceTransactionLedger reference if applicable
  matchType         String    // AUTO, MANUAL
  confidenceScore   Int       @default(100)
  confidenceBucket  String    @default("HIGH") // HIGH, MEDIUM, LOW
  status            String    @default("PENDING") // PENDING, CONFIRMED, REJECTED
  journalEntryId    String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bankTransaction BankTransaction @relation(fields: [bankTransactionId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
}

model MatchingRule {
  id          String   @id @default(cuid())
  companyId   String
  pattern     String   // "ZIRAAT EFT KIRA"
  targetType  String   // EXPENSE, INVOICE, MARKETPLACE
  entityName  String?  // "TRENDYOL"
  accountCode String?  // "770.01"
  confidence  Int      @default(100)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, pattern])
}

model CashflowForecast {
  id           String   @id @default(cuid())
  companyId    String
  horizonDays  Int      // 7, 14, 30
  expectedIn   Decimal  @db.Decimal(15, 2)
  expectedOut  Decimal  @db.Decimal(15, 2)
  netPosition  Decimal  @db.Decimal(15, 2)
  calculatedAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, calculatedAt])
}

model FintechAudit {
  id            String   @id @default(cuid())
  companyId     String
  who           String   // "system" or userId
  action        String   // "PRICE_AUTOPILOT_PUSHED"
  details       String?  // JSON or text
  before        Json?
  after         Json?
  sourceEventId String?
  createdAt     DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, action])
  @@index([createdAt])
}
