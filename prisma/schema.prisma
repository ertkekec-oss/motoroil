generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id           String        @id @default(cuid())
  name         String
  ownerEmail   String
  phone        String?
  status       String        @default("ACTIVE")
  setupState   String        @default("PENDING")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  companies    Company[]
  growthEvents GrowthEvent[]
  subscription Subscription?
  upsellEvents UpsellEvent[]
  users        User[]
}

model Company {
  productConsumptions  ProductConsumption[]
  buySuggestions       BuySuggestion[]
  commissionPlans      CommissionPlan[]
  sellerEarnings       SellerEarning[]
  releaseWindowPolicy  ReleaseWindowPolicy?
  ledgerAccount        LedgerAccount?
  networkListings      NetworkListing[]
  companyProductMaps   CompanyProductMap[]
  payoutDestinations   PayoutDestination[]
  payoutRequests       PayoutRequest[]
  sellerPaymentProfile SellerPaymentProfile?
  providerPayments     ProviderPayment[]
  providerPayouts      ProviderPayout[]
  payoutOutboxes       PayoutOutbox[]                 @relation("OutboxCompany")
  id                   String                         @id @default(cuid())
  tenantId             String
  name                 String
  type                 CompanyType                    @default(BUYER)
  status               CompanyStatus                  @default(ACTIVE)
  taxNumber            String
  vkn                  String
  taxOffice            String?
  address              String?
  district             String?
  city                 String?
  createdAt            DateTime                       @default(now())
  updatedAt            DateTime                       @updatedAt
  accounts             Account[]
  appSettings          AppSettings[]
  bankConnections      BankConnection[]
  bankStatements       BankStatement[]
  bankTransactions     BankTransaction[]
  branches             Branch[]
  cashflowForecasts    CashflowForecast[]
  checks               Check[]
  tenant               Tenant                         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  coupons              Coupon[]
  customers            Customer[]
  customerCategories   CustomerCategory[]
  domainEvents         DomainEvent[]
  externalRequests     ExternalRequest[]
  fintechAudits        FintechAudit[]
  integratorSettings   IntegratorSettings?
  inventoryLayers      InventoryLayer[]
  Journal              Journal[]
  journalEntries       JournalEntry[]
  kasalar              Kasa[]
  MarketplaceConfig    MarketplaceConfig[]
  orderFinances        MarketplaceOrderFinance[]
  productMaps          MarketplaceProductMap[]
  marketplacePnls      MarketplaceProductPnl[]
  settlements          MarketplaceSettlement[]
  transactionLedgers   MarketplaceTransactionLedger[]
  matchingRules        MatchingRule[]
  orders               Order[]
  paymentMatches       PaymentMatch[]
  paymentPlans         PaymentPlan[]
  priceLists           PriceList[]
  autopilotConfigs     PricingAutopilotConfig[]
  products             Product[]
  purchaseInvoices     PurchaseInvoice[]
  quotes               Quote[]
  routes               Route[]
  routeTemplates       RouteTemplate[]
  invoices             SalesInvoice[]
  salesOrders          SalesOrder[]
  visits               SalesVisit[]
  serviceRecords       ServiceRecord[]
  smartPricingRules    SmartPricingRule[]
  staff                Staff[]
  staffTargets         StaffTarget[]
  stockMovements       StockMovement[]
  stockTransfers       StockTransfer[]
  suppliers            Supplier[]
  suspendedSales       SuspendedSale[]
  transactions         Transaction[]
  users                UserCompanyAccess[]
  expenses             Expense[]
  locationRequests     CustomerLocationRequest[]
  securityEvents       SecurityEvent[]                @relation("CompanySecurityEvents")
  campaigns            Campaign[]

  // Commerce Layer v1
  erpCategories      ERPProductCategory[]
  categoryMappings   CategoryMapping[]
  automationPolicy   SellerAutomationPolicy?
  auditLogs          CommerceAuditLog[]
  b2bSuggestions     B2BSuggestion[]
  decisionLogs       AutomationDecisionLog[]
  CommissionSnapshot CommissionSnapshot[]
  FinanceAuditLog    FinanceAuditLog[]

  // Ticket System
  ticketsAsTenant       Ticket[]        @relation("TicketTenant")
  ticketsAsCounterparty Ticket[]        @relation("TicketCounterparty")
  ticketMessages        TicketMessage[]

  // Trust Layer
  sellerTrustScore     SellerTrustScore?
  sellerTrustEvents    SellerTrustEvent[]
  trustScoreRecalcJobs TrustScoreRecalcJob[]

  // Discovery Layer
  discoveryImpressions DiscoveryImpression[]
  createdBoostRules    BoostRule[]

  @@unique([tenantId, vkn])
  @@index([vkn])
}

model IntegratorSettings {
  id          String  @id @default(cuid())
  companyId   String  @unique
  provider    String
  credentials String
  isActive    Boolean @default(true)
  environment String  @default("PRODUCTION")
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Plan {
  id             String         @id @default(cuid())
  name           String
  description    String?
  price          Decimal        @default(0) @db.Decimal(10, 2)
  currency       String         @default("TRY")
  interval       String         @default("MONTHLY")
  iyzicoPlanCode String?
  isActive       Boolean        @default(true)
  features       PlanFeature[]
  limits         PlanLimit[]
  subscriptions  Subscription[]
}

model Feature {
  id          String        @id @default(cuid())
  key         String        @unique
  name        String
  description String?
  plans       PlanFeature[]
}

model PlanFeature {
  planId    String
  featureId String
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)
  plan      Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@id([planId, featureId])
}

model PlanLimit {
  id       String @id @default(cuid())
  planId   String
  resource String
  limit    Int
  plan     Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, resource])
}

model Subscription {
  id         String                @id @default(cuid())
  tenantId   String                @unique
  externalId String?               @unique
  planId     String
  status     String
  period     String
  startDate  DateTime
  endDate    DateTime
  plan       Plan                  @relation(fields: [planId], references: [id])
  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  history    SubscriptionHistory[]
}

model SubscriptionHistory {
  id             String       @id @default(cuid())
  subscriptionId String
  action         String
  prevPlanId     String?
  newPlanId      String
  createdAt      DateTime     @default(now())
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
}

model User {
  id                  String              @id @default(cuid())
  email               String              @unique
  name                String?
  password            String
  role                String              @default("USER")
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  lastActiveAt        DateTime?
  tenantId            String
  permissions         String[]            @default([])
  notifications       Notification[]
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accessibleCompanies UserCompanyAccess[]
}

model UserCompanyAccess {
  userId    String
  companyId String
  role      String
  company   Company @relation(fields: [companyId], references: [id])
  user      User    @relation(fields: [userId], references: [id])

  @@id([userId, companyId])
}

model Order {
  id                String    @id @default(cuid())
  marketplaceId     String
  orderNumber       String
  marketplace       String
  customerName      String
  customerEmail     String?
  totalAmount       Decimal   @db.Decimal(10, 2)
  currency          String    @default("TRY")
  status            String
  orderDate         DateTime
  items             Json
  shippingAddress   Json?
  invoiceAddress    Json?
  cargoTrackingNo   String?
  cargoProvider     String?
  rawData           Json?
  deletedAt         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  branch            String?   @default("Merkez")
  companyId         String
  staffId           String?
  shipmentPackageId String?
  detailsFetchedAt  DateTime? // Tracking for hydration logic
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff             Staff?    @relation("StaffStoreOrders", fields: [staffId], references: [id])

  @@unique([companyId, orderNumber])
  @@index([marketplace, orderNumber])
  @@index([customerName])
  @@index([orderDate])
  @@index([status])
  @@index([companyId])
  @@index([companyId, orderDate, status])
  @@index([companyId, deletedAt, createdAt])
}

model Product {
  networkListings     NetworkListing[]
  b2bSuggestions      B2BSuggestion[]
  companyProductMaps  CompanyProductMap[]
  id                  String                  @id @default(cuid())
  name                String
  code                String
  barcode             String?
  price               Decimal                 @db.Decimal(10, 2)
  buyPrice            Decimal                 @default(0) @db.Decimal(10, 2)
  stock               Int                     @default(0)
  category            String?
  description         String?
  imageUrl            String?
  minStock            Int                     @default(5)
  brand               String?
  type                String?                 @default("Ürün")
  branch              String?                 @default("Merkez")
  salesVat            Int?                    @default(20)
  salesVatIncluded    Boolean?                @default(true)
  purchaseVat         Int?                    @default(20)
  purchaseVatIncluded Boolean?                @default(true)
  salesOiv            Decimal?                @default(0) @db.Decimal(10, 2)
  salesOtv            Decimal?                @default(0) @db.Decimal(10, 2)
  otvType             String?                 @default("Ö.T.V yok")
  gtip                String?
  purchaseDiscount    Decimal?                @default(0) @db.Decimal(5, 2)
  otvCode             String?                 @default("7")
  deletedAt           DateTime?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  companyId           String
  currency            String                  @default("TRY")
  isParent            Boolean                 @default(false)
  parentId            String?
  purchaseCurrency    String                  @default("TRY")
  supplierName        String?
  unit                String?                 @default("Adet")
  marketplaceMaps     MarketplaceProductMap[]
  marketplacePnls     MarketplaceProductPnl[]
  company             Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent              Product?                @relation("ProductVariants", fields: [parentId], references: [id])
  variants            Product[]               @relation("ProductVariants")
  productPrices       ProductPrice[]
  variantValues       ProductVariantValue[]
  salesOrderItems     SalesOrderItem[]
  pricingRules        SmartPricingRule[]
  stocks              Stock[]
  movements           StockMovement[]

  @@unique([code, branch, companyId])
  @@index([name])
  @@index([barcode])
  @@index([code])
  @@index([category])
  @@index([parentId])
  @@index([companyId])
  @@index([companyId, deletedAt, category])
  @@index([companyId, isParent, deletedAt])
}

model VariantAttribute {
  id        String                  @id @default(cuid())
  companyId String?
  name      String
  branch    String?                 @default("Merkez")
  values    VariantAttributeValue[]

  @@unique([name, branch, companyId])
}

model VariantAttributeValue {
  id          String                @id @default(cuid())
  attributeId String
  value       String
  products    ProductVariantValue[]
  attribute   VariantAttribute      @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@index([attributeId])
}

model ProductVariantValue {
  productId        String
  attributeValueId String
  attributeValue   VariantAttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)
  product          Product               @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, attributeValueId])
}

model StockMovement {
  id             String   @id @default(cuid())
  productId      String
  branch         String
  quantity       Int
  price          Decimal  @db.Decimal(10, 2)
  type           String
  referenceId    String?
  idempotencyKey String?  @unique
  createdAt      DateTime @default(now())
  companyId      String?
  company        Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([branch])
  @@index([createdAt])
  @@index([companyId])
  @@index([companyId, createdAt, type])
}

model Stock {
  id        String   @id @default(cuid())
  productId String
  branch    String
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, branch])
  @@index([branch])
}

model MarketplaceProductMap {
  id              String   @id @default(cuid())
  companyId       String
  marketplace     String
  marketplaceCode String
  productId       String
  createdAt       DateTime @default(now())
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, marketplace, marketplaceCode])
  @@index([productId])
  @@index([companyId])
}

model Supplier {
  id            String            @id @default(cuid())
  name          String
  phone         String?
  email         String?
  address       String?
  category      String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal           @default(0) @db.Decimal(12, 2)
  branch        String?           @default("Merkez")
  isActive      Boolean           @default(true)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  city          String?
  companyId     String
  district      String?
  checks        Check[]
  invoices      PurchaseInvoice[]
  company       Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([name])
  @@index([taxNumber])
  @@index([phone])
  @@index([companyId])
}

model PurchaseInvoice {
  id          String    @id @default(cuid())
  invoiceNo   String
  invoiceDate DateTime
  dueDate     DateTime?
  amount      Decimal   @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  description String?
  supplierId  String
  items       Json?
  status      String    @default("Bekliyor")
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier    Supplier  @relation(fields: [supplierId], references: [id])

  @@index([invoiceNo])
  @@index([invoiceDate])
  @@index([supplierId])
  @@index([status])
  @@index([companyId])
}

model SalesInvoice {
  id           String    @id @default(cuid())
  invoiceNo    String    @unique
  invoiceDate  DateTime  @default(now())
  amount       Decimal   @db.Decimal(10, 2)
  taxAmount    Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount  Decimal   @db.Decimal(10, 2)
  description  String?
  customerId   String
  orderId      String?
  items        Json
  status       String    @default("Taslak")
  isFormal     Boolean   @default(false)
  branch       String?   @default("Merkez")
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  companyId    String
  formalId     String?   @unique
  formalStatus String?
  formalType   String?
  formalUuid   String?   @unique
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([invoiceDate])
  @@index([invoiceNo])
  @@index([status])
  @@index([companyId])
  @@index([orderId])
  @@index([companyId, invoiceDate, status])
}

model Customer {
  id                 String                    @id @default(cuid())
  name               String
  email              String?
  phone              String?
  address            String?
  taxNumber          String?
  taxOffice          String?
  contactPerson      String?
  iban               String?
  balance            Decimal                   @default(0) @db.Decimal(12, 2)
  points             Decimal                   @default(0) @db.Decimal(10, 2)
  branch             String?                   @default("Merkez")
  categoryId         String?
  supplierClass      String?
  customerClass      String?
  deletedAt          DateTime?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  referralCode       String?                   @unique
  city               String?
  companyId          String
  district           String?
  lat                Float? // GPS latitude — pinned on first field sales visit
  lng                Float? // GPS longitude — pinned on first field sales visit
  locationPinnedAt   DateTime? // when the pin was first set
  isPortalActive     Boolean                   @default(false)
  lastPortalLogin    DateTime?
  portalPassword     String?
  checks             Check[]
  coupons            Coupon[]
  category           CustomerCategory?         @relation(fields: [categoryId], references: [id])
  company            Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents          CustomerDocument[]
  quotes             Quote[]
  routeStops         RouteStop[]
  invoices           SalesInvoice[]
  salesOrders        SalesOrder[]
  visits             SalesVisit[]
  services           ServiceRecord[]
  routeTemplateStops RouteTemplateStop[]
  transactions       Transaction[]
  warranties         Warranty[]
  assignedStaffId    String?
  assignedStaff      Staff?                    @relation("StaffCustomers", fields: [assignedStaffId], references: [id])
  locationRequests   CustomerLocationRequest[]

  @@unique([email, companyId])
  @@index([name])
  @@index([phone])
  @@index([email])
  @@index([taxNumber])
  @@index([companyId])
}

model ServiceRecord {
  id            String    @id @default(cuid())
  customerId    String
  plate         String?
  km            Int?
  nextKm        Int?
  nextDate      DateTime?
  vehicleBrand  String?
  vehicleSerial String?
  notes         String?
  status        String    @default("Tamamlandı")
  totalAmount   Decimal   @db.Decimal(10, 2)
  items         Json
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer      Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([plate])
  @@index([nextDate])
  @@index([status])
  @@index([companyId])
}

model CustomerDocument {
  id         String   @id @default(cuid())
  customerId String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model CustomerCategory {
  id          String     @id @default(cuid())
  companyId   String
  name        String
  description String?
  priceListId String?
  isDefault   Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customers   Customer[]
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  priceList   PriceList? @relation(fields: [priceListId], references: [id])

  @@unique([companyId, name])
  @@index([companyId])
  @@index([priceListId])
}

model PriceList {
  id            String             @id @default(cuid())
  companyId     String
  name          String
  description   String?
  currency      String             @default("TRY")
  isDefault     Boolean            @default(false)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  categories    CustomerCategory[]
  company       Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  productPrices ProductPrice[]

  @@unique([companyId, name])
  @@index([companyId])
}

model ProductPrice {
  id                String    @id @default(cuid())
  companyId         String
  productId         String
  priceListId       String
  price             Decimal   @db.Decimal(12, 2)
  isManualOverride  Boolean   @default(false)
  derivedFromListId String?
  formulaMarkupBps  Int?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  priceList         PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, priceListId], name: "companyId_productId_priceListId")
  @@index([productId])
  @@index([priceListId])
  @@index([companyId])
}

model Kasa {
  id               String          @id @default(cuid())
  name             String
  type             String          @default("Nakit")
  balance          Decimal         @default(0) @db.Decimal(12, 2)
  currency         String          @default("TRY")
  isActive         Boolean         @default(true)
  deletedAt        DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  branch           String?         @default("Merkez")
  companyId        String
  bankConnectionId String?         @unique
  iban             String?
  bankConnection   BankConnection? @relation(fields: [bankConnectionId], references: [id])
  company          Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions     Transaction[]

  @@unique([name, branch, companyId])
  @@index([companyId])
}

model Transaction {
  id           String      @id @default(cuid())
  type         String
  amount       Decimal     @db.Decimal(12, 2)
  description  String?
  date         DateTime    @default(now())
  kasaId       String?
  targetKasaId String?
  customerId   String?
  supplierId   String?
  deletedAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  branch       String?     @default("Merkez")
  visitId      String?
  companyId    String
  company      Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer?   @relation(fields: [customerId], references: [id])
  kasa         Kasa?       @relation(fields: [kasaId], references: [id])
  supplier     Supplier?   @relation(fields: [supplierId], references: [id])
  visit        SalesVisit? @relation(fields: [visitId], references: [id])

  @@index([customerId])
  @@index([supplierId])
  @@index([date])
  @@index([type])
  @@index([kasaId])
  @@index([branch])
  @@index([companyId])
  @@index([createdAt])
}

model Check {
  id          String    @id @default(cuid())
  type        String
  number      String
  bank        String?
  dueDate     DateTime
  amount      Decimal   @db.Decimal(12, 2)
  status      String    @default("Beklemede")
  description String?
  customerId  String?
  supplierId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  branch      String?   @default("Merkez")
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer? @relation(fields: [customerId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  @@index([dueDate])
  @@index([status])
  @@index([number])
  @@index([branch])
  @@index([companyId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userName  String?
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  branch    String?
  createdAt DateTime @default(now())
  after     Json?
  before    Json?
  tenantId  String?
  userAgent String?

  @@index([action, entity])
  @@index([entityId])
  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
  @@index([tenantId, entity, createdAt])
  @@index([tenantId, action, createdAt])
}

model LoginAttempt {
  id        String   @id @default(cuid())
  ip        String
  username  String
  success   Boolean
  createdAt DateTime @default(now())

  @@index([ip, createdAt])
  @@index([username, createdAt])
}

model Branch {
  id        Int              @id @default(autoincrement())
  name      String
  type      String           @default("Şube")
  city      String?
  address   String?
  phone     String?
  manager   String?
  status    String           @default("Aktif")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  deletedAt DateTime?
  companyId String
  district  String?
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents BranchDocument[]

  @@unique([companyId, name])
}

model BranchDocument {
  id         String   @id @default(cuid())
  branchId   Int
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
}

model SuspendedSale {
  id        String   @id @default(cuid())
  companyId String?
  label     String
  items     Json
  customer  Json?
  total     Decimal  @db.Decimal(12, 2)
  branch    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Staff {
  id                  String                    @id @default(cuid())
  username            String                    @unique
  password            String?
  email               String?
  name                String
  role                String?
  branch              String?                   @default("Merkez")
  type                String?                   @default("service")
  status              String?                   @default("Boşta")
  currentJob          String?
  permissions         String[]                  @default([])
  performance         Int?                      @default(100)
  lastActive          DateTime?                 @default(now())
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  deletedAt           DateTime?
  salary              Decimal?                  @default(17002) @db.Decimal(10, 2)
  address             String?
  city                String?
  district            String?
  birthDate           DateTime?
  maritalStatus       String?
  bloodType           String?
  militaryStatus      String?
  educationLevel      String?
  hasDriverLicense    Boolean?                  @default(false)
  reference           String?
  relativeName        String?
  relativePhone       String?
  healthReport        String?
  certificate         String?
  notes               String?
  companyId           String?
  phone               String?
  tenantId            String?                   @default("PLATFORM_ADMIN")
  assignedCategoryIds String[]                  @default([])
  leaveRequests       LeaveRequest[]
  receivedMessages    Message[]                 @relation("ReceivedMessages")
  sentMessages        Message[]                 @relation("SentMessages")
  payrolls            Payroll[]
  routes              Route[]
  salesOrders         SalesOrder[]
  visits              SalesVisit[]
  shifts              Shift[]
  company             Company?                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents           StaffDocument[]
  targets             StaffTarget[]
  storeOrders         Order[]                   @relation("StaffStoreOrders")
  attendance          Attendance[]
  expenses            Expense[]                 @relation("StaffExpenses")
  assignedCustomers   Customer[]                @relation("StaffCustomers")
  locationRequests    CustomerLocationRequest[]

  // PDKS & Puantaj Fields
  workType          String? @default("FULL_TIME") // FULL_TIME, PART_TIME, CONTRACT
  shiftTemplate     String? // "09:00-18:00" etc.
  weeklyOffDays     String? @default("Sunday")
  dailyWorkingHours Float?  @default(8)

  @@index([tenantId])
  @@index([companyId])
  @@index([username])
}

model Message {
  id         String   @id @default(cuid())
  content    String
  senderId   String
  receiverId String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiver   Staff?   @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     Staff    @relation("SentMessages", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([receiverId])
}

model StaffDocument {
  id         String   @id @default(cuid())
  staffId    String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
}

model Shift {
  id        String   @id @default(cuid())
  staffId   String
  start     DateTime
  end       DateTime
  type      String   @default("Normal")
  branch    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([start])
}

model LeaveRequest {
  id         String   @id @default(cuid())
  staffId    String
  type       String
  startDate  DateTime
  endDate    DateTime
  days       Int
  reason     String?
  status     String   @default("Bekliyor")
  approvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([status])
}

model Attendance {
  id           String    @id @default(cuid())
  staffId      String
  date         DateTime  @default(now())
  checkIn      DateTime
  checkOut     DateTime?
  locationIn   String? // GPS coords or Brach name
  locationOut  String?
  deviceInfo   String?
  status       String    @default("ON_TIME") // ON_TIME, LATE, EARLY_EXIT, OVERTIME
  workingHours Float?    @default(0)
  isPuantajOk  Boolean   @default(false)
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  staff        Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([date])
}

model Payroll {
  id         String    @id @default(cuid())
  staffId    String
  period     String
  salary     Decimal   @db.Decimal(10, 2)
  bonus      Decimal   @default(0) @db.Decimal(10, 2)
  deductions Decimal   @default(0) @db.Decimal(10, 2)
  netPay     Decimal   @db.Decimal(10, 2)
  status     String    @default("Bekliyor")
  paidAt     DateTime?
  note       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  staff      Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, period])
  @@index([period])
}

model Notification {
  id        String   @id @default(cuid())
  type      String   @default("INFO")
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  link      String?
  message   String
  title     String
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}

model PendingProduct {
  id          String   @id @default(cuid())
  productData Json
  requestedBy String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PendingTransfer {
  id           String   @id @default(cuid())
  transferData Json
  requestedBy  String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model StockTransfer {
  id          String    @id @default(cuid())
  productId   String
  productName String
  productCode String
  qty         Int
  fromBranch  String
  toBranch    String
  status      String    @default("IN_TRANSIT")
  requestedBy String?
  shippedAt   DateTime  @default(now())
  receivedAt  DateTime?
  receivedBy  String?
  trackingNo  String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyId   String?
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([companyId])
  @@index([fromBranch])
  @@index([toBranch])
}

model InventoryAudit {
  id         String    @id @default(cuid())
  branch     String
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  status     String    @default("in_progress")
  items      Json
  reportedBy String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model AppSettings {
  id        String   @id @default(cuid())
  companyId String
  key       String
  value     Json
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, key])
  @@index([companyId])
}

model Warranty {
  id          String   @id @default(cuid())
  customerId  String
  productName String
  serialNo    String
  startDate   DateTime
  endDate     DateTime
  period      String
  status      String   @default("Active")
  invoiceNo   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([serialNo])
}

model SecurityEvent {
  id                String   @id @default(cuid())
  timestamp         DateTime @default(now())
  detectedPhrase    String
  confidence        Float
  hasSaleInLast5Min Boolean
  branch            String?
  staff             String?
  details           String?
  createdAt         DateTime @default(now())
  companyId         String?
  company           Company? @relation("CompanySecurityEvents", fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([timestamp])
  @@index([branch])
}

model Campaign {
  id           String    @id @default(cuid())
  companyId    String?
  name         String
  type         String
  description  String?
  conditions   Json
  discountRate Float?
  pointsRate   Float?
  startDate    DateTime  @default(now())
  endDate      DateTime?
  isActive     Boolean   @default(true)
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  targetCustomerCategoryIds String[] @default([])

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([isActive])
}

model Coupon {
  id                 String    @id @default(cuid())
  companyId          String?
  code               String    @unique
  type               String
  value              Float
  minPurchaseAmount  Decimal   @default(0) @db.Decimal(10, 2)
  customerCategoryId String?
  customerId         String?
  expiryDate         DateTime?
  isUsed             Boolean   @default(false)
  usedAt             DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  campaignName       String?
  conditions         Json?
  startDate          DateTime  @default(now())
  usageLimit         Int       @default(1)
  usedCount          Int       @default(0)
  company            Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer           Customer? @relation(fields: [customerId], references: [id])

  @@index([code])
  @@index([customerId])
  @@index([isUsed])
  @@index([companyId])
}

model PaymentPlan {
  id               String        @id @default(cuid())
  title            String
  totalAmount      Decimal       @db.Decimal(12, 2)
  installmentCount Int
  startDate        DateTime
  description      String?
  type             String        @default("Kredi")
  status           String        @default("Active")
  branch           String?       @default("Merkez")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  customerId       String?
  direction        String        @default("OUT")
  supplierId       String?
  companyId        String?
  installments     Installment[]
  company          Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Installment {
  id            String      @id @default(cuid())
  paymentPlanId String
  installmentNo Int
  dueDate       DateTime
  amount        Decimal     @db.Decimal(12, 2)
  status        String      @default("Pending")
  paidAt        DateTime?
  transactionId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  paymentPlan   PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([status])
}

model Account {
  id            String        @id @default(cuid())
  code          String
  name          String
  parentCode    String?
  accountClass  String?
  normalBalance String?
  reportGroup   String?
  reportType    String?
  type          String
  balance       Decimal       @default(0) @db.Decimal(15, 2)
  isActive      Boolean       @default(true)
  kasaId        String?       @unique
  bankId        String?       @unique
  customerId    String?
  supplierId    String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  branch        String?       @default("Merkez")
  companyId     String?
  company       Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalItems  JournalItem[]

  @@unique([code, branch, companyId])
  @@index([code])
  @@index([parentCode])
  @@index([companyId])
}

model Journal {
  id          String        @id @default(cuid())
  date        DateTime      @default(now())
  fisNo       String
  description String?
  type        String        @default("Mahsup")
  totalDebt   Decimal       @db.Decimal(15, 2)
  totalCredit Decimal       @db.Decimal(15, 2)
  isBalanced  Boolean
  status      String        @default("Draft")
  branch      String?       @default("Merkez")
  sourceType  String?
  sourceId    String?
  isReversal  Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  companyId   String?
  company     Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items       JournalItem[]

  @@unique([fisNo, companyId, branch])
  @@index([date])
  @@index([fisNo])
  @@index([branch])
  @@index([companyId])
}

model JournalItem {
  id            String    @id @default(cuid())
  journalId     String
  accountId     String
  description   String?
  debt          Decimal   @default(0) @db.Decimal(15, 2)
  credit        Decimal   @default(0) @db.Decimal(15, 2)
  documentType  String?
  documentNo    String?
  documentDate  DateTime?
  paymentMethod String?
  createdAt     DateTime  @default(now())
  account       Account   @relation(fields: [accountId], references: [id])
  journal       Journal   @relation(fields: [journalId], references: [id], onDelete: Cascade)

  @@index([journalId])
  @@index([accountId])
}

model Quote {
  id          String    @id @default(cuid())
  quoteNo     String    @unique
  date        DateTime  @default(now())
  validUntil  DateTime?
  customerId  String
  items       Json
  subTotal    Decimal   @default(0) @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @default(0) @db.Decimal(10, 2)
  status      String    @default("Draft")
  description String?
  branch      String?   @default("Merkez")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyId   String?
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([quoteNo])
  @@index([status])
  @@index([companyId])
}

model MarketplaceConfig {
  id        String    @id @default(cuid())
  type      String
  settings  Json
  isActive  Boolean   @default(false)
  lastSync  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  companyId String
  deletedAt DateTime?
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, type])
  @@index([companyId])
  @@index([deletedAt])
}

model ExternalRequest {
  id              String   @id @default(cuid())
  companyId       String?
  provider        String
  idempotencyKey  String
  entityType      String
  entityId        String
  status          String
  responsePayload Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  company         Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([provider, idempotencyKey])
  @@index([entityId])
  @@index([status])
  @@index([companyId])
}

model GrowthEvent {
  id        String   @id @default(cuid())
  tenantId  String
  type      String
  status    String   @default("PENDING")
  payload   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([status])
}

model UpsellEvent {
  id           String   @id @default(cuid())
  tenantId     String
  type         String
  source       String
  targetPlanId String?
  converted    Boolean  @default(false)
  payload      Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([converted])
}

model CmsPage {
  id          String       @id @default(cuid())
  slug        String       @unique
  title       String
  description String?
  keywords    String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  sections    CmsSection[]
}

model CmsSection {
  id       String  @id @default(cuid())
  pageId   String
  type     String
  order    Int     @default(0)
  content  Json
  isActive Boolean @default(true)
  page     CmsPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
}

model CmsMenu {
  id        String   @id @default(cuid())
  name      String
  items     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CmsGeneralSettings {
  id             String   @id @default(cuid())
  logoUrl        String?
  faviconUrl     String?
  siteTitle      String   @default("Periodya")
  footerText     String?
  primaryColor   String   @default("#446ee7")
  contactEmail   String?
  whatsappNumber String?
  customCss      String?
  updatedAt      DateTime @updatedAt
}

model RouteTemplate {
  id        String              @id @default(cuid())
  companyId String
  name      String
  stops     RouteTemplateStop[]
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  company   Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model RouteTemplateStop {
  id         String        @id @default(cuid())
  templateId String
  customerId String
  sequence   Int
  template   RouteTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  customer   Customer      @relation(fields: [customerId], references: [id])

  @@index([templateId])
  @@index([customerId])
}

model Route {
  id        String      @id @default(cuid())
  companyId String
  staffId   String
  name      String
  date      DateTime
  status    String      @default("PENDING")
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff     Staff       @relation(fields: [staffId], references: [id], onDelete: Cascade)
  stops     RouteStop[]

  @@index([companyId])
  @@index([staffId])
  @@index([date])
}

model RouteStop {
  id          String       @id @default(cuid())
  routeId     String
  customerId  String
  sequence    Int
  status      String       @default("PENDING")
  plannedTime DateTime?
  customer    Customer     @relation(fields: [customerId], references: [id])
  route       Route        @relation(fields: [routeId], references: [id], onDelete: Cascade)
  visits      SalesVisit[]

  @@index([routeId])
  @@index([customerId])
}

model SalesVisit {
  id               String        @id @default(cuid())
  companyId        String
  routeStopId      String?
  customerId       String
  staffId          String
  checkInTime      DateTime      @default(now())
  checkOutTime     DateTime?
  checkInLocation  Json?
  checkOutLocation Json?
  notes            String?
  result           String? // siparis_alindi | ilgilenmedi | beklemede | randevu_alindi | kapali | bilgi_verildi
  photos           String[]
  isOutOfRange     Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  orders           SalesOrder[]
  transactions     Transaction[]
  company          Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer         Customer      @relation(fields: [customerId], references: [id])
  stop             RouteStop?    @relation(fields: [routeStopId], references: [id])
  staff            Staff         @relation(fields: [staffId], references: [id])

  @@index([companyId])
  @@index([staffId])
  @@index([customerId])
  @@index([checkInTime])
}

model SalesOrder {
  id          String           @id @default(cuid())
  companyId   String
  visitId     String?
  customerId  String
  staffId     String
  totalAmount Decimal          @db.Decimal(10, 2)
  status      String           @default("PENDING")
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer         @relation(fields: [customerId], references: [id])
  staff       Staff            @relation(fields: [staffId], references: [id])
  visit       SalesVisit?      @relation(fields: [visitId], references: [id])
  items       SalesOrderItem[]

  @@index([companyId])
  @@index([visitId])
  @@index([customerId])
}

model SalesOrderItem {
  id          String     @id @default(cuid())
  orderId     String
  productId   String
  productName String
  quantity    Int
  unitPrice   Decimal    @db.Decimal(10, 2)
  totalPrice  Decimal    @db.Decimal(10, 2)
  order       SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product    @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model StaffTarget {
  id             String   @id @default(cuid())
  staffId        String
  companyId      String
  type           String
  targetValue    Decimal  @db.Decimal(12, 2)
  currentValue   Decimal  @default(0) @db.Decimal(12, 2)
  period         String
  month          Int?
  year           Int?
  startDate      DateTime
  endDate        DateTime
  status         String   @default("ACTIVE")
  commissionRate Decimal? @default(0) @db.Decimal(5, 2)
  bonusAmount    Decimal? @default(0) @db.Decimal(12, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff          Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model DomainEvent {
  id            String   @id @default(cuid())
  companyId     String
  tenantId      String?
  eventType     String
  aggregateType String
  aggregateId   String
  payload       Json
  metadata      Json?
  createdAt     DateTime @default(now())
  createdBy     String?
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, aggregateType, createdAt])
  @@index([aggregateId])
}

model InventoryLayer {
  id                String                 @id @default(cuid())
  companyId         String
  productId         String
  sourceEventId     String
  quantityInitial   Decimal                @db.Decimal(15, 4)
  quantityRemaining Decimal                @db.Decimal(15, 4)
  unitCost          Decimal                @db.Decimal(15, 4)
  branch            String?                @default("Merkez")
  createdAt         DateTime               @default(now())
  consumptions      InventoryConsumption[]
  company           Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([productId, quantityRemaining, createdAt])
  @@index([companyId])
}

model InventoryConsumption {
  id                 String         @id @default(cuid())
  companyId          String
  layerId            String
  consumptionEventId String
  quantity           Decimal        @db.Decimal(15, 4)
  unitCostAtTime     Decimal        @db.Decimal(15, 4)
  createdAt          DateTime       @default(now())
  layer              InventoryLayer @relation(fields: [layerId], references: [id])

  @@index([layerId])
  @@index([consumptionEventId])
}

model JournalEntry {
  id            String        @id @default(cuid())
  entryNumber   Int           @unique @default(autoincrement())
  companyId     String
  sourceEventId String?       @unique
  description   String
  date          DateTime      @default(now())
  createdAt     DateTime      @default(now())
  createdBy     String?
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines         JournalLine[]

  @@index([companyId, date])
}

model JournalLine {
  id                String       @id @default(cuid())
  journalEntryId    String
  accountCode       String
  debit             Decimal      @default(0) @db.Decimal(15, 2)
  credit            Decimal      @default(0) @db.Decimal(15, 2)
  externalReference String?
  companyId         String
  isOpen            Boolean      @default(true)
  journalEntry      JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@index([accountCode, companyId, isOpen])
}

model MarketplaceOrderFinance {
  id                String    @id @default(cuid())
  companyId         String
  orderId           String    @unique
  orderNumber       String
  marketplace       String
  commissionRate    Decimal   @db.Decimal(5, 2)
  commissionAmount  Decimal   @db.Decimal(15, 2)
  shippingFee       Decimal   @db.Decimal(15, 2)
  otherFees         Decimal   @db.Decimal(15, 2)
  netProfit         Decimal   @db.Decimal(15, 2)
  receivableBalance Decimal   @db.Decimal(15, 2)
  isSettled         Boolean   @default(false)
  currency          String    @default("TRY")
  lastMatchedAt     DateTime?
  createdAt         DateTime  @default(now())
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, marketplace])
}

model MarketplaceSettlement {
  id                String    @id @default(cuid())
  companyId         String
  marketplace       String
  settlementId      String    @unique
  periodStart       DateTime
  periodEnd         DateTime
  totalAmount       Decimal   @db.Decimal(15, 2)
  commissionTotal   Decimal   @db.Decimal(15, 2)
  payoutAmount      Decimal   @db.Decimal(15, 2)
  status            String    @default("PENDING")
  externalReference String?
  journalEntryId    String?
  reconciledAt      DateTime?
  createdAt         DateTime  @default(now())
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, marketplace, status])
}

model MarketplaceTransactionLedger {
  id                     String         @id @default(cuid())
  companyId              String
  marketplace            String
  externalReference      String         @unique
  orderId                String?
  orderNumber            String?
  transactionType        String
  amount                 Decimal        @db.Decimal(15, 2)
  transactionDate        DateTime
  processingStatus       String         @default("PENDING")
  reconciliationStatus   String?
  journalEntryId         String?
  matchedBankStatementId String?
  createdAt              DateTime       @default(now())
  company                Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bankStatement          BankStatement? @relation(fields: [matchedBankStatementId], references: [id])

  @@index([companyId, marketplace, processingStatus])
  @@index([externalReference])
}

model BankStatement {
  id               String                         @id @default(cuid())
  companyId        String
  bankAccountCode  String
  statementDate    DateTime
  referenceNo      String                         @unique
  description      String
  debit            Decimal                        @db.Decimal(15, 2)
  credit           Decimal                        @db.Decimal(15, 2)
  balance          Decimal?                       @db.Decimal(15, 2)
  isMatched        Boolean                        @default(false)
  matchedJournalId String?
  createdAt        DateTime                       @default(now())
  company          Company                        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transLedgers     MarketplaceTransactionLedger[]

  @@index([companyId, statementDate])
  @@index([referenceNo])
}

model MarketplaceProductPnl {
  id               String   @id @default(cuid())
  companyId        String
  productId        String
  marketplace      String
  grossRevenue     Decimal  @default(0) @db.Decimal(15, 2)
  commissionTotal  Decimal  @default(0) @db.Decimal(15, 2)
  shippingTotal    Decimal  @default(0) @db.Decimal(15, 2)
  otherFeesTotal   Decimal  @default(0) @db.Decimal(15, 2)
  fifoCostTotal    Decimal  @default(0) @db.Decimal(15, 2)
  refundCostTotal  Decimal  @default(0) @db.Decimal(15, 2)
  netProfit        Decimal  @default(0) @db.Decimal(15, 2)
  profitMargin     Decimal  @default(0) @db.Decimal(5, 2)
  saleCount        Int      @default(0)
  refundCount      Int      @default(0)
  lastUpdatedAt    DateTime @updatedAt
  refundedQuantity Int      @default(0)
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, marketplace])
  @@index([companyId, marketplace])
}

model SmartPricingRule {
  id           String   @id @default(cuid())
  companyId    String
  productId    String
  marketplace  String
  targetMargin Decimal  @db.Decimal(5, 2)
  minPrice     Decimal  @db.Decimal(15, 2)
  maxPrice     Decimal  @db.Decimal(15, 2)
  isActive     Boolean  @default(true)
  lastUpdated  DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, marketplace])
}

model BankConnection {
  id                   String               @id @default(cuid())
  companyId            String
  bankName             String
  iban                 String               @unique
  currency             String               @default("TRY")
  lastSyncAt           DateTime?
  status               String               @default("DRAFT")
  createdAt            DateTime             @default(now())
  bankId               String?
  connectionType       String               @default("OPEN_BANKING")
  consecutiveFailures  Int                  @default(0)
  credentialsEncrypted Json?
  credentialsVersion   Int                  @default(1)
  integrationMethod    String               @default("MANUAL_UPLOAD")
  lastErrorAt          DateTime?
  lastErrorCode        String?
  lastErrorMessage     String?
  nextRetryAt          DateTime?
  updatedAt            DateTime             @updatedAt
  balances             BankAccountBalance[]
  company              Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions         BankTransaction[]
  kasalar              Kasa?

  @@index([companyId])
  @@index([companyId, bankId])
}

model BankAccountBalance {
  id               String         @id @default(cuid())
  bankConnectionId String
  balance          Decimal        @db.Decimal(15, 2)
  currency         String
  asOf             DateTime
  createdAt        DateTime       @default(now())
  connection       BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
}

model BankTransaction {
  id                     String         @id @default(cuid())
  companyId              String
  bankConnectionId       String
  transactionId          String
  amount                 Decimal        @db.Decimal(14, 2)
  currency               String
  description            String?
  transactionDate        DateTime
  valueDate              DateTime?
  direction              String
  rawPayload             Json
  createdAt              DateTime       @default(now())
  bankRef                String?
  transactionFingerprint String
  connection             BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
  company                Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  matches                PaymentMatch[]

  @@unique([bankConnectionId, transactionFingerprint])
  @@index([companyId, transactionDate])
}

model PricingAutopilotConfig {
  id                    String   @id @default(cuid())
  companyId             String
  marketplace           String
  enabled               Boolean  @default(false)
  minMargin             Decimal  @db.Decimal(5, 2)
  maxDailyChangePct     Decimal  @db.Decimal(5, 2)
  pauseOnNegativeStock  Boolean  @default(true)
  pauseOnHighReturnRate Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, marketplace])
}

model PaymentMatch {
  id                String          @id @default(cuid())
  companyId         String
  bankTransactionId String
  ledgerId          String?
  matchType         String
  confidenceScore   Int             @default(100)
  confidenceBucket  String          @default("HIGH")
  status            String          @default("PENDING")
  journalEntryId    String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  bankTransaction   BankTransaction @relation(fields: [bankTransactionId], references: [id], onDelete: Cascade)
  company           Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
}

model MatchingRule {
  id          String   @id @default(cuid())
  companyId   String
  pattern     String
  targetType  String
  entityName  String?
  accountCode String?
  confidence  Int      @default(100)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, pattern])
}

model CashflowForecast {
  id           String   @id @default(cuid())
  companyId    String
  horizonDays  Int
  expectedIn   Decimal  @db.Decimal(15, 2)
  expectedOut  Decimal  @db.Decimal(15, 2)
  netPosition  Decimal  @db.Decimal(15, 2)
  calculatedAt DateTime @default(now())
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, calculatedAt])
}

model FintechAudit {
  id            String   @id @default(cuid())
  companyId     String
  who           String
  action        String
  details       String?
  before        Json?
  after         Json?
  sourceEventId String?
  createdAt     DateTime @default(now())
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, action])
  @@index([createdAt])
}

model MarketplaceActionAudit {
  id              String    @id @default(cuid())
  companyId       String
  marketplace     String
  orderId         String?
  actionKey       String
  idempotencyKey  String    @unique
  status          String
  requestPayload  Json?
  responsePayload Json?
  errorMessage    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  jobId           String?
  lockExpiresAt   DateTime?
  failureHistory  Json?
  retryCount      Int       @default(0)

  @@index([companyId, marketplace, createdAt])
  @@index([orderId])
}

model MarketplaceLabel {
  id                String   @id @default(cuid())
  companyId         String
  marketplace       String
  shipmentPackageId String
  storageKey        String
  sha256            String
  size              Int
  contentType       String   @default("application/pdf")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([companyId, marketplace, shipmentPackageId])
  @@index([companyId, createdAt])
}

// --- PDKS MODÜLÜ ---

model PdksDisplay {
  id              String    @id @default(cuid())
  tenantId        String
  siteId          String // Şube veya Lokasyon ID (Branch, Company vb. ile eşleşebilir)
  name            String
  isActive        Boolean   @default(true)
  pairingCode     String    @unique // PDKS-XXXX formatı
  announcement    String?   @db.Text
  lastPublicIp    String?
  lastHeartbeatAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tenantId, siteId])
}

model PdksEmployeeDevice {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  deviceFp    String // Donanım ID veya Fingerprint hash
  isActive    Boolean  @default(true)
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @updatedAt

  @@unique([tenantId, userId, deviceFp])
  @@index([tenantId, userId])
}

model PdksEvent {
  id       String     @id @default(cuid())
  tenantId String
  userId   String
  siteId   String? // Ofis girişinde hangi şube olduğu
  type     PdksType
  mode     PdksMode
  status   PdksStatus @default(APPROVED)

  deviceFp        String
  requestPublicIp String? // Personelin IP'si
  displayPublicIp String? // Tabletin IP'si (kanıt için)

  lat      Float?
  lng      Float?
  accuracy Float?

  clientTime DateTime
  serverTime DateTime @default(now())
  riskScore  Int      @default(0)
  riskFlags  Json? // ["IP_MISMATCH", "LOW_ACCURACY", "IMPOSSIBLE_SPEED"]
  offlineId  String?  @unique // Cihazdaki local UUID
  notes      String?

  @@index([tenantId, userId])
  @@index([tenantId, serverTime])
  @@index([siteId])
}

model PdksIdempotency {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  offlineId String   @unique
  eventId   String?
  createdAt DateTime @default(now())

  @@index([tenantId, userId, offlineId])
}

enum PdksType {
  SHIFT_START
  SHIFT_END
  BREAK_START
  BREAK_END
}

enum PdksMode {
  OFFICE_QR
  FIELD_GPS
}

enum PdksStatus {
  APPROVED
  PENDING
  REJECTED
}

model Expense {
  id          String   @id @default(cuid())
  type        String // Benzin, Yemek, Konaklama, Diğer
  amount      Decimal  @db.Decimal(12, 2)
  description String?
  date        DateTime @default(now())
  receiptUrl  String?
  status      String   @default("Beklemede") // Beklemede, Onaylandı, Reddedildi
  staffId     String
  companyId   String
  staff       Staff    @relation("StaffExpenses", fields: [staffId], references: [id])
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([staffId])
  @@index([companyId])
  @@index([date])
}

// --- YARDIM MERKEZİ (KNOWLEDGE BASE) ---

model HelpCategory {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  order       Int         @default(0)
  topics      HelpTopic[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model HelpTopic {
  id         String       @id @default(cuid())
  categoryId String
  category   HelpCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  title   String
  slug    String  @unique
  excerpt String?
  body    String  @db.Text // Markdown content

  status TopicStatus @default(DRAFT)
  order  Int         @default(0)

  // Visibility: NULL = Global (All Tenants), yoksa specific tenant
  tenantId String?

  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  // tickets Ticket[] // Bu konu ile ilişkilendirilmiş talepler
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TopicStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Support and Ticket system removed in favor of Governance Ticket system
model CustomerLocationRequest {
  id           String   @id @default(cuid())
  customerId   String
  staffId      String
  companyId    String
  requestedLat Float
  requestedLng Float
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  staff    Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
}

// ====================================================================
// ================== NETWORK PAYMENT LAYER MODELLERİ =================
// ====================================================================

enum PaymentProvider {
  ODEL
  IYZICO
}

enum PaymentMode {
  DIRECT
  ESCROW
}

enum PaymentStatus {
  INITIATED
  PAID
  FAILED
  CANCELLED
}

enum PaymentEventStatus {
  RECEIVED
  PROCESSED
  IGNORED
  FAILED
}

model NetworkPayment {
  id                 String          @id @default(cuid())
  networkOrderId     String
  provider           PaymentProvider
  mode               PaymentMode
  status             PaymentStatus   @default(INITIATED)
  amount             Decimal         @db.Decimal(12, 2)
  currency           String          @default("TRY")
  providerPaymentId  String?
  providerPaymentKey String?         @unique
  attemptKey         String?         @unique
  checkoutUrl        String?
  rawInit            Json?           @db.JsonB
  payoutStatus       String          @default("INITIATED")
  releasedAt         DateTime?
  releaseAttemptKey  String?         @unique
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // Order Relation
  order NetworkOrder @relation(fields: [networkOrderId], references: [id], onDelete: Cascade)

  @@index([networkOrderId])
  @@index([networkOrderId, status])
  @@index([status])
}

model PaymentEventInbox {
  id                String             @id @default(cuid())
  provider          PaymentProvider
  providerEventId   String             @unique // Idempotency
  providerPaymentId String?
  networkPaymentId  String?
  raw               Json               @db.JsonB
  receivedAt        DateTime           @default(now())
  processedAt       DateTime?
  status            PaymentEventStatus @default(RECEIVED)
  errorMessage      String?

  @@index([providerPaymentId])
  @@index([networkPaymentId])
  @@index([receivedAt])
  @@index([provider])
}

model NetworkOrder {
  id               String             @id @default(cuid())
  buyerCompanyId   String
  sellerCompanyId  String
  subtotalAmount   Decimal            @db.Decimal(12, 2)
  shippingAmount   Decimal            @db.Decimal(12, 2)
  commissionAmount Decimal            @db.Decimal(12, 2)
  totalAmount      Decimal            @db.Decimal(12, 2)
  currency         String             @default("TRY")
  status           String
  paidAt           DateTime?
  confirmedAt      DateTime?
  completedAt      DateTime?
  completionKey    String?            @unique
  disputeOpenedAt  DateTime?
  itemsHash        String
  networkItems     NetworkOrderItem[]
  items            Json?              @db.JsonB
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  payments           NetworkPayment[]
  shipments          Shipment[]
  commissionSnapshot CommissionSnapshot?
}

model NetworkOrderItem {
  id               String   @id @default(cuid())
  networkOrderId   String
  listingId        String?
  globalProductId  String
  erpProductId     String
  name             String
  price            Decimal  @db.Decimal(10, 2)
  qty              Int
  total            Decimal  @db.Decimal(12, 2)
  isContractPriced Boolean  @default(false)
  createdAt        DateTime @default(now())

  order   NetworkOrder    @relation(fields: [networkOrderId], references: [id], onDelete: Cascade)
  listing NetworkListing? @relation(fields: [listingId], references: [id])

  @@index([networkOrderId])
  @@index([listingId])
}

enum LedgerType {
  CREDIT
  DEBIT
}

model SellerBalanceLedger {
  id              String     @id @default(cuid())
  sellerCompanyId String
  networkOrderId  String
  amount          Decimal    @db.Decimal(12, 2)
  currency        String     @default("TRY")
  type            LedgerType
  idempotencyKey  String     @unique
  createdAt       DateTime   @default(now())

  @@index([sellerCompanyId])
  @@index([networkOrderId])
}

model PlatformCommissionLedger {
  id             String   @id @default(cuid())
  networkOrderId String
  amount         Decimal  @db.Decimal(12, 2)
  currency       String   @default("TRY")
  idempotencyKey String   @unique
  createdAt      DateTime @default(now())

  @@index([networkOrderId])
}

model PayoutEventInbox {
  id              String             @id @default(cuid())
  provider        PaymentProvider
  providerEventId String             @unique
  raw             Json               @db.JsonB
  status          PaymentEventStatus @default(RECEIVED)
  createdAt       DateTime           @default(now())
  processedAt     DateTime?

  @@index([provider])
}

enum ShipmentMode {
  MANUAL
  INTEGRATED
}

enum ShipmentStatus {
  CREATED
  LABEL_CREATED
  IN_TRANSIT
  DELIVERED
  EXCEPTION
  CANCELLED
  COMPLETED
}

enum ShipmentInboxStatus {
  RECEIVED
  PROCESSED
  IGNORED
  FAILED
}

model Shipment {
  id                 String         @id @default(cuid())
  networkOrderId     String
  mode               ShipmentMode
  status             ShipmentStatus @default(CREATED)
  carrierCode        String
  trackingNumber     String?
  normalizedTracking String?
  labelUrl           String?
  sequence           Int            @default(1)
  initKey            String?        @unique
  deliveryNoteUuid   String?
  deliveryNoteStatus String?

  items Json? @db.JsonB // For partial shipments, array of item ids/qty

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order         NetworkOrder             @relation(fields: [networkOrderId], references: [id], onDelete: Cascade)
  events        ShipmentEvent[]
  sellerEarning SellerEarning?
  invoiceLines  ShippingInvoiceLine[]
  allocations   ShipmentCostAllocation[]

  @@unique([networkOrderId, sequence])
  @@unique([carrierCode, trackingNumber])
  @@index([carrierCode, normalizedTracking])
  @@index([carrierCode])
  @@index([trackingNumber])
  @@index([networkOrderId])
  @@index([status])
}

model ShipmentEvent {
  id          String         @id @default(cuid())
  shipmentId  String
  status      ShipmentStatus
  description String?
  occurredAt  DateTime       @default(now())

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
  @@index([occurredAt])
}

model ShipmentEventInbox {
  id             String              @id @default(cuid())
  carrierCode    String
  carrierEventId String              @unique // Idempotency
  trackingNumber String?
  shipmentId     String?
  raw            Json                @db.JsonB
  receivedAt     DateTime            @default(now())
  processedAt    DateTime?
  status         ShipmentInboxStatus @default(RECEIVED)
  errorMessage   String?

  @@index([trackingNumber])
  @@index([shipmentId])
  @@index([receivedAt])
  @@index([carrierCode])
}

enum AttributeType {
  STRING
  NUMBER
  BOOLEAN
  SELECT
}

model GlobalProduct {
  id           String        @id @default(cuid())
  name         String
  categoryId   String?
  description  String?
  barcode      String?
  imageUrl     String?
  status       ProductStatus @default(DRAFT)
  approvalNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  category    GlobalCategory?     @relation(fields: [categoryId], references: [id])
  listings    NetworkListing[]
  companyMaps CompanyProductMap[]

  @@index([categoryId])
  @@index([status])
}

model GlobalCategory {
  id       String  @id @default(cuid())
  name     String
  parentId String?
  slug     String  @unique
  active   Boolean @default(true)

  parent   GlobalCategory?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children GlobalCategory[] @relation("CategoryToCategory")

  attributes CategoryAttribute[]
  products   GlobalProduct[]

  // Reverse links
  mappings         CategoryMapping[]
  listingOverrides B2BListingCategoryOverride[]

  @@index([parentId])
}

model CategoryAttribute {
  id         String        @id @default(cuid())
  categoryId String
  name       String
  type       AttributeType @default(STRING)

  category GlobalCategory    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  options  AttributeOption[]

  @@index([categoryId])
}

model AttributeOption {
  id          String @id @default(cuid())
  attributeId String
  value       String

  attribute CategoryAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@index([attributeId])
}

model ERPProductCategory {
  id              String  @id @default(cuid())
  sellerCompanyId String
  name            String
  parentId        String?
  active          Boolean @default(true)

  company  Company              @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)
  parent   ERPProductCategory?  @relation("ERPCategoryToERPCategory", fields: [parentId], references: [id])
  children ERPProductCategory[] @relation("ERPCategoryToERPCategory")
  mappings CategoryMapping[]

  @@index([sellerCompanyId])
  @@index([parentId])
}

model CategoryMapping {
  id               String            @id @default(cuid())
  sellerCompanyId  String
  erpCategoryId    String
  globalCategoryId String
  confidence       MappingConfidence @default(MANUAL)
  active           Boolean           @default(true)

  company        Company            @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)
  erpCategory    ERPProductCategory @relation(fields: [erpCategoryId], references: [id], onDelete: Cascade)
  globalCategory GlobalCategory     @relation(fields: [globalCategoryId], references: [id], onDelete: Cascade)

  @@index([sellerCompanyId])
  @@index([erpCategoryId])
  @@index([globalCategoryId])
}

model B2BListingCategoryOverride {
  id               String @id @default(cuid())
  listingId        String @unique
  globalCategoryId String

  listing        NetworkListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  globalCategory GlobalCategory @relation(fields: [globalCategoryId], references: [id], onDelete: Cascade)

  @@index([globalCategoryId])
}

model B2BSuggestion {
  id              String           @id @default(cuid())
  sellerCompanyId String
  productId       String? // Direct to Product if simple
  variantId       String? // Prefer variants if exist
  suggestionType  SuggestionType
  score           Float            @default(0)
  reasonsJson     Json // e.g. {"onHand":500,"last30dSales":2,"rule":"OVERSTOCK_SLOW"}
  status          SuggestionStatus @default(OPEN)
  dedupeKey       String?          @unique
  dismissedUntil  DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  company Company  @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)

  @@index([sellerCompanyId])
  @@index([status])
  @@index([productId])
  @@index([variantId])
}

model AutomationDecisionLog {
  id              String   @id @default(cuid())
  sellerCompanyId String
  variantId       String?
  rule            String
  checksJson      Json
  decision        String
  createdAt       DateTime @default(now())

  company Company @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)

  @@index([sellerCompanyId])
  @@index([variantId])
}

model SellerAutomationPolicy {
  id                      String     @id @default(cuid())
  sellerCompanyId         String     @unique
  autoPublishEnabled      Boolean    @default(false)
  rolloutPercent          Int        @default(100)
  understockThresholdDays Int        @default(7)
  minOnHandThreshold      Int        @default(100)
  lowSalesThreshold       Int        @default(3)
  maxReservedRatio        Float      @default(0.2) // e.g. reserved/onHand must be < 0.2
  minMarginPercent        Float? // optional if cost exists
  minListingQualityScore  Int        @default(50)
  defaultVisibility       Visibility @default(NETWORK)
  defaultMinOrderQty      Int        @default(1)
  defaultLeadTimeDays     Int        @default(3)
  allowAutoPriceAdjust    Boolean    @default(false)

  company Company @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)
}

model CommerceAuditLog {
  id              String         @id @default(cuid())
  sellerCompanyId String
  actorType       ActorType
  action          CommerceAction
  entityType      String
  entityId        String
  payloadJson     Json?
  createdAt       DateTime       @default(now())

  company Company @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)

  @@index([sellerCompanyId])
  @@index([action])
  @@index([createdAt])
}

enum MappingConfidence {
  MANUAL
  AUTO
}

enum SuggestionType {
  LIST
  INCREASE_VISIBILITY
  ADJUST_PRICE
  PAUSE
  FIX_LISTING
  SET_PRICE
}

enum SuggestionStatus {
  OPEN
  ACCEPTED
  DISMISSED
  AUTO_APPLIED
  PREVIEW_ONLY
}

enum Visibility {
  NETWORK
  PRIVATE
}

enum ActorType {
  ADMIN
  SELLER
  SYSTEM
}

enum CommerceAction {
  CREATE_LISTING
  ACTIVATE_LISTING
  PAUSE_LISTING
  MAP_CATEGORY
  AUTO_PUBLISH
  AUTO_PAUSE
  POLICY_UPDATE
  SUGGESTION_ACCEPT
  SUGGESTION_DISMISS
  AUTO_PUBLISH_ERROR
}

enum ListingStatus {
  DRAFT
  ACTIVE
  PAUSED
}

model NetworkListing {
  id              String @id @default(cuid())
  globalProductId String
  sellerCompanyId String
  erpProductId    String

  price        Decimal       @db.Decimal(10, 2)
  availableQty Int           @default(0)
  minQty       Int           @default(1)
  leadTimeDays Int           @default(0)
  status       ListingStatus @default(ACTIVE)
  visibility   Visibility    @default(NETWORK)
  packSize     Int?          @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  globalProduct GlobalProduct @relation(fields: [globalProductId], references: [id], onDelete: Cascade)
  company       Company       @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)
  erpProduct    Product       @relation(fields: [erpProductId], references: [id], onDelete: Cascade)

  categoryOverride     B2BListingCategoryOverride?
  networkOrderItems    NetworkOrderItem[]
  discoveryImpressions DiscoveryImpression[]

  @@unique([sellerCompanyId, erpProductId])
  @@index([globalProductId])
  @@index([sellerCompanyId])
  @@index([status])
  @@index([visibility, status])
}

model CompanyProductMap {
  id              String @id @default(cuid())
  companyId       String
  globalProductId String
  erpProductId    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  globalProduct GlobalProduct @relation(fields: [globalProductId], references: [id], onDelete: Cascade)
  erpProduct    Product       @relation(fields: [erpProductId], references: [id], onDelete: Cascade)

  @@unique([companyId, globalProductId])
  @@unique([companyId, erpProductId])
  @@index([companyId])
  @@index([globalProductId])
}

enum RfqStatus {
  DRAFT
  SENT
  RESPONDED
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum OfferStatus {
  PENDING
  COUNTERED
  ACCEPTED
  REJECTED
}

model Rfq {
  id             String    @id @default(cuid())
  buyerCompanyId String
  status         RfqStatus @default(DRAFT)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  items  RfqItem[]
  offers SellerOffer[]

  @@index([buyerCompanyId])
  @@index([status])
}

model RfqItem {
  id              String   @id @default(cuid())
  rfqId           String
  productId       String
  sellerCompanyId String
  quantity        Int
  targetPrice     Decimal? @db.Decimal(12, 2)

  rfq Rfq @relation(fields: [rfqId], references: [id], onDelete: Cascade)

  @@index([rfqId])
  @@index([sellerCompanyId])
}

model SellerOffer {
  id              String      @id @default(cuid())
  rfqId           String
  sellerCompanyId String
  status          OfferStatus @default(PENDING)
  totalPrice      Decimal     @db.Decimal(12, 2)
  expiresAt       DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  rfq   Rfq               @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  items SellerOfferItem[]

  @@index([rfqId])
  @@index([sellerCompanyId])
  @@index([status])
}

model SellerOfferItem {
  id            String  @id @default(cuid())
  sellerOfferId String
  productId     String
  quantity      Int
  unitPrice     Decimal @db.Decimal(12, 2)

  sellerOffer SellerOffer @relation(fields: [sellerOfferId], references: [id], onDelete: Cascade)

  @@index([sellerOfferId])
}

enum ContractStatus {
  DRAFT
  ACTIVE
  SUSPENDED
  EXPIRED
}

enum SettlementCycle {
  INSTANT
  WEEKLY
  MONTHLY
}

enum RecurringFrequency {
  WEEKLY
  MONTHLY
}

enum OrderSourceType {
  CART
  RFQ
  CONTRACT
}

model Contract {
  id              String          @id @default(cuid())
  buyerCompanyId  String
  sellerCompanyId String
  status          ContractStatus  @default(DRAFT)
  startDate       DateTime?
  endDate         DateTime?
  currency        String          @default("TRY")
  paymentMode     PaymentMode     @default(DIRECT)
  settlementCycle SettlementCycle @default(INSTANT)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  items           ContractItem[]
  slas            ContractSLA[]
  recurringOrders RecurringOrder[]

  @@index([buyerCompanyId])
  @@index([sellerCompanyId])
  @@index([status])
}

model ContractItem {
  id            String  @id @default(cuid())
  contractId    String
  productId     String
  baseUnitPrice Decimal @db.Decimal(12, 2)
  minOrderQty   Int     @default(1)

  contract      Contract       @relation(fields: [contractId], references: [id], onDelete: Cascade)
  tiers         ContractTier[]
  reservedStock ReservedStock?

  @@index([contractId])
  @@index([productId])
}

model ContractTier {
  id             String  @id @default(cuid())
  contractItemId String
  minQty         Int
  unitPrice      Decimal @db.Decimal(12, 2)

  contractItem ContractItem @relation(fields: [contractItemId], references: [id], onDelete: Cascade)

  @@index([contractItemId])
}

model ReservedStock {
  id             String @id @default(cuid())
  contractItemId String @unique
  quantity       Int    @default(0)
  allocated      Int    @default(0)

  contractItem ContractItem @relation(fields: [contractItemId], references: [id], onDelete: Cascade)
}

model ContractSLA {
  id                 String  @id @default(cuid())
  contractId         String
  maxDeliveryDays    Int
  latePenaltyPercent Decimal @db.Decimal(5, 2)

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
}

model RecurringOrder {
  id          String             @id @default(cuid())
  contractId  String
  frequency   RecurringFrequency
  dayOfPeriod Int
  nextRunAt   DateTime?
  active      Boolean            @default(true)

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([nextRunAt])
}

model PenaltyLedger {
  id              String   @id @default(cuid())
  sellerCompanyId String
  contractId      String
  amount          Decimal  @db.Decimal(12, 2)
  currency        String   @default("TRY")
  createdAt       DateTime @default(now())

  @@index([contractId])
}

enum CompanyType {
  BUYER
  SELLER
  PLATFORM
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum ProductStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

model ProductConsumption {
  id              String   @id @default(cuid())
  companyId       String
  globalProductId String
  dailyRate       Float
  lastComputedAt  DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, globalProductId])
  @@index([companyId])
}

model BuySuggestion {
  id              String   @id @default(cuid())
  buyerCompanyId  String
  globalProductId String
  daysRemaining   Float
  availableQty    Int      @default(0)
  status          String   @default("OPEN")
  dedupeKey       String   @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company Company @relation(fields: [buyerCompanyId], references: [id], onDelete: Cascade)

  @@index([buyerCompanyId])
  @@index([globalProductId])
  @@index([status])
}

model CommissionPlan {
  id           String    @id @default(cuid())
  name         String
  description  String?
  isDefault    Boolean   @default(false)
  companyId    String? // Null if global plan, string if company-specific override
  currency     String    @default("TRY")
  roundingMode String    @default("HALF_UP")
  precision    Int       @default(2)
  taxInclusive Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  archivedAt   DateTime?

  rules   CommissionRule[]
  // the company this plan is FOR (override)
  company Company?         @relation(fields: [companyId], references: [id], onDelete: Restrict)

  @@unique([companyId, isDefault]) // 1 default rule per company or platform global
  @@index([companyId])
}

enum CommissionRuleScope {
  GLOBAL
  COMPANY_OVERRIDE
}

enum CommissionRuleMatchType {
  CATEGORY
  BRAND
  CATEGORY_AND_BRAND
  DEFAULT
}

model CommissionRule {
  id             String                  @id @default(cuid())
  planId         String
  scope          CommissionRuleScope     @default(GLOBAL)
  matchType      CommissionRuleMatchType @default(DEFAULT)
  category       String?
  brand          String?
  ratePercentage Decimal                 @db.Decimal(5, 2)
  fixedFee       Decimal                 @default(0) @db.Decimal(12, 2)
  priority       Int                     @default(0)

  plan CommissionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@index([planId])
}

model CommissionSnapshot {
  id              String   @id @default(cuid())
  tenantId        String
  networkOrderId  String   @unique
  planId          String?
  appliedRate     Decimal  @db.Decimal(5, 2)
  appliedFixedFee Decimal  @db.Decimal(12, 2)
  totalCommission Decimal  @db.Decimal(12, 2)
  calculatedAt    DateTime @default(now())

  // Note: we link to NetworkOrder since snapshots are on the whole order
  company Company      @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  order   NetworkOrder @relation(fields: [networkOrderId], references: [id], onDelete: Restrict)

  @@unique([tenantId, networkOrderId])
}

enum EarningStatus {
  PENDING
  CLEARED
  RELEASED
  REFUNDED
}

model SellerEarning {
  id                String        @id @default(cuid())
  sellerCompanyId   String
  shipmentId        String        @unique
  grossAmount       Decimal       @default(0) @db.Decimal(12, 2)
  commissionAmount  Decimal       @default(0) @db.Decimal(12, 2)
  chargebackAmount  Decimal       @default(0) @db.Decimal(12, 2)
  netAmount         Decimal       @db.Decimal(12, 2)
  currency          String        @default("TRY")
  status            EarningStatus @default(PENDING)
  expectedClearDate DateTime?
  clearedAt         DateTime?
  releasedAt        DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  archivedAt        DateTime?

  company  Company  @relation(fields: [sellerCompanyId], references: [id], onDelete: Restrict)
  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Restrict)

  @@unique([sellerCompanyId, shipmentId])
  @@index([sellerCompanyId])
  @@index([status])
  @@index([expectedClearDate])
}

model ReleaseWindowPolicy {
  id                  String    @id @default(cuid())
  sellerCompanyId     String    @unique
  isActiveDefault     Boolean   @default(true)
  defaultHoldDays     Int       @default(14)
  allowEarlyRelease   Boolean   @default(false)
  earlyReleaseFeeRate Decimal?  @db.Decimal(5, 2)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  archivedAt          DateTime?

  company Company @relation(fields: [sellerCompanyId], references: [id], onDelete: Restrict)

  @@unique([sellerCompanyId, isActiveDefault])
}

model LedgerAccount {
  id               String    @id @default(cuid())
  companyId        String    @unique
  availableBalance Decimal   @default(0) @db.Decimal(12, 2)
  pendingBalance   Decimal   @default(0) @db.Decimal(12, 2)
  reservedBalance  Decimal   @default(0) @db.Decimal(12, 2)
  currency         String    @default("TRY")
  lastReconciledAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  archivedAt       DateTime?

  company Company       @relation(fields: [companyId], references: [id], onDelete: Restrict)
  entries LedgerEntry[]
}

model LedgerGroup {
  id             String        @id @default(cuid())
  idempotencyKey String        @unique
  tenantId       String
  type           String
  description    String?
  createdAt      DateTime      @default(now())
  entries        LedgerEntry[]

  @@index([tenantId])
}

model LedgerEntry {
  id              String   @id @default(cuid())
  tenantId        String
  ledgerAccountId String
  groupId         String
  accountType     String // e.g., ESCROW_LIABILITY, SELLER_PAYABLE
  direction       String // DEBIT or CREDIT
  amount          Decimal  @db.Decimal(12, 2)
  currency        String   @default("TRY")
  refType         String?
  referenceId     String?
  createdAt       DateTime @default(now())

  account LedgerAccount @relation(fields: [ledgerAccountId], references: [id], onDelete: Restrict)
  group   LedgerGroup   @relation(fields: [groupId], references: [id], onDelete: Restrict)

  @@index([ledgerAccountId])
  @@index([groupId])
  @@index([tenantId])
}

model IdempotencyRecord {
  id          String    @id @default(cuid())
  key         String    @unique
  scope       String
  tenantId    String
  status      String
  lockedAt    DateTime  @default(now())
  completedAt DateTime?
  resultHash  String?

  @@index([tenantId])
}

model FinanceAuditLog {
  id          String   @id @default(cuid())
  tenantId    String
  action      String
  actor       String
  entityId    String
  entityType  String
  payloadJson Json     @db.JsonB
  createdAt   DateTime @default(now())
  company     Company  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
}

model ShippingInvoice {
  id          String    @id @default(cuid())
  carrierId   String
  invoiceNo   String
  periodStart DateTime?
  periodEnd   DateTime?
  currency    String    @default("TRY")
  totalAmount Decimal   @db.Decimal(12, 2)
  rawRef      String?
  parsedJson  Json?
  status      String    @default("PARSED")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  lines ShippingInvoiceLine[]

  @@unique([carrierId, invoiceNo])
}

model ShippingInvoiceLine {
  id                String   @id @default(cuid())
  shippingInvoiceId String
  trackingNo        String
  chargeAmount      Decimal  @db.Decimal(12, 2)
  taxAmount         Decimal? @db.Decimal(12, 2)
  serviceLevel      String?
  matchStatus       String   @default("UNMATCHED")
  matchReason       String?
  shipmentId        String?
  networkOrderId    String?
  sellerTenantId    String?
  buyerTenantId     String?

  invoice  ShippingInvoice @relation(fields: [shippingInvoiceId], references: [id], onDelete: Cascade)
  shipment Shipment?       @relation(fields: [shipmentId], references: [id])

  @@unique([shippingInvoiceId, trackingNo])
}

model ShipmentCostAllocation {
  id                    String   @id @default(cuid())
  shipmentId            String
  shippingInvoiceLineId String?
  model                 String   @default("CHARGEBACK_SELLER")
  sellerShareAmount     Decimal  @db.Decimal(12, 2)
  platformShareAmount   Decimal  @db.Decimal(12, 2)
  buyerShareAmount      Decimal  @db.Decimal(12, 2)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@unique([shipmentId, shippingInvoiceLineId])
}

enum TicketType {
  SHIPPING_DISPUTE
  EARNING_DISPUTE
  RELEASE_REQUEST
  GENERAL
}

enum TicketRelatedEntityType {
  SHIPPING_LINE
  EARNING
  ORDER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  REJECTED
  SLA_BREACH
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketSenderRole {
  BUYER
  SELLER
  PLATFORM_ADMIN
}

enum TicketAuditAction {
  CREATED
  STATUS_CHANGED
  SLA_UPDATED
  RESOLVED
  REJECTED
}

model Ticket {
  id                   String                   @id @default(cuid())
  tenantId             String
  counterpartyTenantId String?
  type                 TicketType               @default(GENERAL)
  relatedEntityType    TicketRelatedEntityType?
  relatedEntityId      String?
  status               TicketStatus             @default(OPEN)
  priority             TicketPriority           @default(LOW)
  slaDueAt             DateTime?
  createdAt            DateTime                 @default(now())
  resolvedAt           DateTime?
  createdByUserId      String?

  messages  TicketMessage[]
  auditLogs TicketAuditLog[]

  // Relations
  tenant       Company  @relation("TicketTenant", fields: [tenantId], references: [id], onDelete: Restrict)
  counterparty Company? @relation("TicketCounterparty", fields: [counterpartyTenantId], references: [id], onDelete: Restrict)

  @@index([tenantId, status])
  @@index([relatedEntityType, relatedEntityId])
}

model TicketMessage {
  id              String           @id @default(cuid())
  ticketId        String
  senderTenantId  String
  senderRole      TicketSenderRole
  message         String           @db.Text
  redactedMessage String           @db.Text
  createdAt       DateTime         @default(now())

  ticket       Ticket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  senderTenant Company @relation(fields: [senderTenantId], references: [id], onDelete: Restrict)

  @@index([ticketId])
}

model TicketAuditLog {
  id            String            @id @default(cuid())
  ticketId      String
  action        TicketAuditAction
  actorTenantId String
  payloadJson   Json              @db.JsonB
  createdAt     DateTime          @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

// --- F2: SELLER TRUST LAYER ---

enum SellerRiskTier {
  A
  B
  C
  D
}

enum TrustEventType {
  SHIPMENT_DELIVERED_ON_TIME
  SHIPMENT_DELIVERED_LATE
  SHIPPING_DISPUTE_OPENED
  SHIPPING_DISPUTE_RESOLVED
  SLA_BREACH
  CHARGEBACK_POSTED
  RECEIVABLE_CREATED
  EARNING_MANUAL_OVERRIDE
  EARNING_RELEASED
}

enum RecalcJobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

enum RecalcReason {
  SCHEDULED
  EVENT_DRIVEN
  MANUAL_ADMIN
}

model SellerTrustScore {
  id             String         @id @default(cuid())
  sellerTenantId String         @unique
  score          Int            @default(100)
  tier           SellerRiskTier @default(A)
  componentsJson Json           @db.JsonB
  computedAt     DateTime       @default(now())
  windowStart    DateTime
  windowEnd      DateTime
  version        Int            @default(1)

  sellerCompany Company @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([sellerTenantId])
  @@index([tier, computedAt])
}

model SellerTrustEvent {
  id             String         @id @default(cuid())
  sellerTenantId String
  type           TrustEventType
  refType        String
  refId          String
  weight         Int            @default(1)
  occurredAt     DateTime
  createdAt      DateTime       @default(now())

  sellerCompany Company @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([sellerTenantId, occurredAt])
}

model TrustScoreRecalcJob {
  id             String          @id @default(cuid())
  sellerTenantId String
  status         RecalcJobStatus @default(PENDING)
  reason         RecalcReason    @default(EVENT_DRIVEN)
  idempotencyKey String          @unique
  errorText      String?         @db.Text
  createdAt      DateTime        @default(now())
  completedAt    DateTime?

  sellerCompany Company @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)
}

// --- F3: DISCOVERY & BOOST LAYER ---

model DiscoveryImpression {
  id             String   @id @default(cuid())
  viewerTenantId String
  listingId      String
  position       Int
  score          Decimal  @db.Decimal(10, 4)
  reasonJson     Json     @db.JsonB
  createdAt      DateTime @default(now())
  requestId      String?

  viewerCompany Company        @relation(fields: [viewerTenantId], references: [id], onDelete: Cascade)
  listing       NetworkListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([viewerTenantId, createdAt])
  @@index([listingId, createdAt])
  @@index([requestId])
}

enum BoostScope {
  LISTING
  SELLER
  CATEGORY
}

model BoostRule {
  id                   String     @id @default(cuid())
  scope                BoostScope
  targetId             String
  multiplier           Decimal    @db.Decimal(10, 2)
  priority             Int        @default(0)
  maxImpressionsPerDay Int?
  startsAt             DateTime
  endsAt               DateTime
  isActive             Boolean    @default(true)
  createdByTenantId    String
  createdAt            DateTime   @default(now())

  creatorCompany Company @relation(fields: [createdByTenantId], references: [id], onDelete: Cascade)

  @@index([scope, targetId, isActive, startsAt, endsAt])
  @@index([isActive, endsAt])
  @@index([startsAt, endsAt])
}

model DiscoveryRequestLog {
  id               String   @id @default(cuid())
  viewerTenantId   String
  requestId        String   @unique
  queryHash        String
  weightsVersion   String
  filtersJson      Json     @db.JsonB
  sortMode         String
  limit            Int
  latencyMs        Int
  dbLatencyMs      Int
  computeLatencyMs Int
  resultsCount     Int
  topResultsJson   Json     @db.JsonB
  createdAt        DateTime @default(now())

  @@index([viewerTenantId, createdAt])
}

model ListingPriceSnapshot {
  id         String   @id @default(cuid())
  listingId  String
  price      Decimal  @db.Decimal(10, 2)
  currency   String   @default("TRY")
  capturedAt DateTime @default(now())

  @@index([listingId, capturedAt])
}

// --- FIN-2A: PAYOUTS & INTERNAL WALLET ---

enum PayoutDestinationType {
  IBAN
}

enum PayoutDestinationStatus {
  ACTIVE
  DISABLED
}

enum PayoutRequestStatus {
  REQUESTED
  APPROVED
  PROCESSING
  PAID_INTERNAL
  REJECTED
  CANCELED
  FAILED
}

model PayoutDestination {
  id               String                  @id @default(cuid())
  sellerTenantId   String
  type             PayoutDestinationType
  ibanMasked       String
  ibanEncrypted    String
  holderNameMasked String
  isDefault        Boolean                 @default(false)
  status           PayoutDestinationStatus @default(ACTIVE)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  sellerCompany Company @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@unique([sellerTenantId, ibanMasked])
  @@index([sellerTenantId, isDefault])
}

model PayoutRequest {
  id               String              @id @default(cuid())
  sellerTenantId   String
  destinationId    String
  amount           Decimal             @db.Decimal(12, 2)
  currency         String              @default("TRY")
  status           PayoutRequestStatus @default(REQUESTED)
  requestedAt      DateTime            @default(now())
  approvedAt       DateTime?
  processedAt      DateTime?
  failureCode      String?
  failureMessage   String?
  idempotencyKey   String              @unique
  createdByUserId  String
  approvedByUserId String?
  note             String?

  sellerCompany Company @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([sellerTenantId, status, requestedAt])
  @@index([status, requestedAt])
}

// --- FIN-2B: EXTERNAL PAYMENT & ENQUEUE (IYZICO) ---

enum SellerPaymentProfileStatus {
  PENDING
  ACTIVE
  DISABLED
}

model SellerPaymentProfile {
  id             String                     @id @default(cuid())
  sellerTenantId String                     @unique
  provider       PaymentProvider            @default(IYZICO)
  subMerchantKey String
  status         SellerPaymentProfileStatus @default(PENDING)
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt

  sellerCompany Company @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)
}

enum ProviderPaymentStatus {
  INIT
  PAID
  FAILED
  REFUNDED
  CHARGEBACK
}

model ProviderPayment {
  id                String                @id @default(cuid())
  tenantId          String // Buyer tenant
  provider          PaymentProvider       @default(IYZICO)
  providerPaymentId String                @unique
  networkPaymentId  String                @unique
  amount            Decimal               @db.Decimal(12, 2)
  currency          String                @default("TRY")
  status            ProviderPaymentStatus @default(INIT)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  buyerCompany Company @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status, createdAt])
}

enum ProviderPayoutStatus {
  QUEUED
  SENT
  SUCCEEDED
  FAILED
  REVERSED
  RECONCILE_REQUIRED
  QUARANTINED
}

model ProviderPayout {
  id               String               @id @default(cuid())
  sellerTenantId   String
  provider         PaymentProvider      @default(IYZICO)
  providerPayoutId String               @unique
  payoutRequestId  String? // Optional generic payout request
  sellerEarningId  String? // Or relation to earning
  shipmentId       String? // Or relation to shipment
  grossAmount      Decimal              @db.Decimal(12, 2)
  commissionAmount Decimal              @db.Decimal(12, 2)
  netAmount        Decimal              @db.Decimal(12, 2)
  currency         String               @default("TRY")
  status           ProviderPayoutStatus @default(QUEUED)
  idempotencyKey   String               @unique
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  sellerCompany Company @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([sellerTenantId, status, createdAt])
  @@index([status, createdAt])
}

enum PayoutOutboxStatus {
  PENDING
  SENDING
  SENT
  FAILED
}

model PayoutOutbox {
  id             String             @id @default(cuid())
  provider       PaymentProvider    @default(IYZICO)
  idempotencyKey String             @unique
  sellerTenantId String
  payloadJson    Json               @db.JsonB
  status         PayoutOutboxStatus @default(PENDING)
  lastError      String?
  attemptCount   Int                @default(0)
  nextRetryAt    DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  sellerCompany Company @relation("OutboxCompany", fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([status, nextRetryAt])
}

enum ProviderWebhookStatus {
  RECEIVED
  PROCESSED
  IGNORED
  FAILED
}

model ProviderWebhookEvent {
  id              String                @id @default(cuid())
  provider        PaymentProvider       @default(IYZICO)
  externalEventId String                @unique
  eventType       String
  payloadJson     Json                  @db.JsonB
  receivedAt      DateTime              @default(now())
  processedAt     DateTime?
  status          ProviderWebhookStatus @default(RECEIVED)

  @@index([provider, receivedAt])
}

// --- FIN-2B.1: PRODUCTION HARDENING ---

enum FinanceIntegrityAlertType {
  LEDGER_UNBALANCED
  FINALIZE_MISSING
  FINALIZE_ORPHAN
  WALLET_DRIFT
  OUTBOX_MISSING
  CRITICAL
}

enum FinanceIntegrityAlertSeverity {
  INFO
  WARNING
  CRITICAL
}

model FinanceIntegrityAlert {
  id          String                        @id @default(cuid())
  type        FinanceIntegrityAlertType
  referenceId String?
  severity    FinanceIntegrityAlertSeverity @default(WARNING)
  detailsJson Json                          @db.JsonB
  resolvedAt  DateTime?
  createdAt   DateTime                      @default(now())

  @@index([type, createdAt])
}

enum FinanceOpsLogSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

model FinanceOpsLog {
  id          String                @id @default(cuid())
  action      String
  entityType  String
  entityId    String?
  severity    FinanceOpsLogSeverity @default(INFO)
  payloadJson Json?                 @db.JsonB
  createdAt   DateTime              @default(now())
}

enum OpsHealthSnapshotScope {
  RUNTIME
  DAILY
}

model OpsHealthSnapshot {
  id          String                 @id @default(cuid())
  scope       OpsHealthSnapshotScope @default(RUNTIME)
  createdAt   DateTime               @default(now())
  payloadJson Json                   @db.JsonB

  @@index([scope, createdAt])
}

model OpsAlertAck {
  id                   String   @id @default(cuid())
  alertType            String
  alertId              String
  acknowledgedByUserId String
  note                 String
  acknowledgedAt       DateTime @default(now())

  @@unique([alertType, alertId])
}

// --- METRICS LAYER ---

model PlatformDailyMetrics {
  id                            String   @id @default(cuid())
  day                           String   @unique // YYYY-MM-DD
  gmvGross                      Decimal  @db.Decimal(12, 2)
  orderCount                    Int
  activeBuyerCount              Int
  activeSellerCount             Int
  takeRevenueCommission         Decimal  @db.Decimal(12, 2)
  takeRevenueBoost              Decimal  @db.Decimal(12, 2)
  takeRate                      Decimal  @db.Decimal(5, 4)
  escrowFloatEndOfDay           Decimal  @db.Decimal(12, 2)
  payoutVolume                  Decimal  @db.Decimal(12, 2)
  payoutCount                   Int
  avgReleaseTimeHours           Decimal  @db.Decimal(12, 2)
  chargebackAmount              Decimal  @db.Decimal(12, 2)
  chargebackCount               Int
  receivableOutstandingEndOfDay Decimal  @db.Decimal(12, 2)
  opsCriticalAlertCount         Int
  createdAt                     DateTime @default(now())
}

enum TenantDailyMetricsRole {
  BUYER
  SELLER
  BOTH
}

model TenantDailyMetrics {
  id                    String                 @id @default(cuid())
  day                   String
  tenantId              String
  role                  TenantDailyMetricsRole
  gmvGross              Decimal                @db.Decimal(12, 2)
  orderCount            Int
  commissionPaid        Decimal                @db.Decimal(12, 2)
  payoutReceived        Decimal                @db.Decimal(12, 2)
  avgReleaseTimeHours   Decimal                @db.Decimal(12, 2)
  disputeCount          Int
  chargebackCount       Int
  receivableOutstanding Decimal                @db.Decimal(12, 2)
  discoveryImpressions  Int
  boostImpressions      Int                    @default(0)
  createdAt             DateTime               @default(now())

  @@unique([day, tenantId])
  @@index([tenantId, day])
}

// --- PILOT LAUNCH & CONTROL LAYER ---

model FeatureFlag {
  id           String   @id @default(cuid())
  key          String   @unique
  description  String
  defaultValue Boolean
  createdAt    DateTime @default(now())
}

model TenantFeatureFlag {
  id         String   @id @default(cuid())
  tenantId   String
  featureKey String
  enabled    Boolean
  createdAt  DateTime @default(now())

  @@unique([tenantId, featureKey])
  @@index([tenantId, featureKey])
}

enum TenantCohort {
  PILOT
  GENERAL
  INTERNAL
}

model TenantRolloutPolicy {
  id                   String       @id @default(cuid())
  tenantId             String       @unique
  cohort               TenantCohort @default(PILOT)
  maxDailyGmv          Decimal?     @db.Decimal(12, 2)
  maxDailyPayout       Decimal?     @db.Decimal(12, 2)
  maxSingleOrderAmount Decimal?     @db.Decimal(12, 2)
  holdDaysOverride     Int?
  earlyReleaseAllowed  Boolean      @default(false)
  payoutPaused         Boolean      @default(false)
  escrowPaused         Boolean      @default(false)
  boostPaused          Boolean      @default(false)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
}

model PilotCohortTag {
  id        String   @id @default(cuid())
  tenantId  String
  tag       String
  createdAt DateTime @default(now())

  @@unique([tenantId, tag])
  @@index([tag])
}

model PlatformCohortDailyMetrics {
  id                    String   @id @default(cuid())
  day                   String // YYYY-MM-DD
  cohortTag             String
  gmvGross              Decimal  @db.Decimal(12, 2)
  orderCount            Int
  payoutVolume          Decimal  @db.Decimal(12, 2)
  takeRevenueCommission Decimal  @db.Decimal(12, 2)
  chargebackAmount      Decimal  @db.Decimal(12, 2)
  createdAt             DateTime @default(now())

  @@unique([day, cohortTag])
}
