generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id           String        @id @default(cuid())
  name         String
  ownerEmail   String
  phone        String?
  status       String        @default("ACTIVE")
  setupState   String        @default("PENDING")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  companies    Company[]
  growthEvents GrowthEvent[]
  subscription Subscription?
  upsellEvents UpsellEvent[]
  users        User[]
}

model Company {
  id                    String                         @id @default(cuid())
  tenantId              String
  name                  String
  vkn                   String
  taxOffice             String?
  address               String?
  district              String?
  city                  String?
  createdAt             DateTime                       @default(now())
  updatedAt             DateTime                       @updatedAt
  status                CompanyStatus                  @default(ACTIVE)
  taxNumber             String
  type                  CompanyType                    @default(BUYER)
  accounts              Account[]
  appSettings           AppSettings[]
  decisionLogs          AutomationDecisionLog[]
  b2bSuggestions        B2BSuggestion[]
  bankConnections       BankConnection[]
  bankStatements        BankStatement[]
  bankTransactions      BankTransaction[]
  createdBoostRules     BoostRule[]
  branches              Branch[]
  buySuggestions        BuySuggestion[]
  campaigns             Campaign[]
  cashflowForecasts     CashflowForecast[]
  categoryMappings      CategoryMapping[]
  checks                Check[]
  auditLogs             CommerceAuditLog[]
  commissionPlans       CommissionPlan[]
  CommissionSnapshot    CommissionSnapshot[]
  tenant                Tenant                         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  companyProductMaps    CompanyProductMap[]
  coupons               Coupon[]
  customers             Customer[]
  customerCategories    CustomerCategory[]
  locationRequests      CustomerLocationRequest[]
  discoveryImpressions  DiscoveryImpression[]
  domainEvents          DomainEvent[]
  erpCategories         ERPProductCategory[]
  expenses              Expense[]
  externalRequests      ExternalRequest[]
  FinanceAuditLog       FinanceAuditLog[]
  fintechAudits         FintechAudit[]
  integratorSettings    IntegratorSettings?
  inventoryLayers       InventoryLayer[]
  Journal               Journal[]
  journalEntries        JournalEntry[]
  kasalar               Kasa[]
  ledgerAccount         LedgerAccount?
  MarketplaceConfig     MarketplaceConfig[]
  orderFinances         MarketplaceOrderFinance[]
  productMaps           MarketplaceProductMap[]
  marketplacePnls       MarketplaceProductPnl[]
  settlements           MarketplaceSettlement[]
  transactionLedgers    MarketplaceTransactionLedger[]
  matchingRules         MatchingRule[]
  networkListings       NetworkListing[]
  orders                Order[]
  paymentMatches        PaymentMatch[]
  paymentPlans          PaymentPlan[]
  payoutDestinations    PayoutDestination[]
  payoutOutboxes        PayoutOutbox[]                 @relation("OutboxCompany")
  payoutRequests        PayoutRequest[]
  priceLists            PriceList[]
  autopilotConfigs      PricingAutopilotConfig[]
  products              Product[]
  productConsumptions   ProductConsumption[]
  providerPayments      ProviderPayment[]
  providerPayouts       ProviderPayout[]
  purchaseInvoices      PurchaseInvoice[]
  quotes                Quote[]
  releaseWindowPolicy   ReleaseWindowPolicy?
  routes                Route[]
  routeTemplates        RouteTemplate[]
  invoices              SalesInvoice[]
  salesOrders           SalesOrder[]
  visits                SalesVisit[]
  securityEvents        SecurityEvent[]                @relation("CompanySecurityEvents")
  automationPolicy      SellerAutomationPolicy?
  sellerEarnings        SellerEarning[]
  sellerPaymentProfile  SellerPaymentProfile?
  sellerTrustEvents     SellerTrustEvent[]
  sellerTrustScore      SellerTrustScore?
  serviceRecords        ServiceRecord[]
  smartPricingRules     SmartPricingRule[]
  staff                 Staff[]
  staffTargets          StaffTarget[]
  stockMovements        StockMovement[]
  stockTransfers        StockTransfer[]
  suppliers             Supplier[]
  suspendedSales        SuspendedSale[]
  ticketsAsCounterparty Ticket[]                       @relation("TicketCounterparty")
  ticketsAsTenant       Ticket[]                       @relation("TicketTenant")
  ticketMessages        TicketMessage[]
  transactions          Transaction[]
  trustScoreRecalcJobs  TrustScoreRecalcJob[]
  users                 UserCompanyAccess[]

  @@unique([tenantId, vkn])
  @@index([vkn])
}

model IntegratorSettings {
  id          String  @id @default(cuid())
  companyId   String  @unique
  provider    String
  credentials String
  isActive    Boolean @default(true)
  environment String  @default("PRODUCTION")
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Plan {
  id             String         @id @default(cuid())
  name           String
  description    String?
  price          Decimal        @default(0) @db.Decimal(10, 2)
  currency       String         @default("TRY")
  interval       String         @default("MONTHLY")
  iyzicoPlanCode String?
  isActive       Boolean        @default(true)
  features       PlanFeature[]
  limits         PlanLimit[]
  subscriptions  Subscription[]
}

model Feature {
  id          String        @id @default(cuid())
  key         String        @unique
  name        String
  description String?
  plans       PlanFeature[]
}

model PlanFeature {
  planId    String
  featureId String
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)
  plan      Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@id([planId, featureId])
}

model PlanLimit {
  id       String @id @default(cuid())
  planId   String
  resource String
  limit    Int
  plan     Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, resource])
}

model Subscription {
  id         String                @id @default(cuid())
  tenantId   String                @unique
  externalId String?               @unique
  planId     String
  status     String
  period     String
  startDate  DateTime
  endDate    DateTime
  plan       Plan                  @relation(fields: [planId], references: [id])
  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  history    SubscriptionHistory[]
}

model SubscriptionHistory {
  id             String       @id @default(cuid())
  subscriptionId String
  action         String
  prevPlanId     String?
  newPlanId      String
  createdAt      DateTime     @default(now())
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
}

model User {
  id                  String              @id @default(cuid())
  email               String              @unique
  name                String?
  password            String
  role                String              @default("USER")
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  lastActiveAt        DateTime?
  tenantId            String
  permissions         String[]            @default([])
  notifications       Notification[]
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accessibleCompanies UserCompanyAccess[]
}

model UserCompanyAccess {
  userId    String
  companyId String
  role      String
  company   Company @relation(fields: [companyId], references: [id])
  user      User    @relation(fields: [userId], references: [id])

  @@id([userId, companyId])
}

model Order {
  id                String    @id @default(cuid())
  marketplaceId     String
  orderNumber       String
  marketplace       String
  customerName      String
  customerEmail     String?
  totalAmount       Decimal   @db.Decimal(10, 2)
  currency          String    @default("TRY")
  status            String
  orderDate         DateTime
  items             Json
  shippingAddress   Json?
  invoiceAddress    Json?
  cargoTrackingNo   String?
  cargoProvider     String?
  rawData           Json?
  deletedAt         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  branch            String?   @default("Merkez")
  companyId         String
  shipmentPackageId String?
  detailsFetchedAt  DateTime?
  staffId           String?
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff             Staff?    @relation("StaffStoreOrders", fields: [staffId], references: [id])

  @@unique([companyId, orderNumber])
  @@index([marketplace, orderNumber])
  @@index([customerName])
  @@index([orderDate])
  @@index([status])
  @@index([companyId])
  @@index([companyId, orderDate, status])
  @@index([companyId, deletedAt, createdAt])
}

model Product {
  id                  String                  @id @default(cuid())
  name                String
  code                String
  barcode             String?
  price               Decimal                 @db.Decimal(10, 2)
  buyPrice            Decimal                 @default(0) @db.Decimal(10, 2)
  stock               Int                     @default(0)
  category            String?
  description         String?
  imageUrl            String?
  minStock            Int                     @default(5)
  brand               String?
  type                String?                 @default("Ürün")
  branch              String?                 @default("Merkez")
  salesVat            Int?                    @default(20)
  salesVatIncluded    Boolean?                @default(true)
  purchaseVat         Int?                    @default(20)
  purchaseVatIncluded Boolean?                @default(true)
  salesOiv            Decimal?                @default(0) @db.Decimal(10, 2)
  salesOtv            Decimal?                @default(0) @db.Decimal(10, 2)
  otvType             String?                 @default("Ö.T.V yok")
  gtip                String?
  purchaseDiscount    Decimal?                @default(0) @db.Decimal(5, 2)
  otvCode             String?                 @default("7")
  deletedAt           DateTime?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  companyId           String
  currency            String                  @default("TRY")
  isParent            Boolean                 @default(false)
  parentId            String?
  purchaseCurrency    String                  @default("TRY")
  supplierName        String?
  unit                String?                 @default("Adet")
  b2bSuggestions      B2BSuggestion[]
  companyProductMaps  CompanyProductMap[]
  marketplaceMaps     MarketplaceProductMap[]
  marketplacePnls     MarketplaceProductPnl[]
  networkListings     NetworkListing[]
  company             Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent              Product?                @relation("ProductVariants", fields: [parentId], references: [id])
  variants            Product[]               @relation("ProductVariants")
  productPrices       ProductPrice[]
  variantValues       ProductVariantValue[]
  salesOrderItems     SalesOrderItem[]
  pricingRules        SmartPricingRule[]
  stocks              Stock[]
  movements           StockMovement[]

  @@unique([code, branch, companyId])
  @@index([name])
  @@index([barcode])
  @@index([code])
  @@index([category])
  @@index([parentId])
  @@index([companyId])
  @@index([companyId, deletedAt, category])
  @@index([companyId, isParent, deletedAt])
}

model VariantAttribute {
  id        String                  @id @default(cuid())
  companyId String?
  name      String
  branch    String?                 @default("Merkez")
  values    VariantAttributeValue[]

  @@unique([name, branch, companyId])
}

model VariantAttributeValue {
  id          String                @id @default(cuid())
  attributeId String
  value       String
  products    ProductVariantValue[]
  attribute   VariantAttribute      @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@index([attributeId])
}

model ProductVariantValue {
  productId        String
  attributeValueId String
  attributeValue   VariantAttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)
  product          Product               @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, attributeValueId])
}

model StockMovement {
  id             String   @id @default(cuid())
  productId      String
  branch         String
  quantity       Int
  price          Decimal  @db.Decimal(10, 2)
  type           String
  referenceId    String?
  createdAt      DateTime @default(now())
  companyId      String?
  idempotencyKey String?  @unique
  company        Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([branch])
  @@index([createdAt])
  @@index([companyId])
  @@index([companyId, createdAt, type])
}

model Stock {
  id        String   @id @default(cuid())
  productId String
  branch    String
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, branch])
  @@index([branch])
}

model MarketplaceProductMap {
  id              String   @id @default(cuid())
  marketplace     String
  marketplaceCode String
  productId       String
  createdAt       DateTime @default(now())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, marketplace, marketplaceCode])
  @@index([productId])
  @@index([companyId])
}

model Supplier {
  id            String            @id @default(cuid())
  name          String
  phone         String?
  email         String?
  address       String?
  category      String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal           @default(0) @db.Decimal(12, 2)
  branch        String?           @default("Merkez")
  isActive      Boolean           @default(true)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  city          String?
  companyId     String
  district      String?
  checks        Check[]
  invoices      PurchaseInvoice[]
  company       Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([name])
  @@index([taxNumber])
  @@index([phone])
  @@index([companyId])
}

model PurchaseInvoice {
  id          String    @id @default(cuid())
  invoiceNo   String
  invoiceDate DateTime
  dueDate     DateTime?
  amount      Decimal   @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  description String?
  supplierId  String
  items       Json?
  status      String    @default("Bekliyor")
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier    Supplier  @relation(fields: [supplierId], references: [id])

  @@index([invoiceNo])
  @@index([invoiceDate])
  @@index([supplierId])
  @@index([status])
  @@index([companyId])
}

model SalesInvoice {
  id           String    @id @default(cuid())
  invoiceNo    String    @unique
  invoiceDate  DateTime  @default(now())
  amount       Decimal   @db.Decimal(10, 2)
  taxAmount    Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount  Decimal   @db.Decimal(10, 2)
  description  String?
  customerId   String
  items        Json
  status       String    @default("Taslak")
  isFormal     Boolean   @default(false)
  branch       String?   @default("Merkez")
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  companyId    String
  formalId     String?   @unique
  formalStatus String?
  formalType   String?
  formalUuid   String?   @unique
  orderId      String?
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([invoiceDate])
  @@index([invoiceNo])
  @@index([status])
  @@index([companyId])
  @@index([orderId])
  @@index([companyId, invoiceDate, status])
}

model Customer {
  id                 String                    @id @default(cuid())
  name               String
  email              String?
  phone              String?
  address            String?
  taxNumber          String?
  taxOffice          String?
  contactPerson      String?
  iban               String?
  balance            Decimal                   @default(0) @db.Decimal(12, 2)
  points             Decimal                   @default(0) @db.Decimal(10, 2)
  branch             String?                   @default("Merkez")
  categoryId         String?
  supplierClass      String?
  customerClass      String?
  deletedAt          DateTime?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  referralCode       String?                   @unique
  city               String?
  companyId          String
  district           String?
  isPortalActive     Boolean                   @default(false)
  lastPortalLogin    DateTime?
  portalPassword     String?
  assignedStaffId    String?
  lat                Float?
  lng                Float?
  locationPinnedAt   DateTime?
  checks             Check[]
  coupons            Coupon[]
  assignedStaff      Staff?                    @relation("StaffCustomers", fields: [assignedStaffId], references: [id])
  category           CustomerCategory?         @relation(fields: [categoryId], references: [id])
  company            Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents          CustomerDocument[]
  locationRequests   CustomerLocationRequest[]
  quotes             Quote[]
  routeStops         RouteStop[]
  routeTemplateStops RouteTemplateStop[]
  invoices           SalesInvoice[]
  salesOrders        SalesOrder[]
  visits             SalesVisit[]
  services           ServiceRecord[]
  transactions       Transaction[]
  warranties         Warranty[]

  @@unique([email, companyId])
  @@index([name])
  @@index([phone])
  @@index([email])
  @@index([taxNumber])
  @@index([companyId])
}

model ServiceRecord {
  id            String    @id @default(cuid())
  customerId    String
  plate         String?
  km            Int?
  nextKm        Int?
  nextDate      DateTime?
  vehicleBrand  String?
  vehicleSerial String?
  notes         String?
  status        String    @default("Tamamlandı")
  totalAmount   Decimal   @db.Decimal(10, 2)
  items         Json
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer      Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([plate])
  @@index([nextDate])
  @@index([status])
  @@index([companyId])
}

model CustomerDocument {
  id         String   @id @default(cuid())
  customerId String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model CustomerCategory {
  id          String     @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  isDefault   Boolean    @default(false)
  priceListId String?
  companyId   String
  customers   Customer[]
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  priceList   PriceList? @relation(fields: [priceListId], references: [id])

  @@unique([companyId, name])
  @@index([companyId])
  @@index([priceListId])
}

model PriceList {
  id            String             @id @default(cuid())
  companyId     String
  name          String
  description   String?
  currency      String             @default("TRY")
  isDefault     Boolean            @default(false)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  categories    CustomerCategory[]
  company       Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  productPrices ProductPrice[]

  @@unique([companyId, name])
  @@index([companyId])
}

model ProductPrice {
  id                String    @id @default(cuid())
  productId         String
  priceListId       String
  price             Decimal   @db.Decimal(12, 2)
  isManualOverride  Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  companyId         String
  derivedFromListId String?
  formulaMarkupBps  Int?
  priceList         PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, priceListId], name: "companyId_productId_priceListId")
  @@index([productId])
  @@index([priceListId])
  @@index([companyId])
}

model Kasa {
  id               String          @id @default(cuid())
  name             String
  type             String          @default("Nakit")
  balance          Decimal         @default(0) @db.Decimal(12, 2)
  currency         String          @default("TRY")
  isActive         Boolean         @default(true)
  deletedAt        DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  branch           String?         @default("Merkez")
  companyId        String
  bankConnectionId String?         @unique
  iban             String?
  bankConnection   BankConnection? @relation(fields: [bankConnectionId], references: [id])
  company          Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions     Transaction[]

  @@unique([name, branch, companyId])
  @@index([companyId])
}

model Transaction {
  id           String      @id @default(cuid())
  type         String
  amount       Decimal     @db.Decimal(12, 2)
  description  String?
  date         DateTime    @default(now())
  kasaId       String?
  targetKasaId String?
  customerId   String?
  supplierId   String?
  deletedAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  branch       String?     @default("Merkez")
  companyId    String
  visitId      String?
  company      Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer?   @relation(fields: [customerId], references: [id])
  kasa         Kasa?       @relation(fields: [kasaId], references: [id])
  supplier     Supplier?   @relation(fields: [supplierId], references: [id])
  visit        SalesVisit? @relation(fields: [visitId], references: [id])

  @@index([customerId])
  @@index([supplierId])
  @@index([date])
  @@index([type])
  @@index([kasaId])
  @@index([branch])
  @@index([companyId])
  @@index([createdAt])
}

model Check {
  id          String    @id @default(cuid())
  type        String
  number      String
  bank        String?
  dueDate     DateTime
  amount      Decimal   @db.Decimal(12, 2)
  status      String    @default("Beklemede")
  description String?
  customerId  String?
  supplierId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  branch      String?   @default("Merkez")
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer? @relation(fields: [customerId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  @@index([dueDate])
  @@index([status])
  @@index([number])
  @@index([branch])
  @@index([companyId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userName  String?
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  branch    String?
  createdAt DateTime @default(now())
  after     Json?
  before    Json?
  tenantId  String?
  userAgent String?

  @@index([action, entity])
  @@index([entityId])
  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
  @@index([tenantId, entity, createdAt])
  @@index([tenantId, action, createdAt])
}

model LoginAttempt {
  id        String   @id @default(cuid())
  ip        String
  username  String
  success   Boolean
  createdAt DateTime @default(now())

  @@index([ip, createdAt])
  @@index([username, createdAt])
}

model Branch {
  id        Int              @id @default(autoincrement())
  name      String
  type      String           @default("Şube")
  city      String?
  address   String?
  phone     String?
  manager   String?
  status    String           @default("Aktif")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  deletedAt DateTime?
  companyId String
  district  String?
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents BranchDocument[]

  @@unique([companyId, name])
}

model BranchDocument {
  id         String   @id @default(cuid())
  branchId   Int
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
}

model SuspendedSale {
  id        String   @id @default(cuid())
  label     String
  items     Json
  customer  Json?
  total     Decimal  @db.Decimal(12, 2)
  branch    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Staff {
  id                  String                    @id @default(cuid())
  username            String                    @unique
  password            String?
  email               String?
  name                String
  role                String?
  branch              String?                   @default("Merkez")
  type                String?                   @default("service")
  status              String?                   @default("Boşta")
  currentJob          String?
  permissions         String[]                  @default([])
  performance         Int?                      @default(100)
  lastActive          DateTime?                 @default(now())
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  deletedAt           DateTime?
  salary              Decimal?                  @default(17002) @db.Decimal(10, 2)
  address             String?
  companyId           String?
  phone               String?
  tenantId            String?                   @default("PLATFORM_ADMIN")
  assignedCategoryIds String[]                  @default([])
  birthDate           DateTime?
  bloodType           String?
  certificate         String?
  city                String?
  dailyWorkingHours   Float?                    @default(8)
  district            String?
  educationLevel      String?
  hasDriverLicense    Boolean?                  @default(false)
  healthReport        String?
  maritalStatus       String?
  militaryStatus      String?
  notes               String?
  reference           String?
  relativeName        String?
  relativePhone       String?
  shiftTemplate       String?
  weeklyOffDays       String?                   @default("Sunday")
  workType            String?                   @default("FULL_TIME")
  attendance          Attendance[]
  assignedCustomers   Customer[]                @relation("StaffCustomers")
  locationRequests    CustomerLocationRequest[]
  expenses            Expense[]                 @relation("StaffExpenses")
  leaveRequests       LeaveRequest[]
  receivedMessages    Message[]                 @relation("ReceivedMessages")
  sentMessages        Message[]                 @relation("SentMessages")
  storeOrders         Order[]                   @relation("StaffStoreOrders")
  payrolls            Payroll[]
  routes              Route[]
  salesOrders         SalesOrder[]
  visits              SalesVisit[]
  shifts              Shift[]
  company             Company?                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents           StaffDocument[]
  targets             StaffTarget[]

  @@index([tenantId])
  @@index([companyId])
  @@index([username])
}

model Message {
  id         String   @id @default(cuid())
  content    String
  senderId   String
  receiverId String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiver   Staff?   @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     Staff    @relation("SentMessages", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([receiverId])
}

model StaffDocument {
  id         String   @id @default(cuid())
  staffId    String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
}

model Shift {
  id        String   @id @default(cuid())
  staffId   String
  start     DateTime
  end       DateTime
  type      String   @default("Normal")
  branch    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([start])
}

model LeaveRequest {
  id         String   @id @default(cuid())
  staffId    String
  type       String
  startDate  DateTime
  endDate    DateTime
  days       Int
  reason     String?
  status     String   @default("Bekliyor")
  approvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([status])
}

model Attendance {
  id           String    @id @default(cuid())
  staffId      String
  date         DateTime  @default(now())
  checkIn      DateTime
  checkOut     DateTime?
  locationIn   String?
  locationOut  String?
  deviceInfo   String?
  status       String    @default("ON_TIME")
  workingHours Float?    @default(0)
  isPuantajOk  Boolean   @default(false)
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  staff        Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([date])
}

model Payroll {
  id         String    @id @default(cuid())
  staffId    String
  period     String
  salary     Decimal   @db.Decimal(10, 2)
  bonus      Decimal   @default(0) @db.Decimal(10, 2)
  deductions Decimal   @default(0) @db.Decimal(10, 2)
  netPay     Decimal   @db.Decimal(10, 2)
  status     String    @default("Bekliyor")
  paidAt     DateTime?
  note       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  staff      Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, period])
  @@index([period])
}

model Notification {
  id        String   @id @default(cuid())
  type      String   @default("INFO")
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  link      String?
  message   String
  title     String
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}

model PendingProduct {
  id          String   @id @default(cuid())
  productData Json
  requestedBy String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PendingTransfer {
  id           String   @id @default(cuid())
  transferData Json
  requestedBy  String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model StockTransfer {
  id          String    @id @default(cuid())
  productId   String
  productName String
  productCode String
  qty         Int
  fromBranch  String
  toBranch    String
  status      String    @default("IN_TRANSIT")
  requestedBy String?
  shippedAt   DateTime  @default(now())
  receivedAt  DateTime?
  receivedBy  String?
  trackingNo  String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyId   String?
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([companyId])
  @@index([fromBranch])
  @@index([toBranch])
}

model InventoryAudit {
  id         String    @id @default(cuid())
  branch     String
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  status     String    @default("in_progress")
  items      Json
  reportedBy String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model AppSettings {
  id        String   @id @default(cuid())
  key       String
  value     Json
  updatedAt DateTime @updatedAt
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, key])
  @@index([companyId])
}

model Warranty {
  id          String   @id @default(cuid())
  customerId  String
  productName String
  serialNo    String
  startDate   DateTime
  endDate     DateTime
  period      String
  status      String   @default("Active")
  invoiceNo   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([serialNo])
}

model SecurityEvent {
  id                String   @id @default(cuid())
  timestamp         DateTime @default(now())
  detectedPhrase    String
  confidence        Float
  hasSaleInLast5Min Boolean
  branch            String?
  staff             String?
  details           String?
  createdAt         DateTime @default(now())
  companyId         String?
  company           Company? @relation("CompanySecurityEvents", fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([timestamp])
  @@index([branch])
}

model Campaign {
  id                        String    @id @default(cuid())
  name                      String
  type                      String
  description               String?
  conditions                Json
  discountRate              Float?
  pointsRate                Float?
  startDate                 DateTime  @default(now())
  endDate                   DateTime?
  isActive                  Boolean   @default(true)
  deletedAt                 DateTime?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  companyId                 String?
  targetCustomerCategoryIds String[]  @default([])
  company                   Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([isActive])
}

model Coupon {
  id                 String    @id @default(cuid())
  code               String    @unique
  type               String
  value              Float
  minPurchaseAmount  Decimal   @default(0) @db.Decimal(10, 2)
  customerCategoryId String?
  customerId         String?
  expiryDate         DateTime?
  isUsed             Boolean   @default(false)
  usedAt             DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  campaignName       String?
  conditions         Json?
  startDate          DateTime  @default(now())
  usageLimit         Int       @default(1)
  usedCount          Int       @default(0)
  companyId          String?
  company            Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer           Customer? @relation(fields: [customerId], references: [id])

  @@index([code])
  @@index([customerId])
  @@index([isUsed])
  @@index([companyId])
}

model PaymentPlan {
  id               String        @id @default(cuid())
  title            String
  totalAmount      Decimal       @db.Decimal(12, 2)
  installmentCount Int
  startDate        DateTime
  description      String?
  type             String        @default("Kredi")
  status           String        @default("Active")
  branch           String?       @default("Merkez")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  customerId       String?
  direction        String        @default("OUT")
  supplierId       String?
  companyId        String?
  installments     Installment[]
  company          Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Installment {
  id            String      @id @default(cuid())
  paymentPlanId String
  installmentNo Int
  dueDate       DateTime
  amount        Decimal     @db.Decimal(12, 2)
  status        String      @default("Pending")
  paidAt        DateTime?
  transactionId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  paymentPlan   PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([status])
}

model Account {
  id            String        @id @default(cuid())
  code          String
  name          String
  parentCode    String?
  accountClass  String?
  normalBalance String?
  reportGroup   String?
  reportType    String?
  type          String
  balance       Decimal       @default(0) @db.Decimal(15, 2)
  isActive      Boolean       @default(true)
  kasaId        String?       @unique
  bankId        String?       @unique
  customerId    String?
  supplierId    String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  branch        String?       @default("Merkez")
  companyId     String?
  company       Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalItems  JournalItem[]

  @@unique([code, branch, companyId])
  @@index([code])
  @@index([parentCode])
  @@index([companyId])
}

model Journal {
  id          String        @id @default(cuid())
  date        DateTime      @default(now())
  fisNo       String
  description String?
  type        String        @default("Mahsup")
  totalDebt   Decimal       @db.Decimal(15, 2)
  totalCredit Decimal       @db.Decimal(15, 2)
  isBalanced  Boolean
  status      String        @default("Draft")
  branch      String?       @default("Merkez")
  sourceType  String?
  sourceId    String?
  isReversal  Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  companyId   String?
  company     Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items       JournalItem[]

  @@unique([fisNo, companyId, branch])
  @@index([date])
  @@index([fisNo])
  @@index([branch])
  @@index([companyId])
}

model JournalItem {
  id            String    @id @default(cuid())
  journalId     String
  accountId     String
  description   String?
  debt          Decimal   @default(0) @db.Decimal(15, 2)
  credit        Decimal   @default(0) @db.Decimal(15, 2)
  documentType  String?
  documentNo    String?
  documentDate  DateTime?
  paymentMethod String?
  createdAt     DateTime  @default(now())
  account       Account   @relation(fields: [accountId], references: [id])
  journal       Journal   @relation(fields: [journalId], references: [id], onDelete: Cascade)

  @@index([journalId])
  @@index([accountId])
}

model Quote {
  id          String    @id @default(cuid())
  quoteNo     String    @unique
  date        DateTime  @default(now())
  validUntil  DateTime?
  customerId  String
  items       Json
  subTotal    Decimal   @default(0) @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @default(0) @db.Decimal(10, 2)
  status      String    @default("Draft")
  description String?
  branch      String?   @default("Merkez")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyId   String?
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([quoteNo])
  @@index([status])
  @@index([companyId])
}

model MarketplaceConfig {
  id        String    @id @default(cuid())
  type      String
  settings  Json
  isActive  Boolean   @default(false)
  lastSync  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  companyId String
  deletedAt DateTime?
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, type])
  @@index([companyId])
  @@index([deletedAt])
}

model ExternalRequest {
  id              String   @id @default(cuid())
  provider        String
  idempotencyKey  String
  entityType      String
  entityId        String
  status          String
  responsePayload Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  companyId       String?
  company         Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([provider, idempotencyKey])
  @@index([entityId])
  @@index([status])
  @@index([companyId])
}

model GrowthEvent {
  id        String   @id @default(cuid())
  tenantId  String
  type      String
  status    String   @default("PENDING")
  payload   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([status])
}

model UpsellEvent {
  id           String   @id @default(cuid())
  tenantId     String
  type         String
  source       String
  targetPlanId String?
  converted    Boolean  @default(false)
  payload      Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([converted])
}

model CmsPage {
  id          String       @id @default(cuid())
  slug        String       @unique
  title       String
  description String?
  keywords    String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  sections    CmsSection[]
}

model CmsSection {
  id       String  @id @default(cuid())
  pageId   String
  type     String
  order    Int     @default(0)
  content  Json
  isActive Boolean @default(true)
  page     CmsPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
}

model CmsMenu {
  id        String   @id @default(cuid())
  name      String
  items     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CmsGeneralSettings {
  id             String   @id @default(cuid())
  logoUrl        String?
  faviconUrl     String?
  siteTitle      String   @default("Periodya")
  footerText     String?
  primaryColor   String   @default("#446ee7")
  contactEmail   String?
  whatsappNumber String?
  customCss      String?
  updatedAt      DateTime @updatedAt
}

model RouteTemplate {
  id        String              @id @default(cuid())
  companyId String
  name      String
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  company   Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stops     RouteTemplateStop[]

  @@index([companyId])
}

model RouteTemplateStop {
  id         String        @id @default(cuid())
  templateId String
  customerId String
  sequence   Int
  customer   Customer      @relation(fields: [customerId], references: [id])
  template   RouteTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([customerId])
}

model Route {
  id        String      @id @default(cuid())
  companyId String
  staffId   String
  name      String
  date      DateTime
  status    String      @default("PENDING")
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff     Staff       @relation(fields: [staffId], references: [id], onDelete: Cascade)
  stops     RouteStop[]

  @@index([companyId])
  @@index([staffId])
  @@index([date])
}

model RouteStop {
  id          String       @id @default(cuid())
  routeId     String
  customerId  String
  sequence    Int
  status      String       @default("PENDING")
  plannedTime DateTime?
  customer    Customer     @relation(fields: [customerId], references: [id])
  route       Route        @relation(fields: [routeId], references: [id], onDelete: Cascade)
  visits      SalesVisit[]

  @@index([routeId])
  @@index([customerId])
}

model SalesVisit {
  id               String        @id @default(cuid())
  companyId        String
  routeStopId      String?
  customerId       String
  staffId          String
  checkInTime      DateTime      @default(now())
  checkOutTime     DateTime?
  checkInLocation  Json?
  checkOutLocation Json?
  notes            String?
  photos           String[]
  isOutOfRange     Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  result           String?
  orders           SalesOrder[]
  company          Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer         Customer      @relation(fields: [customerId], references: [id])
  stop             RouteStop?    @relation(fields: [routeStopId], references: [id])
  staff            Staff         @relation(fields: [staffId], references: [id])
  transactions     Transaction[]

  @@index([companyId])
  @@index([staffId])
  @@index([customerId])
  @@index([checkInTime])
}

model SalesOrder {
  id          String           @id @default(cuid())
  companyId   String
  visitId     String?
  customerId  String
  staffId     String
  totalAmount Decimal          @db.Decimal(10, 2)
  status      String           @default("PENDING")
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer         @relation(fields: [customerId], references: [id])
  staff       Staff            @relation(fields: [staffId], references: [id])
  visit       SalesVisit?      @relation(fields: [visitId], references: [id])
  items       SalesOrderItem[]

  @@index([companyId])
  @@index([visitId])
  @@index([customerId])
}

model SalesOrderItem {
  id          String     @id @default(cuid())
  orderId     String
  productId   String
  productName String
  quantity    Int
  unitPrice   Decimal    @db.Decimal(10, 2)
  totalPrice  Decimal    @db.Decimal(10, 2)
  order       SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product    @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model StaffTarget {
  id             String   @id @default(cuid())
  staffId        String
  companyId      String
  type           String
  targetValue    Decimal  @db.Decimal(12, 2)
  currentValue   Decimal  @default(0) @db.Decimal(12, 2)
  period         String
  month          Int?
  year           Int?
  startDate      DateTime
  endDate        DateTime
  status         String   @default("ACTIVE")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  bonusAmount    Decimal? @default(0) @db.Decimal(12, 2)
  commissionRate Decimal? @default(0) @db.Decimal(5, 2)
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff          Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model DomainEvent {
  id            String   @id @default(cuid())
  companyId     String
  tenantId      String?
  eventType     String
  aggregateType String
  aggregateId   String
  payload       Json
  metadata      Json?
  createdAt     DateTime @default(now())
  createdBy     String?
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, aggregateType, createdAt])
  @@index([aggregateId])
}

model InventoryLayer {
  id                String                 @id @default(cuid())
  companyId         String
  productId         String
  sourceEventId     String
  quantityInitial   Decimal                @db.Decimal(15, 4)
  quantityRemaining Decimal                @db.Decimal(15, 4)
  unitCost          Decimal                @db.Decimal(15, 4)
  branch            String?                @default("Merkez")
  createdAt         DateTime               @default(now())
  consumptions      InventoryConsumption[]
  company           Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([productId, quantityRemaining, createdAt])
  @@index([companyId])
}

model InventoryConsumption {
  id                 String         @id @default(cuid())
  companyId          String
  layerId            String
  consumptionEventId String
  quantity           Decimal        @db.Decimal(15, 4)
  unitCostAtTime     Decimal        @db.Decimal(15, 4)
  createdAt          DateTime       @default(now())
  layer              InventoryLayer @relation(fields: [layerId], references: [id])

  @@index([layerId])
  @@index([consumptionEventId])
}

model JournalEntry {
  id            String        @id @default(cuid())
  entryNumber   Int           @unique @default(autoincrement())
  companyId     String
  sourceEventId String?       @unique
  description   String
  date          DateTime      @default(now())
  createdAt     DateTime      @default(now())
  createdBy     String?
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines         JournalLine[]

  @@index([companyId, date])
}

model JournalLine {
  id                String       @id @default(cuid())
  journalEntryId    String
  accountCode       String
  debit             Decimal      @default(0) @db.Decimal(15, 2)
  credit            Decimal      @default(0) @db.Decimal(15, 2)
  externalReference String?
  companyId         String
  isOpen            Boolean      @default(true)
  journalEntry      JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@index([accountCode, companyId, isOpen])
}

model MarketplaceOrderFinance {
  id                String    @id @default(cuid())
  companyId         String
  orderId           String    @unique
  orderNumber       String
  marketplace       String
  commissionRate    Decimal   @db.Decimal(5, 2)
  commissionAmount  Decimal   @db.Decimal(15, 2)
  shippingFee       Decimal   @db.Decimal(15, 2)
  otherFees         Decimal   @db.Decimal(15, 2)
  netProfit         Decimal   @db.Decimal(15, 2)
  receivableBalance Decimal   @db.Decimal(15, 2)
  isSettled         Boolean   @default(false)
  currency          String    @default("TRY")
  lastMatchedAt     DateTime?
  createdAt         DateTime  @default(now())
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, marketplace])
}

model MarketplaceSettlement {
  id                String    @id @default(cuid())
  companyId         String
  marketplace       String
  settlementId      String    @unique
  periodStart       DateTime
  periodEnd         DateTime
  totalAmount       Decimal   @db.Decimal(15, 2)
  commissionTotal   Decimal   @db.Decimal(15, 2)
  payoutAmount      Decimal   @db.Decimal(15, 2)
  status            String    @default("PENDING")
  externalReference String?
  journalEntryId    String?
  reconciledAt      DateTime?
  createdAt         DateTime  @default(now())
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, marketplace, status])
}

model MarketplaceTransactionLedger {
  id                     String         @id @default(cuid())
  companyId              String
  marketplace            String
  externalReference      String         @unique
  orderId                String?
  orderNumber            String?
  transactionType        String
  amount                 Decimal        @db.Decimal(15, 2)
  transactionDate        DateTime
  processingStatus       String         @default("PENDING")
  reconciliationStatus   String?
  journalEntryId         String?
  matchedBankStatementId String?
  createdAt              DateTime       @default(now())
  company                Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bankStatement          BankStatement? @relation(fields: [matchedBankStatementId], references: [id])

  @@index([companyId, marketplace, processingStatus])
  @@index([externalReference])
}

model BankStatement {
  id               String                         @id @default(cuid())
  companyId        String
  bankAccountCode  String
  statementDate    DateTime
  referenceNo      String                         @unique
  description      String
  debit            Decimal                        @db.Decimal(15, 2)
  credit           Decimal                        @db.Decimal(15, 2)
  balance          Decimal?                       @db.Decimal(15, 2)
  isMatched        Boolean                        @default(false)
  matchedJournalId String?
  createdAt        DateTime                       @default(now())
  company          Company                        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transLedgers     MarketplaceTransactionLedger[]

  @@index([companyId, statementDate])
  @@index([referenceNo])
}

model MarketplaceProductPnl {
  id               String   @id @default(cuid())
  companyId        String
  productId        String
  marketplace      String
  grossRevenue     Decimal  @default(0) @db.Decimal(15, 2)
  commissionTotal  Decimal  @default(0) @db.Decimal(15, 2)
  shippingTotal    Decimal  @default(0) @db.Decimal(15, 2)
  otherFeesTotal   Decimal  @default(0) @db.Decimal(15, 2)
  fifoCostTotal    Decimal  @default(0) @db.Decimal(15, 2)
  refundCostTotal  Decimal  @default(0) @db.Decimal(15, 2)
  netProfit        Decimal  @default(0) @db.Decimal(15, 2)
  profitMargin     Decimal  @default(0) @db.Decimal(5, 2)
  saleCount        Int      @default(0)
  refundCount      Int      @default(0)
  lastUpdatedAt    DateTime @updatedAt
  refundedQuantity Int      @default(0)
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, marketplace])
  @@index([companyId, marketplace])
}

model SmartPricingRule {
  id           String   @id @default(cuid())
  companyId    String
  productId    String
  marketplace  String
  targetMargin Decimal  @db.Decimal(5, 2)
  minPrice     Decimal  @db.Decimal(15, 2)
  maxPrice     Decimal  @db.Decimal(15, 2)
  isActive     Boolean  @default(true)
  lastUpdated  DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, marketplace])
}

model BankConnection {
  id                   String               @id @default(cuid())
  companyId            String
  bankName             String
  iban                 String               @unique
  currency             String               @default("TRY")
  lastSyncAt           DateTime?
  status               String               @default("DRAFT")
  createdAt            DateTime             @default(now())
  bankId               String?
  connectionType       String               @default("OPEN_BANKING")
  consecutiveFailures  Int                  @default(0)
  credentialsEncrypted Json?
  credentialsVersion   Int                  @default(1)
  integrationMethod    String               @default("MANUAL_UPLOAD")
  lastErrorAt          DateTime?
  lastErrorCode        String?
  lastErrorMessage     String?
  nextRetryAt          DateTime?
  updatedAt            DateTime             @updatedAt
  balances             BankAccountBalance[]
  company              Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions         BankTransaction[]
  kasalar              Kasa?

  @@index([companyId])
  @@index([companyId, bankId])
}

model BankAccountBalance {
  id               String         @id @default(cuid())
  bankConnectionId String
  balance          Decimal        @db.Decimal(15, 2)
  currency         String
  asOf             DateTime
  createdAt        DateTime       @default(now())
  connection       BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
}

model BankTransaction {
  id                     String         @id @default(cuid())
  companyId              String
  bankConnectionId       String
  transactionId          String
  amount                 Decimal        @db.Decimal(14, 2)
  currency               String
  description            String?
  transactionDate        DateTime
  valueDate              DateTime?
  direction              String
  rawPayload             Json
  createdAt              DateTime       @default(now())
  bankRef                String?
  transactionFingerprint String
  connection             BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
  company                Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  matches                PaymentMatch[]

  @@unique([bankConnectionId, transactionFingerprint])
  @@index([companyId, transactionDate])
}

model PricingAutopilotConfig {
  id                    String   @id @default(cuid())
  companyId             String
  marketplace           String
  enabled               Boolean  @default(false)
  minMargin             Decimal  @db.Decimal(5, 2)
  maxDailyChangePct     Decimal  @db.Decimal(5, 2)
  pauseOnNegativeStock  Boolean  @default(true)
  pauseOnHighReturnRate Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, marketplace])
}

model PaymentMatch {
  id                String          @id @default(cuid())
  companyId         String
  bankTransactionId String
  ledgerId          String?
  matchType         String
  confidenceScore   Int             @default(100)
  confidenceBucket  String          @default("HIGH")
  status            String          @default("PENDING")
  journalEntryId    String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  bankTransaction   BankTransaction @relation(fields: [bankTransactionId], references: [id], onDelete: Cascade)
  company           Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
}

model MatchingRule {
  id          String   @id @default(cuid())
  companyId   String
  pattern     String
  targetType  String
  entityName  String?
  accountCode String?
  confidence  Int      @default(100)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, pattern])
}

model CashflowForecast {
  id           String   @id @default(cuid())
  companyId    String
  horizonDays  Int
  expectedIn   Decimal  @db.Decimal(15, 2)
  expectedOut  Decimal  @db.Decimal(15, 2)
  netPosition  Decimal  @db.Decimal(15, 2)
  calculatedAt DateTime @default(now())
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, calculatedAt])
}

model FintechAudit {
  id            String   @id @default(cuid())
  companyId     String
  who           String
  action        String
  details       String?
  before        Json?
  after         Json?
  sourceEventId String?
  createdAt     DateTime @default(now())
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, action])
  @@index([createdAt])
}

model MarketplaceActionAudit {
  id              String    @id @default(cuid())
  companyId       String
  marketplace     String
  orderId         String?
  actionKey       String
  idempotencyKey  String    @unique
  status          String
  requestPayload  Json?
  responsePayload Json?
  errorMessage    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  jobId           String?
  lockExpiresAt   DateTime?
  failureHistory  Json?
  retryCount      Int       @default(0)

  @@index([companyId, marketplace, createdAt])
  @@index([orderId])
}

model MarketplaceLabel {
  id                String   @id @default(cuid())
  companyId         String
  marketplace       String
  shipmentPackageId String
  storageKey        String
  sha256            String
  size              Int
  contentType       String   @default("application/pdf")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([companyId, marketplace, shipmentPackageId])
  @@index([companyId, createdAt])
}

model PdksDisplay {
  id              String    @id @default(cuid())
  tenantId        String
  siteId          String
  name            String
  isActive        Boolean   @default(true)
  pairingCode     String    @unique
  lastPublicIp    String?
  lastHeartbeatAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  announcement    String?

  @@index([tenantId, siteId])
}

model PdksEmployeeDevice {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  deviceFp    String
  isActive    Boolean  @default(true)
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @updatedAt

  @@unique([tenantId, userId, deviceFp])
  @@index([tenantId, userId])
}

model PdksEvent {
  id              String     @id @default(cuid())
  tenantId        String
  userId          String
  siteId          String?
  type            PdksType
  mode            PdksMode
  status          PdksStatus @default(APPROVED)
  deviceFp        String
  requestPublicIp String?
  displayPublicIp String?
  lat             Float?
  lng             Float?
  accuracy        Float?
  clientTime      DateTime
  serverTime      DateTime   @default(now())
  riskScore       Int        @default(0)
  riskFlags       Json?
  offlineId       String?    @unique
  notes           String?

  @@index([tenantId, userId])
  @@index([tenantId, serverTime])
  @@index([siteId])
}

model PdksIdempotency {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  offlineId String   @unique
  eventId   String?
  createdAt DateTime @default(now())

  @@index([tenantId, userId, offlineId])
}

model Expense {
  id          String   @id @default(cuid())
  type        String
  amount      Decimal  @db.Decimal(12, 2)
  description String?
  date        DateTime @default(now())
  receiptUrl  String?
  status      String   @default("Beklemede")
  staffId     String
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff       Staff    @relation("StaffExpenses", fields: [staffId], references: [id])

  @@index([staffId])
  @@index([companyId])
  @@index([date])
}

model HelpCategory {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  order       Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  topics      HelpTopic[]
}

model HelpTopic {
  id         String       @id @default(cuid())
  categoryId String
  title      String
  slug       String       @unique
  excerpt    String?
  body       String
  status     TopicStatus  @default(DRAFT)
  order      Int          @default(0)
  tenantId   String?
  upvotes    Int          @default(0)
  downvotes  Int          @default(0)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  category   HelpCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
}

model CustomerLocationRequest {
  id           String   @id @default(cuid())
  customerId   String
  staffId      String
  companyId    String
  requestedLat Float
  requestedLng Float
  status       String   @default("PENDING")
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  staff        Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
}

model NetworkPayment {
  id                 String          @id @default(cuid())
  networkOrderId     String
  provider           PaymentProvider
  mode               PaymentMode
  status             PaymentStatus   @default(INITIATED)
  amount             Decimal         @db.Decimal(12, 2)
  currency           String          @default("TRY")
  providerPaymentId  String?
  providerPaymentKey String?         @unique
  attemptKey         String?         @unique
  checkoutUrl        String?
  rawInit            Json?
  payoutStatus       String          @default("INITIATED")
  releasedAt         DateTime?
  releaseAttemptKey  String?         @unique
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  order              NetworkOrder    @relation(fields: [networkOrderId], references: [id], onDelete: Cascade)

  @@index([networkOrderId])
  @@index([networkOrderId, status])
  @@index([status])
}

model PaymentEventInbox {
  id                String             @id @default(cuid())
  provider          PaymentProvider
  providerEventId   String             @unique
  providerPaymentId String?
  networkPaymentId  String?
  raw               Json
  receivedAt        DateTime           @default(now())
  processedAt       DateTime?
  status            PaymentEventStatus @default(RECEIVED)
  errorMessage      String?

  @@index([providerPaymentId])
  @@index([networkPaymentId])
  @@index([receivedAt])
  @@index([provider])
}

model NetworkOrder {
  id                 String              @id @default(cuid())
  buyerCompanyId     String
  sellerCompanyId    String
  subtotalAmount     Decimal             @db.Decimal(12, 2)
  shippingAmount     Decimal             @db.Decimal(12, 2)
  commissionAmount   Decimal             @db.Decimal(12, 2)
  totalAmount        Decimal             @db.Decimal(12, 2)
  currency           String              @default("TRY")
  status             String
  paidAt             DateTime?
  confirmedAt        DateTime?
  completedAt        DateTime?
  completionKey      String?             @unique
  disputeOpenedAt    DateTime?
  itemsHash          String
  items              Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  commissionSnapshot CommissionSnapshot?
  networkItems       NetworkOrderItem[]
  payments           NetworkPayment[]
  shipments          Shipment[]
}

model NetworkOrderItem {
  id               String          @id @default(cuid())
  networkOrderId   String
  listingId        String?
  globalProductId  String
  erpProductId     String
  name             String
  price            Decimal         @db.Decimal(10, 2)
  qty              Int
  total            Decimal         @db.Decimal(12, 2)
  isContractPriced Boolean         @default(false)
  createdAt        DateTime        @default(now())
  listing          NetworkListing? @relation(fields: [listingId], references: [id])
  order            NetworkOrder    @relation(fields: [networkOrderId], references: [id], onDelete: Cascade)

  @@index([networkOrderId])
  @@index([listingId])
}

model SellerBalanceLedger {
  id              String     @id @default(cuid())
  sellerCompanyId String
  networkOrderId  String
  amount          Decimal    @db.Decimal(12, 2)
  currency        String     @default("TRY")
  type            LedgerType
  idempotencyKey  String     @unique
  createdAt       DateTime   @default(now())

  @@index([sellerCompanyId])
  @@index([networkOrderId])
}

model PlatformCommissionLedger {
  id             String   @id @default(cuid())
  networkOrderId String
  amount         Decimal  @db.Decimal(12, 2)
  currency       String   @default("TRY")
  idempotencyKey String   @unique
  createdAt      DateTime @default(now())

  @@index([networkOrderId])
}

model PayoutEventInbox {
  id              String             @id @default(cuid())
  provider        PaymentProvider
  providerEventId String             @unique
  raw             Json
  status          PaymentEventStatus @default(RECEIVED)
  createdAt       DateTime           @default(now())
  processedAt     DateTime?

  @@index([provider])
}

model Shipment {
  id                 String                   @id @default(cuid())
  networkOrderId     String
  mode               ShipmentMode
  status             ShipmentStatus           @default(CREATED)
  carrierCode        String
  trackingNumber     String?
  normalizedTracking String?
  labelUrl           String?
  sequence           Int                      @default(1)
  initKey            String?                  @unique
  deliveryNoteUuid   String?
  deliveryNoteStatus String?
  items              Json?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  sellerEarning      SellerEarning?
  order              NetworkOrder             @relation(fields: [networkOrderId], references: [id], onDelete: Cascade)
  allocations        ShipmentCostAllocation[]
  events             ShipmentEvent[]
  invoiceLines       ShippingInvoiceLine[]

  @@unique([networkOrderId, sequence])
  @@unique([carrierCode, trackingNumber])
  @@index([carrierCode, normalizedTracking])
  @@index([carrierCode])
  @@index([trackingNumber])
  @@index([networkOrderId])
  @@index([status])
}

model ShipmentEvent {
  id          String         @id @default(cuid())
  shipmentId  String
  status      ShipmentStatus
  description String?
  occurredAt  DateTime       @default(now())
  shipment    Shipment       @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
  @@index([occurredAt])
}

model ShipmentEventInbox {
  id             String              @id @default(cuid())
  carrierCode    String
  carrierEventId String              @unique
  trackingNumber String?
  shipmentId     String?
  raw            Json
  receivedAt     DateTime            @default(now())
  processedAt    DateTime?
  status         ShipmentInboxStatus @default(RECEIVED)
  errorMessage   String?

  @@index([trackingNumber])
  @@index([shipmentId])
  @@index([receivedAt])
  @@index([carrierCode])
}

model GlobalProduct {
  id           String              @id @default(cuid())
  name         String
  categoryId   String?
  description  String?
  barcode      String?
  imageUrl     String?
  status       ProductStatus       @default(DRAFT)
  approvalNote String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  companyMaps  CompanyProductMap[]
  category     GlobalCategory?     @relation(fields: [categoryId], references: [id])
  listings     NetworkListing[]

  @@index([categoryId])
  @@index([status])
}

model GlobalCategory {
  id               String                       @id @default(cuid())
  name             String
  parentId         String?
  slug             String                       @unique
  active           Boolean                      @default(true)
  listingOverrides B2BListingCategoryOverride[]
  attributes       CategoryAttribute[]
  mappings         CategoryMapping[]
  parent           GlobalCategory?              @relation("CategoryToCategory", fields: [parentId], references: [id])
  children         GlobalCategory[]             @relation("CategoryToCategory")
  products         GlobalProduct[]

  @@index([parentId])
}

model CategoryAttribute {
  id         String            @id @default(cuid())
  categoryId String
  name       String
  type       AttributeType     @default(STRING)
  options    AttributeOption[]
  category   GlobalCategory    @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
}

model AttributeOption {
  id          String            @id @default(cuid())
  attributeId String
  value       String
  attribute   CategoryAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@index([attributeId])
}

model ERPProductCategory {
  id              String               @id @default(cuid())
  sellerCompanyId String
  name            String
  parentId        String?
  active          Boolean              @default(true)
  mappings        CategoryMapping[]
  parent          ERPProductCategory?  @relation("ERPCategoryToERPCategory", fields: [parentId], references: [id])
  children        ERPProductCategory[] @relation("ERPCategoryToERPCategory")
  company         Company              @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)

  @@index([sellerCompanyId])
  @@index([parentId])
}

model CategoryMapping {
  id               String             @id @default(cuid())
  sellerCompanyId  String
  erpCategoryId    String
  globalCategoryId String
  confidence       MappingConfidence  @default(MANUAL)
  active           Boolean            @default(true)
  erpCategory      ERPProductCategory @relation(fields: [erpCategoryId], references: [id], onDelete: Cascade)
  globalCategory   GlobalCategory     @relation(fields: [globalCategoryId], references: [id], onDelete: Cascade)
  company          Company            @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)

  @@index([sellerCompanyId])
  @@index([erpCategoryId])
  @@index([globalCategoryId])
}

model B2BListingCategoryOverride {
  id               String         @id @default(cuid())
  listingId        String         @unique
  globalCategoryId String
  globalCategory   GlobalCategory @relation(fields: [globalCategoryId], references: [id], onDelete: Cascade)
  listing          NetworkListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([globalCategoryId])
}

model B2BSuggestion {
  id              String           @id @default(cuid())
  sellerCompanyId String
  productId       String?
  variantId       String?
  suggestionType  SuggestionType
  score           Float            @default(0)
  reasonsJson     Json
  status          SuggestionStatus @default(OPEN)
  dedupeKey       String?          @unique
  dismissedUntil  DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  product         Product?         @relation(fields: [productId], references: [id], onDelete: Cascade)
  company         Company          @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)

  @@index([sellerCompanyId])
  @@index([status])
  @@index([productId])
  @@index([variantId])
}

model AutomationDecisionLog {
  id              String   @id @default(cuid())
  sellerCompanyId String
  variantId       String?
  rule            String
  checksJson      Json
  decision        String
  createdAt       DateTime @default(now())
  company         Company  @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)

  @@index([sellerCompanyId])
  @@index([variantId])
}

model SellerAutomationPolicy {
  id                      String     @id @default(cuid())
  sellerCompanyId         String     @unique
  autoPublishEnabled      Boolean    @default(false)
  rolloutPercent          Int        @default(100)
  understockThresholdDays Int        @default(7)
  minOnHandThreshold      Int        @default(100)
  lowSalesThreshold       Int        @default(3)
  maxReservedRatio        Float      @default(0.2)
  minMarginPercent        Float?
  minListingQualityScore  Int        @default(50)
  defaultVisibility       Visibility @default(NETWORK)
  defaultMinOrderQty      Int        @default(1)
  defaultLeadTimeDays     Int        @default(3)
  allowAutoPriceAdjust    Boolean    @default(false)
  company                 Company    @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)
}

model CommerceAuditLog {
  id              String         @id @default(cuid())
  sellerCompanyId String
  actorType       ActorType
  action          CommerceAction
  entityType      String
  entityId        String
  payloadJson     Json?
  createdAt       DateTime       @default(now())
  company         Company        @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)

  @@index([sellerCompanyId])
  @@index([action])
  @@index([createdAt])
}

model NetworkListing {
  id                   String                      @id @default(cuid())
  globalProductId      String
  sellerCompanyId      String
  erpProductId         String
  price                Decimal                     @db.Decimal(10, 2)
  availableQty         Int                         @default(0)
  minQty               Int                         @default(1)
  leadTimeDays         Int                         @default(0)
  status               ListingStatus               @default(ACTIVE)
  visibility           Visibility                  @default(NETWORK)
  packSize             Int?                        @default(1)
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  categoryOverride     B2BListingCategoryOverride?
  discoveryImpressions DiscoveryImpression[]
  erpProduct           Product                     @relation(fields: [erpProductId], references: [id], onDelete: Cascade)
  globalProduct        GlobalProduct               @relation(fields: [globalProductId], references: [id], onDelete: Cascade)
  company              Company                     @relation(fields: [sellerCompanyId], references: [id], onDelete: Cascade)
  networkOrderItems    NetworkOrderItem[]

  @@unique([sellerCompanyId, erpProductId])
  @@index([globalProductId])
  @@index([sellerCompanyId])
  @@index([status])
  @@index([visibility, status])
}

model CompanyProductMap {
  id              String        @id @default(cuid())
  companyId       String
  globalProductId String
  erpProductId    String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  erpProduct      Product       @relation(fields: [erpProductId], references: [id], onDelete: Cascade)
  globalProduct   GlobalProduct @relation(fields: [globalProductId], references: [id], onDelete: Cascade)

  @@unique([companyId, globalProductId])
  @@unique([companyId, erpProductId])
  @@index([companyId])
  @@index([globalProductId])
}

model Rfq {
  id             String        @id @default(cuid())
  buyerCompanyId String
  status         RfqStatus     @default(DRAFT)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  items          RfqItem[]
  offers         SellerOffer[]

  @@index([buyerCompanyId])
  @@index([status])
}

model RfqItem {
  id              String   @id @default(cuid())
  rfqId           String
  productId       String
  sellerCompanyId String
  quantity        Int
  targetPrice     Decimal? @db.Decimal(12, 2)
  rfq             Rfq      @relation(fields: [rfqId], references: [id], onDelete: Cascade)

  @@index([rfqId])
  @@index([sellerCompanyId])
}

model SellerOffer {
  id              String            @id @default(cuid())
  rfqId           String
  sellerCompanyId String
  status          OfferStatus       @default(PENDING)
  totalPrice      Decimal           @db.Decimal(12, 2)
  expiresAt       DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  rfq             Rfq               @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  items           SellerOfferItem[]

  @@index([rfqId])
  @@index([sellerCompanyId])
  @@index([status])
}

model SellerOfferItem {
  id            String      @id @default(cuid())
  sellerOfferId String
  productId     String
  quantity      Int
  unitPrice     Decimal     @db.Decimal(12, 2)
  sellerOffer   SellerOffer @relation(fields: [sellerOfferId], references: [id], onDelete: Cascade)

  @@index([sellerOfferId])
}

model Contract {
  id              String           @id @default(cuid())
  buyerCompanyId  String
  sellerCompanyId String
  status          ContractStatus   @default(DRAFT)
  startDate       DateTime?
  endDate         DateTime?
  currency        String           @default("TRY")
  paymentMode     PaymentMode      @default(DIRECT)
  settlementCycle SettlementCycle  @default(INSTANT)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  items           ContractItem[]
  slas            ContractSLA[]
  recurringOrders RecurringOrder[]

  @@index([buyerCompanyId])
  @@index([sellerCompanyId])
  @@index([status])
}

model ContractItem {
  id            String         @id @default(cuid())
  contractId    String
  productId     String
  baseUnitPrice Decimal        @db.Decimal(12, 2)
  minOrderQty   Int            @default(1)
  contract      Contract       @relation(fields: [contractId], references: [id], onDelete: Cascade)
  tiers         ContractTier[]
  reservedStock ReservedStock?

  @@index([contractId])
  @@index([productId])
}

model ContractTier {
  id             String       @id @default(cuid())
  contractItemId String
  minQty         Int
  unitPrice      Decimal      @db.Decimal(12, 2)
  contractItem   ContractItem @relation(fields: [contractItemId], references: [id], onDelete: Cascade)

  @@index([contractItemId])
}

model ReservedStock {
  id             String       @id @default(cuid())
  contractItemId String       @unique
  quantity       Int          @default(0)
  allocated      Int          @default(0)
  contractItem   ContractItem @relation(fields: [contractItemId], references: [id], onDelete: Cascade)
}

model ContractSLA {
  id                 String   @id @default(cuid())
  contractId         String
  maxDeliveryDays    Int
  latePenaltyPercent Decimal  @db.Decimal(5, 2)
  contract           Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
}

model RecurringOrder {
  id          String             @id @default(cuid())
  contractId  String
  frequency   RecurringFrequency
  dayOfPeriod Int
  nextRunAt   DateTime?
  active      Boolean            @default(true)
  contract    Contract           @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([nextRunAt])
}

model PenaltyLedger {
  id              String   @id @default(cuid())
  sellerCompanyId String
  contractId      String
  amount          Decimal  @db.Decimal(12, 2)
  currency        String   @default("TRY")
  createdAt       DateTime @default(now())

  @@index([contractId])
}

model ProductConsumption {
  id              String   @id @default(cuid())
  companyId       String
  globalProductId String
  dailyRate       Float
  lastComputedAt  DateTime @default(now())
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, globalProductId])
  @@index([companyId])
}

model BuySuggestion {
  id              String   @id @default(cuid())
  buyerCompanyId  String
  globalProductId String
  daysRemaining   Float
  availableQty    Int      @default(0)
  status          String   @default("OPEN")
  dedupeKey       String   @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  company         Company  @relation(fields: [buyerCompanyId], references: [id], onDelete: Cascade)

  @@index([buyerCompanyId])
  @@index([globalProductId])
  @@index([status])
}

model CommissionPlan {
  id           String           @id @default(cuid())
  name         String
  description  String?
  isDefault    Boolean          @default(false)
  companyId    String?
  currency     String           @default("TRY")
  roundingMode String           @default("HALF_UP")
  precision    Int              @default(2)
  taxInclusive Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  archivedAt   DateTime?
  company      Company?         @relation(fields: [companyId], references: [id], onDelete: Restrict)
  rules        CommissionRule[]

  @@unique([companyId, isDefault])
  @@index([companyId])
}

model CommissionRule {
  id             String                  @id @default(cuid())
  planId         String
  scope          CommissionRuleScope     @default(GLOBAL)
  matchType      CommissionRuleMatchType @default(DEFAULT)
  category       String?
  brand          String?
  ratePercentage Decimal                 @db.Decimal(5, 2)
  fixedFee       Decimal                 @default(0) @db.Decimal(12, 2)
  priority       Int                     @default(0)
  plan           CommissionPlan          @relation(fields: [planId], references: [id])

  @@index([planId])
}

model CommissionSnapshot {
  id              String       @id @default(cuid())
  tenantId        String
  networkOrderId  String       @unique
  planId          String?
  appliedRate     Decimal      @db.Decimal(5, 2)
  appliedFixedFee Decimal      @db.Decimal(12, 2)
  totalCommission Decimal      @db.Decimal(12, 2)
  calculatedAt    DateTime     @default(now())
  order           NetworkOrder @relation(fields: [networkOrderId], references: [id])
  company         Company      @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, networkOrderId])
}

model SellerEarning {
  id                String        @id @default(cuid())
  sellerCompanyId   String
  shipmentId        String        @unique
  grossAmount       Decimal       @default(0) @db.Decimal(12, 2)
  commissionAmount  Decimal       @default(0) @db.Decimal(12, 2)
  chargebackAmount  Decimal       @default(0) @db.Decimal(12, 2)
  netAmount         Decimal       @db.Decimal(12, 2)
  currency          String        @default("TRY")
  status            EarningStatus @default(PENDING)
  expectedClearDate DateTime?
  clearedAt         DateTime?
  releasedAt        DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  archivedAt        DateTime?
  company           Company       @relation(fields: [sellerCompanyId], references: [id])
  shipment          Shipment      @relation(fields: [shipmentId], references: [id])

  @@unique([sellerCompanyId, shipmentId])
  @@index([sellerCompanyId])
  @@index([status])
  @@index([expectedClearDate])
}

model ReleaseWindowPolicy {
  id                  String    @id @default(cuid())
  sellerCompanyId     String    @unique
  isActiveDefault     Boolean   @default(true)
  defaultHoldDays     Int       @default(14)
  allowEarlyRelease   Boolean   @default(false)
  earlyReleaseFeeRate Decimal?  @db.Decimal(5, 2)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  archivedAt          DateTime?
  company             Company   @relation(fields: [sellerCompanyId], references: [id])

  @@unique([sellerCompanyId, isActiveDefault])
}

model LedgerAccount {
  id               String        @id @default(cuid())
  companyId        String        @unique
  availableBalance Decimal       @default(0) @db.Decimal(12, 2)
  pendingBalance   Decimal       @default(0) @db.Decimal(12, 2)
  currency         String        @default("TRY")
  lastReconciledAt DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  archivedAt       DateTime?
  reservedBalance  Decimal       @default(0) @db.Decimal(12, 2)
  company          Company       @relation(fields: [companyId], references: [id])
  entries          LedgerEntry[]
}

model LedgerGroup {
  id             String        @id @default(cuid())
  idempotencyKey String        @unique
  tenantId       String
  type           String
  description    String?
  createdAt      DateTime      @default(now())
  entries        LedgerEntry[]

  @@index([tenantId])
}

model LedgerEntry {
  id              String        @id @default(cuid())
  tenantId        String
  ledgerAccountId String
  groupId         String
  accountType     String
  direction       String
  amount          Decimal       @db.Decimal(12, 2)
  currency        String        @default("TRY")
  refType         String?
  referenceId     String?
  createdAt       DateTime      @default(now())
  group           LedgerGroup   @relation(fields: [groupId], references: [id])
  account         LedgerAccount @relation(fields: [ledgerAccountId], references: [id])

  @@index([ledgerAccountId])
  @@index([groupId])
  @@index([tenantId])
}

model IdempotencyRecord {
  id          String    @id @default(cuid())
  key         String    @unique
  scope       String
  tenantId    String
  status      String
  lockedAt    DateTime  @default(now())
  completedAt DateTime?
  resultHash  String?

  @@index([tenantId])
}

model FinanceAuditLog {
  id          String   @id @default(cuid())
  tenantId    String
  action      String
  actor       String
  entityId    String
  entityType  String
  payloadJson Json
  createdAt   DateTime @default(now())
  company     Company  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
}

model ShippingInvoice {
  id          String                @id @default(cuid())
  carrierId   String
  invoiceNo   String
  periodStart DateTime?
  periodEnd   DateTime?
  currency    String                @default("TRY")
  totalAmount Decimal               @db.Decimal(12, 2)
  rawRef      String?
  parsedJson  Json?
  status      String                @default("PARSED")
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  lines       ShippingInvoiceLine[]

  @@unique([carrierId, invoiceNo])
}

model ShippingInvoiceLine {
  id                String          @id @default(cuid())
  shippingInvoiceId String
  trackingNo        String
  chargeAmount      Decimal         @db.Decimal(12, 2)
  taxAmount         Decimal?        @db.Decimal(12, 2)
  serviceLevel      String?
  matchStatus       String          @default("UNMATCHED")
  matchReason       String?
  shipmentId        String?
  networkOrderId    String?
  sellerTenantId    String?
  buyerTenantId     String?
  shipment          Shipment?       @relation(fields: [shipmentId], references: [id])
  invoice           ShippingInvoice @relation(fields: [shippingInvoiceId], references: [id], onDelete: Cascade)

  @@unique([shippingInvoiceId, trackingNo])
}

model ShipmentCostAllocation {
  id                    String   @id @default(cuid())
  shipmentId            String
  shippingInvoiceLineId String?
  model                 String   @default("CHARGEBACK_SELLER")
  sellerShareAmount     Decimal  @db.Decimal(12, 2)
  platformShareAmount   Decimal  @db.Decimal(12, 2)
  buyerShareAmount      Decimal  @db.Decimal(12, 2)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  shipment              Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@unique([shipmentId, shippingInvoiceLineId])
}

model Ticket {
  id                   String                   @id @default(cuid())
  priority             TicketPriority           @default(LOW)
  status               TicketStatus             @default(OPEN)
  tenantId             String
  createdAt            DateTime                 @default(now())
  counterpartyTenantId String?
  createdByUserId      String?
  relatedEntityId      String?
  relatedEntityType    TicketRelatedEntityType?
  resolvedAt           DateTime?
  slaDueAt             DateTime?
  type                 TicketType               @default(GENERAL)
  counterparty         Company?                 @relation("TicketCounterparty", fields: [counterpartyTenantId], references: [id], onDelete: Restrict)
  tenant               Company                  @relation("TicketTenant", fields: [tenantId], references: [id])
  auditLogs            TicketAuditLog[]
  messages             TicketMessage[]

  @@index([tenantId, status])
  @@index([relatedEntityType, relatedEntityId])
}

model TicketMessage {
  id              String           @id @default(cuid())
  ticketId        String
  createdAt       DateTime         @default(now())
  message         String
  redactedMessage String
  senderRole      TicketSenderRole
  senderTenantId  String
  senderTenant    Company          @relation(fields: [senderTenantId], references: [id])
  ticket          Ticket           @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model TicketAuditLog {
  id            String            @id @default(cuid())
  ticketId      String
  action        TicketAuditAction
  actorTenantId String
  payloadJson   Json
  createdAt     DateTime          @default(now())
  ticket        Ticket            @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model SellerTrustScore {
  id             String         @id @default(cuid())
  sellerTenantId String         @unique
  score          Int            @default(100)
  tier           SellerRiskTier @default(A)
  componentsJson Json
  computedAt     DateTime       @default(now())
  windowStart    DateTime
  windowEnd      DateTime
  version        Int            @default(1)
  sellerCompany  Company        @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([sellerTenantId])
  @@index([tier, computedAt])
}

model SellerTrustEvent {
  id             String         @id @default(cuid())
  sellerTenantId String
  type           TrustEventType
  refType        String
  refId          String
  weight         Int            @default(1)
  occurredAt     DateTime
  createdAt      DateTime       @default(now())
  sellerCompany  Company        @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([sellerTenantId, occurredAt])
}

model TrustScoreRecalcJob {
  id             String          @id @default(cuid())
  sellerTenantId String
  status         RecalcJobStatus @default(PENDING)
  reason         RecalcReason    @default(EVENT_DRIVEN)
  idempotencyKey String          @unique
  errorText      String?
  createdAt      DateTime        @default(now())
  completedAt    DateTime?
  sellerCompany  Company         @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)
}

model DiscoveryImpression {
  id             String         @id @default(cuid())
  viewerTenantId String
  listingId      String
  position       Int
  score          Decimal        @db.Decimal(10, 4)
  reasonJson     Json
  createdAt      DateTime       @default(now())
  requestId      String?
  listing        NetworkListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  viewerCompany  Company        @relation(fields: [viewerTenantId], references: [id], onDelete: Cascade)

  @@index([viewerTenantId, createdAt])
  @@index([listingId, createdAt])
  @@index([requestId])
}

model BoostRule {
  id                   String     @id @default(cuid())
  scope                BoostScope
  targetId             String
  multiplier           Decimal    @db.Decimal(10, 2)
  startsAt             DateTime
  endsAt               DateTime
  isActive             Boolean    @default(true)
  createdByTenantId    String
  createdAt            DateTime   @default(now())
  maxImpressionsPerDay Int?
  priority             Int        @default(0)
  creatorCompany       Company    @relation(fields: [createdByTenantId], references: [id], onDelete: Cascade)

  @@index([scope, targetId, isActive, startsAt, endsAt])
  @@index([isActive, endsAt])
  @@index([startsAt, endsAt])
}

model DiscoveryRequestLog {
  id               String   @id @default(cuid())
  viewerTenantId   String
  requestId        String   @unique
  queryHash        String
  weightsVersion   String
  filtersJson      Json
  sortMode         String
  limit            Int
  latencyMs        Int
  dbLatencyMs      Int
  computeLatencyMs Int
  resultsCount     Int
  topResultsJson   Json
  createdAt        DateTime @default(now())

  @@index([viewerTenantId, createdAt])
}

model ListingPriceSnapshot {
  id         String   @id @default(cuid())
  listingId  String
  price      Decimal  @db.Decimal(10, 2)
  currency   String   @default("TRY")
  capturedAt DateTime @default(now())

  @@index([listingId, capturedAt])
}

model PayoutDestination {
  id               String                  @id @default(cuid())
  sellerTenantId   String
  type             PayoutDestinationType
  ibanMasked       String
  ibanEncrypted    String
  holderNameMasked String
  isDefault        Boolean                 @default(false)
  status           PayoutDestinationStatus @default(ACTIVE)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  sellerCompany    Company                 @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@unique([sellerTenantId, ibanMasked])
  @@index([sellerTenantId, isDefault])
}

model PayoutRequest {
  id               String              @id @default(cuid())
  sellerTenantId   String
  destinationId    String
  amount           Decimal             @db.Decimal(12, 2)
  currency         String              @default("TRY")
  status           PayoutRequestStatus @default(REQUESTED)
  requestedAt      DateTime            @default(now())
  approvedAt       DateTime?
  processedAt      DateTime?
  failureCode      String?
  failureMessage   String?
  idempotencyKey   String              @unique
  createdByUserId  String
  approvedByUserId String?
  note             String?
  sellerCompany    Company             @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([sellerTenantId, status, requestedAt])
  @@index([status, requestedAt])
}

model SellerPaymentProfile {
  id             String                     @id @default(cuid())
  sellerTenantId String                     @unique
  provider       PaymentProvider            @default(IYZICO)
  subMerchantKey String
  status         SellerPaymentProfileStatus @default(PENDING)
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt
  sellerCompany  Company                    @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)
}

model ProviderPayment {
  id                String                @id @default(cuid())
  tenantId          String
  provider          PaymentProvider       @default(IYZICO)
  providerPaymentId String                @unique
  networkPaymentId  String                @unique
  amount            Decimal               @db.Decimal(12, 2)
  currency          String                @default("TRY")
  status            ProviderPaymentStatus @default(INIT)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  buyerCompany      Company               @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status, createdAt])
}

model ProviderPayout {
  id               String               @id @default(cuid())
  sellerTenantId   String
  provider         PaymentProvider      @default(IYZICO)
  providerPayoutId String               @unique
  payoutRequestId  String?
  sellerEarningId  String?
  shipmentId       String?
  grossAmount      Decimal              @db.Decimal(12, 2)
  commissionAmount Decimal              @db.Decimal(12, 2)
  netAmount        Decimal              @db.Decimal(12, 2)
  currency         String               @default("TRY")
  status           ProviderPayoutStatus @default(QUEUED)
  idempotencyKey   String               @unique
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  sellerCompany    Company              @relation(fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([sellerTenantId, status, createdAt])
  @@index([status, createdAt])
}

model PayoutOutbox {
  id             String             @id @default(cuid())
  provider       PaymentProvider    @default(IYZICO)
  idempotencyKey String             @unique
  sellerTenantId String
  payloadJson    Json
  status         PayoutOutboxStatus @default(PENDING)
  lastError      String?
  attemptCount   Int                @default(0)
  nextRetryAt    DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  sellerCompany  Company            @relation("OutboxCompany", fields: [sellerTenantId], references: [id], onDelete: Cascade)

  @@index([status, nextRetryAt])
}

model ProviderWebhookEvent {
  id              String                @id @default(cuid())
  provider        PaymentProvider       @default(IYZICO)
  externalEventId String                @unique
  eventType       String
  payloadJson     Json
  receivedAt      DateTime              @default(now())
  processedAt     DateTime?
  status          ProviderWebhookStatus @default(RECEIVED)

  @@index([provider, receivedAt])
}

model FinanceIntegrityAlert {
  id          String                        @id @default(cuid())
  type        FinanceIntegrityAlertType
  referenceId String?
  severity    FinanceIntegrityAlertSeverity @default(WARNING)
  detailsJson Json
  resolvedAt  DateTime?
  createdAt   DateTime                      @default(now())

  @@index([type, createdAt])
}

model FinanceOpsLog {
  id          String                @id @default(cuid())
  action      String
  entityType  String
  entityId    String?
  severity    FinanceOpsLogSeverity @default(INFO)
  payloadJson Json?
  createdAt   DateTime              @default(now())
}

model OpsHealthSnapshot {
  id          String                 @id @default(cuid())
  scope       OpsHealthSnapshotScope @default(RUNTIME)
  createdAt   DateTime               @default(now())
  payloadJson Json

  @@index([scope, createdAt])
}

model BillingHealthSnapshot {
  id                       String   @id @default(cuid())
  day                      String   @unique
  totalOutstandingAR       Decimal  @db.Decimal(18,2)
  overdueInvoiceCount      Int
  blockedSubscriptionCount Int
  createdAt                DateTime @default(now())
}

model OpsAlertAck {
  id                   String   @id @default(cuid())
  alertType            String
  alertId              String
  acknowledgedByUserId String
  note                 String
  acknowledgedAt       DateTime @default(now())

  @@unique([alertType, alertId])
}

model PlatformDailyMetrics {
  id                            String   @id @default(cuid())
  day                           String   @unique
  gmvGross                      Decimal  @db.Decimal(12, 2)
  orderCount                    Int
  activeBuyerCount              Int
  activeSellerCount             Int
  takeRevenueCommission         Decimal  @db.Decimal(12, 2)
  takeRevenueBoost              Decimal  @db.Decimal(12, 2)
  takeRate                      Decimal  @db.Decimal(5, 4)
  escrowFloatEndOfDay           Decimal  @db.Decimal(12, 2)
  payoutVolume                  Decimal  @db.Decimal(12, 2)
  payoutCount                   Int
  avgReleaseTimeHours           Decimal  @db.Decimal(12, 2)
  chargebackAmount              Decimal  @db.Decimal(12, 2)
  chargebackCount               Int
  receivableOutstandingEndOfDay Decimal  @db.Decimal(12, 2)
  opsCriticalAlertCount         Int
  createdAt                     DateTime @default(now())
}

model TenantDailyMetrics {
  id                    String                 @id @default(cuid())
  day                   String
  tenantId              String
  role                  TenantDailyMetricsRole
  gmvGross              Decimal                @db.Decimal(12, 2)
  orderCount            Int
  commissionPaid        Decimal                @db.Decimal(12, 2)
  payoutReceived        Decimal                @db.Decimal(12, 2)
  avgReleaseTimeHours   Decimal                @db.Decimal(12, 2)
  disputeCount          Int
  chargebackCount       Int
  receivableOutstanding Decimal                @db.Decimal(12, 2)
  discoveryImpressions  Int
  boostImpressions      Int                    @default(0)
  boostSpend            Decimal                @default(0) @db.Decimal(12, 2)
  createdAt             DateTime               @default(now())

  @@unique([day, tenantId])
  @@index([tenantId, day])
}

model FeatureFlag {
  id           String   @id @default(cuid())
  key          String   @unique
  description  String
  defaultValue Boolean
  createdAt    DateTime @default(now())
}

model TenantFeatureFlag {
  id         String   @id @default(cuid())
  tenantId   String
  featureKey String
  enabled    Boolean
  createdAt  DateTime @default(now())

  @@unique([tenantId, featureKey])
  @@index([tenantId, featureKey])
}

model TenantRolloutPolicy {
  id                   String       @id @default(cuid())
  tenantId             String       @unique
  cohort               TenantCohort @default(PILOT)
  maxDailyGmv          Decimal?     @db.Decimal(12, 2)
  maxDailyPayout       Decimal?     @db.Decimal(12, 2)
  maxSingleOrderAmount Decimal?     @db.Decimal(12, 2)
  holdDaysOverride     Int?
  earlyReleaseAllowed  Boolean      @default(false)
  payoutPaused         Boolean      @default(false)
  escrowPaused         Boolean      @default(false)
  boostPaused          Boolean      @default(false)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
}

model PilotCohortTag {
  id        String   @id @default(cuid())
  tenantId  String
  tag       String
  createdAt DateTime @default(now())

  @@unique([tenantId, tag])
  @@index([tag])
}

model PlatformCohortDailyMetrics {
  id                    String   @id @default(cuid())
  day                   String
  cohortTag             String
  gmvGross              Decimal  @db.Decimal(12, 2)
  orderCount            Int
  payoutVolume          Decimal  @db.Decimal(12, 2)
  takeRevenueCommission Decimal  @db.Decimal(12, 2)
  chargebackAmount      Decimal  @db.Decimal(12, 2)
  createdAt             DateTime @default(now())

  @@unique([day, cohortTag])
}

model BoostPlan {
  id                     String              @id @default(cuid())
  code                   String              @unique
  name                   String
  monthlyPrice           Decimal             @db.Decimal(12, 2)
  currency               String              @default("TRY")
  monthlyImpressionQuota Int
  isActive               Boolean             @default(true)
  createdAt              DateTime            @default(now())
  subscriptions          BoostSubscription[]
}

model BoostSubscription {
  id                 String                  @id @default(cuid())
  sellerTenantId     String
  planId             String
  status             BoostSubscriptionStatus
  startAt            DateTime
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  nextRenewalAt      DateTime                @default(now())
  lastChargedPeriodKey String?
  autoRenew          Boolean                 @default(true)
  billingBlocked     Boolean                 @default(false)
  blockedAt          DateTime?
  pausedAt           DateTime?
  canceledAt         DateTime?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  plan               BoostPlan               @relation(fields: [planId], references: [id])
  invoices           BoostInvoice[]

  @@index([sellerTenantId, status])
}

model BoostInvoice {
  id                String             @id @default(cuid())
  sellerTenantId    String
  subscriptionId    String
  periodKey         String             // "2026-03"
  amount            Decimal            @db.Decimal(18,2)
  currency          String             @default("TRY")
  status            BoostInvoiceStatus
  issuedAt          DateTime
  dueAt             DateTime
  paidAt            DateTime?
  ledgerGroupId     String?
  graceEndsAt       DateTime?
  overdueAt         DateTime?
  collectionStatus  BoostInvoiceCollectionStatus @default(CURRENT)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  subscription      BoostSubscription  @relation(fields: [subscriptionId], references: [id])

  @@unique([subscriptionId, periodKey])
  @@index([sellerTenantId, status])
}

model BoostUsageDaily {
  id                   String   @id @default(cuid())
  sellerTenantId       String
  day                  String
  sponsoredImpressions Int      @default(0)
  billableImpressions  Int      @default(0)
  periodKey            String
  createdAt            DateTime @default(now())

  @@unique([sellerTenantId, day])
  @@index([sellerTenantId, periodKey])
}

model BoostUsageEvent {
  id                   String   @id @default(cuid())
  requestId            String
  sellerTenantId       String
  day                  String
  sponsoredImpressions Int
  createdAt            DateTime @default(now())

  @@unique([requestId, sellerTenantId])
}

model BillingLedgerRef {
  id             String               @id @default(cuid())
  entityType     BillingLedgerRefType
  entityId       String
  idempotencyKey String               @unique
  ledgerGroupId  String?
  createdAt      DateTime             @default(now())
}

model DiscoveryRequestBillingState {
  id        String    @id @default(cuid())
  requestId String    @unique
  meteredAt DateTime?
  createdAt DateTime  @default(now())
}

enum PdksType {
  SHIFT_START
  SHIFT_END
  BREAK_START
  BREAK_END
}

enum PdksMode {
  OFFICE_QR
  FIELD_GPS
}

enum PdksStatus {
  APPROVED
  PENDING
  REJECTED
}

enum TopicStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PaymentProvider {
  ODEL
  IYZICO
}

enum PaymentMode {
  DIRECT
  ESCROW
}

enum PaymentStatus {
  INITIATED
  PAID
  FAILED
  CANCELLED
}

enum PaymentEventStatus {
  RECEIVED
  PROCESSED
  IGNORED
  FAILED
}

enum LedgerType {
  CREDIT
  DEBIT
}

enum ShipmentMode {
  MANUAL
  INTEGRATED
}

enum ShipmentStatus {
  CREATED
  LABEL_CREATED
  IN_TRANSIT
  DELIVERED
  EXCEPTION
  CANCELLED
  COMPLETED
}

enum ShipmentInboxStatus {
  RECEIVED
  PROCESSED
  IGNORED
  FAILED
}

enum AttributeType {
  STRING
  NUMBER
  BOOLEAN
  SELECT
}

enum MappingConfidence {
  MANUAL
  AUTO
}

enum SuggestionType {
  LIST
  INCREASE_VISIBILITY
  ADJUST_PRICE
  PAUSE
  FIX_LISTING
  SET_PRICE
}

enum SuggestionStatus {
  OPEN
  ACCEPTED
  DISMISSED
  AUTO_APPLIED
  PREVIEW_ONLY
}

enum Visibility {
  NETWORK
  PRIVATE
}

enum ActorType {
  ADMIN
  SELLER
  SYSTEM
}

enum CommerceAction {
  CREATE_LISTING
  ACTIVATE_LISTING
  PAUSE_LISTING
  MAP_CATEGORY
  AUTO_PUBLISH
  AUTO_PAUSE
  POLICY_UPDATE
  SUGGESTION_ACCEPT
  SUGGESTION_DISMISS
  AUTO_PUBLISH_ERROR
}

enum ListingStatus {
  DRAFT
  ACTIVE
  PAUSED
}

enum RfqStatus {
  DRAFT
  SENT
  RESPONDED
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum OfferStatus {
  PENDING
  COUNTERED
  ACCEPTED
  REJECTED
}

enum ContractStatus {
  DRAFT
  ACTIVE
  SUSPENDED
  EXPIRED
}

enum SettlementCycle {
  INSTANT
  WEEKLY
  MONTHLY
}

enum RecurringFrequency {
  WEEKLY
  MONTHLY
}

enum OrderSourceType {
  CART
  RFQ
  CONTRACT
}

enum CompanyType {
  BUYER
  SELLER
  PLATFORM
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum ProductStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum CommissionRuleScope {
  GLOBAL
  COMPANY_OVERRIDE
}

enum CommissionRuleMatchType {
  CATEGORY
  BRAND
  CATEGORY_AND_BRAND
  DEFAULT
}

enum EarningStatus {
  PENDING
  CLEARED
  RELEASED
  REFUNDED
}

enum TicketType {
  SHIPPING_DISPUTE
  EARNING_DISPUTE
  RELEASE_REQUEST
  GENERAL
}

enum TicketRelatedEntityType {
  SHIPPING_LINE
  EARNING
  ORDER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  REJECTED
  SLA_BREACH
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketSenderRole {
  BUYER
  SELLER
  PLATFORM_ADMIN
}

enum TicketAuditAction {
  CREATED
  STATUS_CHANGED
  SLA_UPDATED
  RESOLVED
  REJECTED
}

enum SellerRiskTier {
  A
  B
  C
  D
}

enum TrustEventType {
  SHIPMENT_DELIVERED_ON_TIME
  SHIPMENT_DELIVERED_LATE
  SHIPPING_DISPUTE_OPENED
  SHIPPING_DISPUTE_RESOLVED
  SLA_BREACH
  CHARGEBACK_POSTED
  RECEIVABLE_CREATED
  EARNING_MANUAL_OVERRIDE
  EARNING_RELEASED
}

enum RecalcJobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

enum RecalcReason {
  SCHEDULED
  EVENT_DRIVEN
  MANUAL_ADMIN
}

enum BoostScope {
  LISTING
  SELLER
  CATEGORY
}

enum PayoutDestinationType {
  IBAN
}

enum PayoutDestinationStatus {
  ACTIVE
  DISABLED
}

enum PayoutRequestStatus {
  REQUESTED
  APPROVED
  PROCESSING
  PAID_INTERNAL
  REJECTED
  CANCELED
  FAILED
}

enum SellerPaymentProfileStatus {
  PENDING
  ACTIVE
  DISABLED
}

enum ProviderPaymentStatus {
  INIT
  PAID
  FAILED
  REFUNDED
  CHARGEBACK
}

enum ProviderPayoutStatus {
  QUEUED
  SENT
  SUCCEEDED
  FAILED
  REVERSED
  RECONCILE_REQUIRED
  QUARANTINED
}

enum PayoutOutboxStatus {
  PENDING
  SENDING
  SENT
  FAILED
}

enum ProviderWebhookStatus {
  RECEIVED
  PROCESSED
  IGNORED
  FAILED
}

enum FinanceIntegrityAlertType {
  LEDGER_UNBALANCED
  FINALIZE_MISSING
  FINALIZE_ORPHAN
  WALLET_DRIFT
  OUTBOX_MISSING
  CRITICAL
}

enum FinanceIntegrityAlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum FinanceOpsLogSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum OpsHealthSnapshotScope {
  RUNTIME
  DAILY
}

enum TenantDailyMetricsRole {
  BUYER
  SELLER
  BOTH
}

enum TenantCohort {
  PILOT
  GENERAL
  INTERNAL
}

enum BoostSubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  EXPIRED
}

enum BoostInvoiceCollectionStatus {
  CURRENT
  GRACE
  OVERDUE
  COLLECTION_BLOCKED
}

enum BillingLedgerRefType {
  BOOST_SUBSCRIPTION_CHARGE
  BOOST_OVERAGE
}

enum BoostInvoiceStatus {
  DRAFT
  ISSUED
  PAID
  VOID
}

enum DisputeStatus {
  OPEN
  NEEDS_INFO
  IN_REVIEW
  RESOLVED
  REJECTED
}

enum DisputeSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EscrowActionState {
  NONE
  HELD
  PARTIALLY_RELEASED
  RELEASED
  REFUNDED
}

enum DisputeResolutionCode {
  DELIVERY_FAILED
  QUALITY_ISSUE
  NOT_AS_DESCRIBED
  BILLING_ERROR
  FRAUD_SUSPECTED
  OTHER
}

enum DisputeActionType {
  HOLD_ESCROW
  PARTIAL_RELEASE
  FULL_RELEASE
  REFUND
  FLAG_CHARGEBACK
  REQUEST_INFO
  CHANGE_SEVERITY
  CHANGE_STATUS
  ADD_INTERNAL_NOTE
}

model DisputeCase {
  id                    String                 @id @default(cuid())
  ticketId              String                 @unique
  status                DisputeStatus          @default(OPEN)
  severity              DisputeSeverity        @default(LOW)
  escrowActionState     EscrowActionState      @default(NONE)
  referencedShipmentId  String?
  referencedOrderId     String?
  buyerTenantId         String
  sellerTenantId        String
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  resolvedAt            DateTime?
  resolutionSummary     String?                @db.Text
  resolutionCode        DisputeResolutionCode?
  actions               DisputeAction[]

  @@index([status])
  @@index([severity])
  @@index([updatedAt])
}

model DisputeAction {
  id              String            @id @default(cuid())
  disputeCaseId   String
  actionType      DisputeActionType
  actorUserId     String
  actorRole       String
  amount          Decimal?          @db.Decimal(12, 2)
  reason          String
  payloadJson     Json
  idempotencyKey  String            @unique
  createdAt       DateTime          @default(now())
  disputeCase     DisputeCase       @relation(fields: [disputeCaseId], references: [id], onDelete: Restrict)

  @@index([disputeCaseId])
  @@index([actionType])
  @@index([createdAt])
}
