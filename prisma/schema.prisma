generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("USER") // ADMIN, STAFF
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MarketplaceConfig {
  id        String    @id @default(cuid())
  type      String    @unique // trendyol, hepsiburada, n11
  settings  Json // API keys, secrets, supplierId vb.
  isActive  Boolean   @default(false)
  lastSync  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Order {
  id              String    @id @default(cuid())
  marketplaceId   String // Pazaryerindeki orijinal ID
  orderNumber     String    @unique // Sipariş numarası
  marketplace     String // trendyol, hepsiburada
  customerName    String
  customerEmail   String?
  totalAmount     Decimal   @db.Decimal(10, 2)
  currency        String    @default("TRY")
  status          String
  orderDate       DateTime
  items           Json // Sipariş kalemleri (JSON array)
  shippingAddress Json?
  invoiceAddress  Json?
  cargoTrackingNo String?
  cargoProvider   String?
  rawData         Json? // Pazaryerinden gelen ham veri (debug için)
  deletedAt       DateTime? // Soft delete
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([marketplace, orderNumber])
  @@index([customerName])
  @@index([orderDate])
  @@index([status])
}

model Product {
  id                  String    @id @default(cuid())
  name                String
  code                String
  barcode             String?
  price               Decimal   @db.Decimal(10, 2)
  buyPrice            Decimal   @default(0) @db.Decimal(10, 2)
  stock               Int       @default(0)
  category            String?
  description         String?
  imageUrl            String?
  minStock            Int       @default(5)
  brand               String?
  type                String?   @default("Ürün")
  supplier            String?
  branch              String?   @default("Merkez")
  salesVat            Int?      @default(20)
  salesVatIncluded    Boolean?  @default(true)
  purchaseVat         Int?      @default(20)
  purchaseVatIncluded Boolean?  @default(true)
  salesOiv            Decimal?  @default(0) @db.Decimal(10, 2)
  salesOtv            Decimal?  @default(0) @db.Decimal(10, 2)
  
  otvType             String?   @default("Ö.T.V yok")
  gtip                String?
  purchaseDiscount    Decimal?  @default(0) @db.Decimal(5, 2)
  otvCode             String?   @default("7")
  deletedAt           DateTime? // Soft delete
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  marketplaceMaps MarketplaceProductMap[]

  @@unique([code, branch]) // Aynı kod aynı şubede tekrar edemez
  @@index([name])
  @@index([barcode])
  @@index([code])
  @@index([category])
  @@index([supplier])
}

model MarketplaceProductMap {
  id              String   @id @default(cuid())
  marketplace     String // trendyol, hepsiburada, n11
  marketplaceCode String // Pazaryerindeki kod (SKU, Model Kodu veya Barkod)
  productId       String // Bizim sistemdeki ürün ID
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())

  @@unique([marketplace, marketplaceCode]) // Bir pazaryeri kodu sadece tek bir ürüne eşleşebilir
  @@index([productId])
}

model Supplier {
  id            String    @id @default(cuid())
  name          String
  phone         String?
  email         String?
  address       String?
  category      String? // Yedek Parça, Yağ, Lastik vb.
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal   @default(0) @db.Decimal(12, 2) // Pozitif: Alacağımız var, Negatif: Borcumuz var
  branch        String?   @default("Merkez")
  isActive      Boolean   @default(true)
  deletedAt     DateTime? // Soft delete

  invoices     PurchaseInvoice[]
  transactions Transaction[]
  checks       Check[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([taxNumber])
  @@index([phone])
}

model PurchaseInvoice {
  id          String    @id @default(cuid())
  invoiceNo   String
  invoiceDate DateTime
  dueDate     DateTime?
  amount      Decimal   @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  description String?

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  items  Json? // Fatura kalemleri
  status String @default("Bekliyor") // Bekliyor, Ödendi, İptal

  deletedAt DateTime? // Soft delete
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([invoiceNo])
  @@index([invoiceDate])
  @@index([supplierId])
  @@index([status])
}

model SalesInvoice {
  id          String   @id @default(cuid())
  invoiceNo   String   @unique
  invoiceDate DateTime @default(now())
  amount      Decimal  @db.Decimal(10, 2)
  taxAmount   Decimal  @default(0) @db.Decimal(10, 2)
  totalAmount Decimal  @db.Decimal(10, 2)
  description String?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  items    Json // Fatura kalemleri (JSON array)
  status   String  @default("Taslak") // Taslak, Onaylandı, İptal
  isFormal Boolean @default(false)
  branch   String? @default("Merkez")

  deletedAt DateTime? // Soft delete
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([customerId])
  @@index([invoiceDate])
  @@index([invoiceNo])
  @@index([status])
}

model Customer {
  id            String  @id @default(cuid())
  name          String
  email         String?
  phone         String?
  address       String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal @default(0) @db.Decimal(12, 2)
  points        Decimal @default(0) @db.Decimal(10, 2)
  branch        String? @default("Merkez")

  categoryId   String?
  category     CustomerCategory? @relation(fields: [categoryId], references: [id])
  supplierClass String?
  customerClass String?
  transactions Transaction[]
  invoices     SalesInvoice[]
  checks       Check[]

  documents CustomerDocument[]
  services  ServiceRecord[]
  warranties Warranty[]
  coupons    Coupon[]
  referralCode String? @unique
  deletedAt DateTime? // Soft delete
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([name])
  @@index([phone])
  @@index([email])
  @@index([taxNumber])
}

model ServiceRecord {
  id          String    @id @default(cuid())
  customerId  String
  customer    Customer  @relation(fields: [customerId], references: [id])
  plate       String?
  km          Int?
  nextKm      Int?
  nextDate    DateTime?
  vehicleBrand String?
  vehicleSerial String?
  notes         String?
  status      String    @default("Tamamlandı") // Tamamlandı, Bekliyor, İptal
  totalAmount Decimal   @db.Decimal(10, 2)
  items       Json // Service items (parts, labor)
  deletedAt   DateTime? // Soft delete
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([customerId])
  @@index([plate])
  @@index([nextDate])
  @@index([status])
}

model CustomerDocument {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String // Base64 encoded for small/med files
  uploadedAt DateTime @default(now())

  @@index([customerId])
}

model CustomerCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  customers   Customer[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Kasa {
  id           String        @id @default(cuid())
  name         String        @unique
  type         String        @default("Nakit")
  balance      Decimal       @default(0) @db.Decimal(12, 2)
  currency     String        @default("TRY")
  isActive     Boolean       @default(true)
  deletedAt    DateTime? // Soft delete
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Transaction {
  id          String   @id @default(cuid())
  type        String
  amount      Decimal  @db.Decimal(12, 2)
  description String?
  date        DateTime @default(now())

  kasaId String
  kasa   Kasa   @relation(fields: [kasaId], references: [id])

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  deletedAt DateTime? // Soft delete
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([customerId])
  @@index([supplierId])
  @@index([date])
  @@index([type])
  @@index([kasaId])
}

model Check {
  id          String   @id @default(cuid())
  type        String // Alınan Çek, Verilen Çek, Alınan Senet, Verilen Senet
  number      String // Çek/Evrak No
  bank        String? // Banka
  dueDate     DateTime // Vade Tarihi
  amount      Decimal  @db.Decimal(12, 2)
  status      String   @default("Beklemede") // Beklemede, Tahsil Edildi, Ödendi, İptal, Ciro Edildi
  description String?

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dueDate])
  @@index([status])
  @@index([number])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userName  String?
  action    String // DELETE, UPDATE, CREATE, LOGIN, etc.
  entity    String // Customer, Product, Transaction, etc.
  entityId  String?
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([action, entity])
  @@index([createdAt])
}

model Branch {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  type      String   @default("Şube")
  city      String?
  address   String?
  phone     String?
  manager   String?
  status    String   @default("Aktif")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  documents BranchDocument[]
}

model BranchDocument {
  id         String   @id @default(cuid())
  branchId   Int
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String // Base64 encoded
  uploadedAt DateTime @default(now())

  @@index([branchId])
}

model SuspendedSale {
  id          String   @id @default(cuid())
  label       String
  items       Json     // [{product, qty}]
  customer    Json?    // Optional customer snapshot
  total       Decimal  @db.Decimal(12, 2)
  branch      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Staff {
  id           String   @id @default(cuid())
  username     String   @unique
  password     String?
  email        String?
  name         String
  role         String?
  branch       String?   @default("Merkez")
  type         String?   @default("service") // service, sales, office
  status       String?   @default("Boşta") // Boşta, Meşgul, İzinli
  currentJob   String?
  permissions  String[]  @default([])
  performance  Int?      @default(100)
  salary       Decimal?  @default(17002) @db.Decimal(10, 2)
  lastActive   DateTime? @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  shifts        Shift[]
  leaveRequests LeaveRequest[]
  payrolls      Payroll[]

  @@index([username])
}

model Shift {
  id        String   @id @default(cuid())
  staffId   String
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  start     DateTime // Vardiya başlangıç saati
  end       DateTime // Bitiş saati
  type      String   @default("Normal") // Normal, İzinli, Raporlu
  branch    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId])
  @@index([start])
}

model LeaveRequest {
  id          String   @id @default(cuid())
  staffId     String
  staff       Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  type        String   // Yıllık İzin, Mazeret, Rapor
  startDate   DateTime
  endDate     DateTime
  days        Int
  reason      String?
  status      String   @default("Bekliyor") // Bekliyor, Onaylandı, Reddedildi
  approvedBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([staffId])
  @@index([status])
}

model Payroll {
  id          String   @id @default(cuid())
  staffId     String
  staff       Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  period      String   // "2026-01"
  salary      Decimal  @db.Decimal(10, 2)
  bonus       Decimal  @default(0) @db.Decimal(10, 2)
  deductions  Decimal  @default(0) @db.Decimal(10, 2) // Avans vb.
  netPay      Decimal  @db.Decimal(10, 2)
  status      String   @default("Bekliyor") // Bekliyor, Ödendi
  paidAt      DateTime?
  note        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([staffId, period])
  @@index([period])
}

model Notification {
  id        String   @id @default(cuid())
  type      String   @default("info") // success, error, warning, danger, stock
  icon      String?
  text      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model PendingProduct {
  id          String   @id @default(cuid())
  productData Json     // Ham ürün datası
  requestedBy String?
  status      String   @default("pending") // pending, approved, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PendingTransfer {
  id           String   @id @default(cuid())
  transferData Json     // Ham transfer datası {productId, from, to, qty}
  requestedBy  String?
  status       String   @default("pending") // pending, approved, rejected
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model StockTransfer {
  id            String   @id @default(cuid())
  productId     String
  productName   String
  productCode   String
  qty           Int
  fromBranch    String
  toBranch      String
  status        String   @default("IN_TRANSIT") // IN_TRANSIT, RECEIVED, CANCELLED
  requestedBy   String?
  shippedAt     DateTime @default(now())
  receivedAt    DateTime?
  receivedBy    String?
  trackingNo    String?
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([fromBranch])
  @@index([toBranch])
}

model InventoryAudit {
  id          String    @id @default(cuid())
  branch      String
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?
  status      String    @default("in_progress") // in_progress, completed, cancelled
  items       Json      // [{productId, productName, systemStock, countedStock}]
  reportedBy  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model AppSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

model Warranty {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  productName String
  serialNo    String
  startDate   DateTime
  endDate     DateTime
  period      String
  status      String   @default("Active")
  invoiceNo   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([customerId])
  @@index([serialNo])
}

model SecurityEvent {
  id                String   @id @default(cuid())
  timestamp         DateTime @default(now())
  detectedPhrase    String
  confidence        Float
  hasSaleInLast5Min Boolean  @default(false)
  branch            String
  staff             String
  details           String?
  createdAt         DateTime @default(now())

  @@index([timestamp])
  @@index([branch])
}

model Campaign {
  id           String    @id @default(cuid())
  name         String
  type         String    // payment_method_discount, loyalty_points
  description  String?
  conditions   Json      // { paymentMethods: [], brands: [], categories: [] }
  discountRate Float?    // e.g. 0.10 for 10%
  pointsRate   Float?    // e.g. 0.05 for 5%
  startDate    DateTime  @default(now())
  endDate      DateTime?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([type])
  @@index([isActive])
}

model Coupon {
  id                 String    @id @default(cuid())
  code               String    @unique
  campaignName       String?   // New Field
  type               String    // percent, amount
  value              Float
  minPurchaseAmount  Decimal   @default(0) @db.Decimal(10, 2)
  customerCategoryId String?
  customerId         String?
  customer           Customer? @relation(fields: [customerId], references: [id])
  startDate          DateTime  @default(now()) // New Field
  expiryDate         DateTime?
  conditions         Json?     // New Field: { brands: [], categories: [] }
  usageLimit         Int       @default(1) // 1: Single use, 0 or >1: Multi use
  usedCount          Int       @default(0)
  isUsed             Boolean   @default(false)
  usedAt             DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([code])
  @@index([customerId])
  @@index([isUsed])
}
