generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("USER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MarketplaceConfig {
  id        String    @id @default(cuid())
  type      String    @unique
  settings  Json
  isActive  Boolean   @default(false)
  lastSync  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Order {
  id              String    @id @default(cuid())
  marketplaceId   String
  orderNumber     String    @unique
  marketplace     String
  customerName    String
  customerEmail   String?
  totalAmount     Decimal   @db.Decimal(10, 2)
  currency        String    @default("TRY")
  status          String
  orderDate       DateTime
  items           Json
  shippingAddress Json?
  invoiceAddress  Json?
  cargoTrackingNo String?
  cargoProvider   String?
  rawData         Json?
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  branch          String?   @default("Merkez")

  @@index([marketplace, orderNumber])
  @@index([customerName])
  @@index([orderDate])
  @@index([status])
}

model Product {
  id                  String                  @id @default(cuid())
  name                String
  code                String
  barcode             String?
  price               Decimal                 @db.Decimal(10, 2)
  buyPrice            Decimal                 @default(0) @db.Decimal(10, 2)
  stock               Int                     @default(0)
  category            String?
  description         String?
  imageUrl            String?
  minStock            Int                     @default(5)
  brand               String?
  type                String?                 @default("Ürün")
  supplier            String?
  branch              String?                 @default("Merkez")
  salesVat            Int?                    @default(20)
  salesVatIncluded    Boolean?                @default(true)
  purchaseVat         Int?                    @default(20)
  purchaseVatIncluded Boolean?                @default(true)
  salesOiv            Decimal?                @default(0) @db.Decimal(10, 2)
  salesOtv            Decimal?                @default(0) @db.Decimal(10, 2)
  otvType             String?                 @default("Ö.T.V yok")
  gtip                String?
  purchaseDiscount    Decimal?                @default(0) @db.Decimal(5, 2)
  otvCode             String?                 @default("7")
  deletedAt           DateTime?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  marketplaceMaps     MarketplaceProductMap[]
  stocks              Stock[]
  movements           StockMovement[]

  @@unique([code, branch])
  @@index([name])
  @@index([barcode])
  @@index([code])
  @@index([category])
  @@index([supplier])
}

model StockMovement {
  id          String   @id @default(cuid())
  productId   String
  branch      String
  quantity    Int      // + for in, - for out
  price       Decimal  @db.Decimal(10, 2) // Purchase price or cost price
  type        String   // 'PURCHASE', 'SALE', 'ADJUSTMENT', 'TRANSFER'
  referenceId String?  // ID of PurchaseInvoice, SalesInvoice, etc.
  createdAt   DateTime @default(now())
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([branch])
  @@index([createdAt])
}

model Stock {
  id        String   @id @default(cuid())
  productId String
  branch    String
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, branch])
  @@index([branch])
}

model MarketplaceProductMap {
  id              String   @id @default(cuid())
  marketplace     String
  marketplaceCode String
  productId       String
  createdAt       DateTime @default(now())
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([marketplace, marketplaceCode])
  @@index([productId])
}

model Supplier {
  id            String            @id @default(cuid())
  name          String
  phone         String?
  email         String?
  address       String?
  category      String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal           @default(0) @db.Decimal(12, 2)
  branch        String?           @default("Merkez")
  isActive      Boolean           @default(true)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  checks        Check[]
  invoices      PurchaseInvoice[]
  transactions  Transaction[]

  @@index([name])
  @@index([taxNumber])
  @@index([phone])
}

model PurchaseInvoice {
  id          String    @id @default(cuid())
  invoiceNo   String
  invoiceDate DateTime
  dueDate     DateTime?
  amount      Decimal   @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  description String?
  supplierId  String
  items       Json?
  status      String    @default("Bekliyor")
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  supplier    Supplier  @relation(fields: [supplierId], references: [id])

  @@index([invoiceNo])
  @@index([invoiceDate])
  @@index([supplierId])
  @@index([status])
}

model SalesInvoice {
  id          String    @id @default(cuid())
  invoiceNo   String    @unique
  invoiceDate DateTime  @default(now())
  amount      Decimal   @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  description String?
  customerId  String
  items       Json
  status      String    @default("Taslak")
  isFormal    Boolean   @default(false)
  branch      String?   @default("Merkez")
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  customer    Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([invoiceDate])
  @@index([invoiceNo])
  @@index([status])
}

model Customer {
  id            String             @id @default(cuid())
  name          String
  email         String?
  phone         String?
  address       String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal            @default(0) @db.Decimal(12, 2)
  points        Decimal            @default(0) @db.Decimal(10, 2)
  branch        String?            @default("Merkez")
  categoryId    String?
  supplierClass String?
  customerClass String?
  deletedAt     DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  referralCode  String?            @unique
  checks        Check[]
  coupons       Coupon[]
  category      CustomerCategory?  @relation(fields: [categoryId], references: [id])
  documents     CustomerDocument[]
  invoices      SalesInvoice[]
  services      ServiceRecord[]
  transactions  Transaction[]
  warranties    Warranty[]

  @@index([name])
  @@index([phone])
  @@index([email])
  @@index([taxNumber])
}

model ServiceRecord {
  id            String    @id @default(cuid())
  customerId    String
  plate         String?
  km            Int?
  nextKm        Int?
  nextDate      DateTime?
  vehicleBrand  String?
  vehicleSerial String?
  notes         String?
  status        String    @default("Tamamlandı")
  totalAmount   Decimal   @db.Decimal(10, 2)
  items         Json
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  customer      Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([plate])
  @@index([nextDate])
  @@index([status])
}

model CustomerDocument {
  id         String   @id @default(cuid())
  customerId String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model CustomerCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customers   Customer[]
}

model Kasa {
  id           String        @id @default(cuid())
  name         String        @unique
  type         String        @default("Nakit")
  balance      Decimal       @default(0) @db.Decimal(12, 2)
  currency     String        @default("TRY")
  isActive     Boolean       @default(true)
  deletedAt    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  branch       String?       @default("Merkez")
  transactions Transaction[]
}

model Transaction {
  id          String    @id @default(cuid())
  type        String
  amount      Decimal   @db.Decimal(12, 2)
  description String?
  date        DateTime  @default(now())
  kasaId      String?
  customerId  String?
  supplierId  String?
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  branch      String?   @default("Merkez")
  customer    Customer? @relation(fields: [customerId], references: [id])
  kasa        Kasa?     @relation(fields: [kasaId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  @@index([customerId])
  @@index([supplierId])
  @@index([date])
  @@index([type])
  @@index([kasaId])
  @@index([branch])
}

model Check {
  id          String    @id @default(cuid())
  type        String
  number      String
  bank        String?
  dueDate     DateTime
  amount      Decimal   @db.Decimal(12, 2)
  status      String    @default("Beklemede")
  description String?
  customerId  String?
  supplierId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  branch      String?   @default("Merkez")
  customer    Customer? @relation(fields: [customerId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  @@index([dueDate])
  @@index([status])
  @@index([number])
  @@index([branch])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userName  String?
  action    String   // 'CREATE', 'UPDATE', 'DELETE'
  entity    String   // 'Customer', 'Product', 'Transaction', etc.
  entityId  String?
  oldData   Json?
  newData   Json?
  details   String?
  ipAddress String?
  branch    String?
  createdAt DateTime @default(now())

  @@index([action, entity])
  @@index([entityId])
  @@index([userId])
  @@index([createdAt])
}

model Branch {
  id        Int              @id @default(autoincrement())
  name      String           @unique
  type      String           @default("Şube")
  city      String?
  address   String?
  phone     String?
  manager   String?
  status    String           @default("Aktif")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  deletedAt DateTime?        // Soft delete
  documents BranchDocument[]
}

model BranchDocument {
  id         String   @id @default(cuid())
  branchId   Int
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
}

model SuspendedSale {
  id        String   @id @default(cuid())
  label     String
  items     Json
  customer  Json?
  total     Decimal  @db.Decimal(12, 2)
  branch    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Staff {
  id            String          @id @default(cuid())
  username      String          @unique
  password      String?
  email         String?
  name          String
  role          String?
  branch        String?         @default("Merkez")
  type          String?         @default("service")
  status        String?         @default("Boşta")
  currentJob    String?
  permissions   String[]        @default([])
  performance   Int?            @default(100)
  lastActive    DateTime?       @default(now())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?       // Soft delete
  salary        Decimal?        @default(17002) @db.Decimal(10, 2)
  address       String?
  age           Int?
  leaveRequests LeaveRequest[]
  payrolls      Payroll[]
  shifts        Shift[]
  documents     StaffDocument[]

  @@index([username])
}

model StaffDocument {
  id         String   @id @default(cuid())
  staffId    String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
}

model Shift {
  id        String   @id @default(cuid())
  staffId   String
  start     DateTime
  end       DateTime
  type      String   @default("Normal")
  branch    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([start])
}

model LeaveRequest {
  id         String   @id @default(cuid())
  staffId    String
  type       String
  startDate  DateTime
  endDate    DateTime
  days       Int
  reason     String?
  status     String   @default("Bekliyor")
  approvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([status])
}

model Payroll {
  id         String    @id @default(cuid())
  staffId    String
  period     String
  salary     Decimal   @db.Decimal(10, 2)
  bonus      Decimal   @default(0) @db.Decimal(10, 2)
  deductions Decimal   @default(0) @db.Decimal(10, 2)
  netPay     Decimal   @db.Decimal(10, 2)
  status     String    @default("Bekliyor")
  paidAt     DateTime?
  note       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  staff      Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, period])
  @@index([period])
}

model Notification {
  id        String   @id @default(cuid())
  type      String   @default("info")
  icon      String?
  text      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model PendingProduct {
  id          String   @id @default(cuid())
  productData Json
  requestedBy String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PendingTransfer {
  id           String   @id @default(cuid())
  transferData Json
  requestedBy  String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model StockTransfer {
  id          String    @id @default(cuid())
  productId   String
  productName String
  productCode String
  qty         Int
  fromBranch  String
  toBranch    String
  status      String    @default("IN_TRANSIT")
  requestedBy String?
  shippedAt   DateTime  @default(now())
  receivedAt  DateTime?
  receivedBy  String?
  trackingNo  String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([fromBranch])
  @@index([toBranch])
}

model InventoryAudit {
  id         String    @id @default(cuid())
  branch     String
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  status     String    @default("in_progress")
  items      Json
  reportedBy String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model AppSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

model Warranty {
  id          String   @id @default(cuid())
  customerId  String
  productName String
  serialNo    String
  startDate   DateTime
  endDate     DateTime
  period      String
  status      String   @default("Active")
  invoiceNo   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([serialNo])
}

model SecurityEvent {
  id                String   @id @default(cuid())
  timestamp         DateTime @default(now())
  detectedPhrase    String
  confidence        Float
  hasSaleInLast5Min Boolean  @default(false)
  branch            String
  staff             String
  details           String?
  createdAt         DateTime @default(now())

  @@index([timestamp])
  @@index([branch])
}

model Campaign {
  id           String    @id @default(cuid())
  name         String
  type         String
  description  String?
  conditions   Json
  discountRate Float?
  pointsRate   Float?
  startDate    DateTime  @default(now())
  endDate      DateTime?
  isActive     Boolean   @default(true)
  deletedAt    DateTime? // Soft delete
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([type])
  @@index([isActive])
}

model Coupon {
  id                 String    @id @default(cuid())
  code               String    @unique
  type               String
  value              Float
  minPurchaseAmount  Decimal   @default(0) @db.Decimal(10, 2)
  customerCategoryId String?
  customerId         String?
  expiryDate         DateTime?
  isUsed             Boolean   @default(false)
  usedAt             DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  campaignName       String?
  conditions         Json?
  startDate          DateTime  @default(now())
  usageLimit         Int       @default(1)
  usedCount          Int       @default(0)
  customer           Customer? @relation(fields: [customerId], references: [id])

  @@index([code])
  @@index([customerId])
  @@index([isUsed])
}

model PaymentPlan {
  id               String        @id @default(cuid())
  title            String
  totalAmount      Decimal       @db.Decimal(12, 2)
  installmentCount Int
  startDate        DateTime
  description      String?
  type             String        @default("Kredi")
  status           String        @default("Active")
  branch           String?       @default("Merkez")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  customerId       String?
  direction        String        @default("OUT")
  supplierId       String?
  installments     Installment[]
}

model Installment {
  id            String      @id @default(cuid())
  paymentPlanId String
  installmentNo Int
  dueDate       DateTime
  amount        Decimal     @db.Decimal(12, 2)
  status        String      @default("Pending")
  paidAt        DateTime?
  transactionId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  paymentPlan   PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([status])
}
