generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------
// SAAS CORE & TENANT MANAGEMENT
// ------------------------------------------

model Tenant {
  id         String @id @default(cuid())
  name       String // Hesap/Müşteri Adı
  ownerEmail String // Ana Hesap Sahibi
  phone      String? // İletişim Telefonu (WhatsApp için)
  status     String @default("ACTIVE") // ACTIVE, SUSPENDED, TRIAL

  subscription Subscription?
  companies    Company[]
  users        User[]
  upsellEvents  UpsellEvent[]
  growthEvents  GrowthEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Company {
  id        String  @id @default(cuid())
  tenantId  String
  name      String
  vkn       String
  taxOffice String?
  address       String?
  district      String?
  city          String?

  integratorSettings IntegratorSettings?

  tenant Tenant              @relation(fields: [tenantId], references: [id])
  users  UserCompanyAccess[]

  // Operational Relationships - Modified to include relations
  invoices         SalesInvoice[]
  purchaseInvoices PurchaseInvoice[]
  products         Product[]
  customers        Customer[]
  suppliers        Supplier[]
  accounts         Account[]
  transactions     Transaction[]
  stockMovements   StockMovement[]
  kasalar          Kasa[]
  checks           Check[]
  serviceRecords   ServiceRecord[]
  quotes           Quote[]
  paymentPlans     PaymentPlan[]
  orders           Order[]

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  Journal           Journal[]
  MarketplaceConfig MarketplaceConfig[]

  @@unique([tenantId, vkn])
  @@index([vkn])
}

// ------------------------------------------
// ENTEGRATOR & SETTINGS
// ------------------------------------------

model IntegratorSettings {
  id          String  @id @default(cuid())
  companyId   String  @unique
  provider    String // NILVERA, SOVOS...
  credentials String // Encrypted JSON
  isActive    Boolean @default(true)
  environment String  @default("PRODUCTION")

  company Company @relation(fields: [companyId], references: [id])
}

// ------------------------------------------
// SUBSCRIPTION & PLAN MANAGEMENT
// ------------------------------------------

model Plan {
  id          String  @id @default(cuid())
  name        String
  description     String?
  price           Decimal  @default(0) @db.Decimal(10, 2)
  currency        String   @default("TRY")
  interval        String   @default("MONTHLY") // MONTHLY, YEARLY
  iyzicoPlanCode  String?  // Iyzico Product Code
  isActive        Boolean  @default(true)

  features      PlanFeature[]
  limits        PlanLimit[]
  subscriptions Subscription[]
}

model Feature {
  id          String  @id @default(cuid())
  key         String  @unique
  name        String
  description String?

  plans PlanFeature[]
}

model PlanFeature {
  planId    String
  featureId String

  plan    Plan    @relation(fields: [planId], references: [id])
  feature Feature @relation(fields: [featureId], references: [id])

  @@id([planId, featureId])
}

model PlanLimit {
  id       String @id @default(cuid())
  planId   String
  resource String
  limit    Int // -1 = Unlimited

  plan Plan @relation(fields: [planId], references: [id])

  @@unique([planId, resource])
}

model Subscription {
  id       String @id @default(cuid())
  tenantId String @unique
  externalId String? @unique // Iyzico Reference Code
  planId   String

  status String
  period String

  startDate DateTime
  endDate   DateTime

  tenant Tenant @relation(fields: [tenantId], references: [id])
  plan   Plan   @relation(fields: [planId], references: [id])

  history SubscriptionHistory[]
}

model SubscriptionHistory {
  id             String   @id @default(cuid())
  subscriptionId String
  action         String
  prevPlanId     String?
  newPlanId      String
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id])
}

// ------------------------------------------
// EXISTING MODELS WITH RELATION UPDATES
// ------------------------------------------

model User {
  id        String   @id @default(cuid())
  tenantId  String?
  email     String   @unique
  name      String?
  password  String
  role      String   @default("USER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastActiveAt DateTime? 

  tenant              Tenant?             @relation(fields: [tenantId], references: [id])
  accessibleCompanies UserCompanyAccess[]
  notifications       Notification[]
}

model UserCompanyAccess {
  userId    String
  companyId String
  role      String // COMPANY_ADMIN, ACCOUNTANT, VIEWER

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  @@id([userId, companyId])
}

// --- Operational Models ---

model Order {
  id              String    @id @default(cuid())
  companyId       String?
  marketplaceId   String
  orderNumber     String    @unique
  marketplace     String
  customerName    String
  customerEmail   String?
  totalAmount     Decimal   @db.Decimal(10, 2)
  currency        String    @default("TRY")
  status          String
  orderDate       DateTime
  items           Json
  shippingAddress Json?
  invoiceAddress  Json?
  cargoTrackingNo String?
  cargoProvider   String?
  rawData         Json?
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  branch          String?   @default("Merkez")

  company Company? @relation(fields: [companyId], references: [id])

  @@index([marketplace, orderNumber])
  @@index([customerName])
  @@index([orderDate])
  @@index([status])
  @@index([companyId])
}

model Product {
  id                  String    @id @default(cuid())
  companyId           String?
  name                String
  code                String
  barcode             String?
  price               Decimal   @db.Decimal(10, 2)
  currency            String    @default("TRY")
  buyPrice            Decimal   @default(0) @db.Decimal(10, 2)
  purchaseCurrency    String    @default("TRY")
  stock               Int       @default(0)
  category            String?
  description         String?
  imageUrl            String?
  minStock            Int       @default(5)
  brand               String?
  type                String?   @default("Ürün")
  supplierName        String? // Changed from 'supplier' to match relation removal if conflict, but keeping as string field for now or linking? Original was String?
  branch              String?   @default("Merkez")
  salesVat            Int?      @default(20)
  salesVatIncluded    Boolean?  @default(true)
  purchaseVat         Int?      @default(20)
  purchaseVatIncluded Boolean?  @default(true)
  salesOiv            Decimal?  @default(0) @db.Decimal(10, 2)
  salesOtv            Decimal?  @default(0) @db.Decimal(10, 2)
  otvType             String?   @default("Ö.T.V yok")
  gtip                String?
  purchaseDiscount    Decimal?  @default(0) @db.Decimal(5, 2)
  otvCode             String?   @default("7")
  unit                String?   @default("Adet")
  deletedAt           DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Variants Support
  isParent      Boolean               @default(false)
  parentId      String?
  parent        Product?              @relation("ProductVariants", fields: [parentId], references: [id])
  variants      Product[]             @relation("ProductVariants")
  variantValues ProductVariantValue[]

  marketplaceMaps MarketplaceProductMap[]
  stocks          Stock[]
  movements       StockMovement[]

  company Company? @relation(fields: [companyId], references: [id])

  @@unique([code, branch, companyId]) // Updated unique constraint for multi-company
  @@index([name])
  @@index([barcode])
  @@index([code])
  @@index([category])
  @@index([parentId])
  @@index([companyId])
}

model VariantAttribute {
  id        String                  @id @default(cuid())
  companyId String?
  name      String // "Renk", "Beden"
  branch    String?                 @default("Merkez")
  values    VariantAttributeValue[]

  @@unique([name, branch, companyId])
}

model VariantAttributeValue {
  id          String                @id @default(cuid())
  attributeId String
  value       String // "Kırmızı", "XL"
  attribute   VariantAttribute      @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  products    ProductVariantValue[]

  @@index([attributeId])
}

model ProductVariantValue {
  productId        String
  attributeValueId String
  product          Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeValue   VariantAttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)

  @@id([productId, attributeValueId])
}

model StockMovement {
  id          String   @id @default(cuid())
  companyId   String?
  productId   String
  branch      String
  quantity    Int // + for in, - for out
  price       Decimal  @db.Decimal(10, 2) // Purchase price or cost price
  type        String // 'PURCHASE', 'SALE', 'ADJUSTMENT', 'TRANSFER'
  referenceId String? // ID of PurchaseInvoice, SalesInvoice, etc.
  createdAt   DateTime @default(now())
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  company     Company? @relation(fields: [companyId], references: [id])

  @@index([productId])
  @@index([branch])
  @@index([createdAt])
  @@index([companyId])
}

model Stock {
  id        String   @id @default(cuid())
  // companyId implied via product
  productId String
  branch    String
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, branch])
  @@index([branch])
}

model MarketplaceProductMap {
  id              String   @id @default(cuid())
  marketplace     String
  marketplaceCode String
  productId       String
  createdAt       DateTime @default(now())
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([marketplace, marketplaceCode])
  @@index([productId])
}

model Supplier {
  id            String            @id @default(cuid())
  companyId     String?
  name          String
  phone         String?
  email         String?
  address       String?
  category      String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal           @default(0) @db.Decimal(12, 2)
  branch        String?           @default("Merkez")
  isActive      Boolean           @default(true)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  checks        Check[]
  invoices      PurchaseInvoice[]
  transactions  Transaction[]

  company Company? @relation(fields: [companyId], references: [id])

  @@index([name])
  @@index([taxNumber])
  @@index([phone])
  @@index([companyId])
}

model PurchaseInvoice {
  id          String    @id @default(cuid())
  companyId   String?
  invoiceNo   String
  invoiceDate DateTime
  dueDate     DateTime?
  amount      Decimal   @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  description String?
  supplierId  String
  items       Json?
  status      String    @default("Bekliyor")
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  supplier    Supplier  @relation(fields: [supplierId], references: [id])
  company     Company?  @relation(fields: [companyId], references: [id])

  @@index([invoiceNo])
  @@index([invoiceDate])
  @@index([supplierId])
  @@index([status])
  @@index([companyId])
}

model SalesInvoice {
  id           String    @id @default(cuid())
  companyId    String?
  invoiceNo    String    @unique
  invoiceDate  DateTime  @default(now())
  amount       Decimal   @db.Decimal(10, 2)
  taxAmount    Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount  Decimal   @db.Decimal(10, 2)
  description  String?
  customerId   String
  items        Json
  status       String    @default("Taslak")
  isFormal     Boolean   @default(false)
  formalType   String?
  formalId     String?   @unique
  formalUuid   String?   @unique
  formalStatus String?
  branch       String?   @default("Merkez")
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  customer     Customer  @relation(fields: [customerId], references: [id])
  company      Company?  @relation(fields: [companyId], references: [id])

  @@index([customerId])
  @@index([invoiceDate])
  @@index([invoiceNo])
  @@index([status])
  @@index([companyId])
}

model Customer {
  id            String             @id @default(cuid())
  companyId     String?
  name          String
  email         String?
  phone         String?
  address       String?
  district      String?
  city          String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal            @default(0) @db.Decimal(12, 2)
  points        Decimal            @default(0) @db.Decimal(10, 2)
  branch        String?            @default("Merkez")
  categoryId    String?
  supplierClass String?
  customerClass String?
  deletedAt     DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  referralCode  String?            @unique
  checks        Check[]
  coupons       Coupon[]
  category      CustomerCategory?  @relation(fields: [categoryId], references: [id])
  documents     CustomerDocument[]
  invoices      SalesInvoice[]
  services      ServiceRecord[]
  transactions  Transaction[]
  warranties    Warranty[]
  quotes        Quote[]

  company Company? @relation(fields: [companyId], references: [id])

  @@index([name])
  @@index([phone])
  @@index([email])
  @@index([taxNumber])
  @@index([companyId])
}

model ServiceRecord {
  id            String    @id @default(cuid())
  companyId     String?
  customerId    String
  plate         String?
  km            Int?
  nextKm        Int?
  nextDate      DateTime?
  vehicleBrand  String?
  vehicleSerial String?
  notes         String?
  status        String    @default("Tamamlandı")
  totalAmount   Decimal   @db.Decimal(10, 2)
  items         Json
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  customer      Customer  @relation(fields: [customerId], references: [id])
  company       Company?  @relation(fields: [companyId], references: [id])

  @@index([customerId])
  @@index([plate])
  @@index([nextDate])
  @@index([status])
  @@index([companyId])
}

model CustomerDocument {
  id         String   @id @default(cuid())
  customerId String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model CustomerCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customers   Customer[]
}

model Kasa {
  id           String        @id @default(cuid())
  companyId    String?
  name         String
  type         String        @default("Nakit")
  balance      Decimal       @default(0) @db.Decimal(12, 2)
  currency     String        @default("TRY")
  isActive     Boolean       @default(true)
  deletedAt    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  branch       String?       @default("Merkez")
  transactions Transaction[]

  company Company? @relation(fields: [companyId], references: [id])

  @@unique([name, branch, companyId])
  @@index([companyId])
}

model Transaction {
  id           String    @id @default(cuid())
  companyId    String?
  type         String
  amount       Decimal   @db.Decimal(12, 2)
  description  String?
  date         DateTime  @default(now())
  kasaId       String?
  targetKasaId String?
  customerId   String?
  supplierId   String?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  branch       String?   @default("Merkez")
  customer     Customer? @relation(fields: [customerId], references: [id])
  kasa         Kasa?     @relation(fields: [kasaId], references: [id])
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  company      Company?  @relation(fields: [companyId], references: [id])

  @@index([customerId])
  @@index([supplierId])
  @@index([date])
  @@index([type])
  @@index([kasaId])
  @@index([branch])
  @@index([companyId])
}

model Check {
  id          String    @id @default(cuid())
  companyId   String?
  type        String
  number      String
  bank        String?
  dueDate     DateTime
  amount      Decimal   @db.Decimal(12, 2)
  status      String    @default("Beklemede")
  description String?
  customerId  String?
  supplierId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  branch      String?   @default("Merkez")
  customer    Customer? @relation(fields: [customerId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  company     Company?  @relation(fields: [companyId], references: [id])

  @@index([dueDate])
  @@index([status])
  @@index([number])
  @@index([branch])
  @@index([companyId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userName  String?
  action    String // 'CREATE', 'UPDATE', 'DELETE'
  entity    String // 'Customer', 'Product', 'Transaction', etc.
  entityId  String?
  oldData   Json?
  newData   Json?
  details   String?
  ipAddress String?
  branch    String?
  createdAt DateTime @default(now())
  tenantId  String? // Audit logs are usually at Tenant level for security oversight

  @@index([action, entity])
  @@index([entityId])
  @@index([userId])
  @@index([userName])
  @@index([createdAt])
}

model LoginAttempt {
  id        String   @id @default(cuid())
  ip        String
  username  String
  success   Boolean
  createdAt DateTime @default(now())

  @@index([ip, createdAt])
  @@index([username, createdAt])
}

model Branch {
  id        Int              @id @default(autoincrement())
  // companyId   String?  // Branch connects to Company if we want strict relation
  name      String           @unique
  type      String           @default("Şube")
  city      String?
  address   String?
  phone     String?
  manager   String?
  status    String           @default("Aktif")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  deletedAt DateTime? // Soft delete
  documents BranchDocument[]
}

model BranchDocument {
  id         String   @id @default(cuid())
  branchId   Int
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
}

model SuspendedSale {
  id        String   @id @default(cuid())
  label     String
  items     Json
  customer  Json?
  total     Decimal  @db.Decimal(12, 2)
  branch    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Staff {
  id               String          @id @default(cuid())
  username         String          @unique
  password         String?
  email            String?
  name             String
  role             String?
  branch           String?         @default("Merkez")
  type             String?         @default("service")
  status           String?         @default("Boşta")
  currentJob       String?
  permissions      String[]        @default([])
  performance      Int?            @default(100)
  lastActive       DateTime?       @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?
  salary           Decimal?        @default(17002) @db.Decimal(10, 2)
  address          String?
  age              Int?
  leaveRequests    LeaveRequest[]
  payrolls         Payroll[]
  shifts           Shift[]
  documents        StaffDocument[]
  sentMessages     Message[]       @relation("SentMessages")
  receivedMessages Message[]       @relation("ReceivedMessages")

  @@index([username])
}

model Message {
  id         String   @id @default(cuid())
  content    String
  senderId   String
  receiverId String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  sender   Staff  @relation("SentMessages", fields: [senderId], references: [id])
  receiver Staff? @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@index([senderId])
  @@index([receiverId])
}

model StaffDocument {
  id         String   @id @default(cuid())
  staffId    String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
}

model Shift {
  id        String   @id @default(cuid())
  staffId   String
  start     DateTime
  end       DateTime
  type      String   @default("Normal")
  branch    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([start])
}

model LeaveRequest {
  id         String   @id @default(cuid())
  staffId    String
  type       String
  startDate  DateTime
  endDate    DateTime
  days       Int
  reason     String?
  status     String   @default("Bekliyor")
  approvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([status])
}

model Payroll {
  id         String    @id @default(cuid())
  staffId    String
  period     String
  salary     Decimal   @db.Decimal(10, 2)
  bonus      Decimal   @default(0) @db.Decimal(10, 2)
  deductions Decimal   @default(0) @db.Decimal(10, 2)
  netPay     Decimal   @db.Decimal(10, 2)
  status     String    @default("Bekliyor")
  paidAt     DateTime?
  note       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  staff      Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, period])
  @@index([period])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("INFO") // INFO, WARNING, SUCCESS, ERROR
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}

model PendingProduct {
  id          String   @id @default(cuid())
  productData Json
  requestedBy String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PendingTransfer {
  id           String   @id @default(cuid())
  transferData Json
  requestedBy  String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model StockTransfer {
  id          String    @id @default(cuid())
  productId   String
  productName String
  productCode String
  qty         Int
  fromBranch  String
  toBranch    String
  status      String    @default("IN_TRANSIT")
  requestedBy String?
  shippedAt   DateTime  @default(now())
  receivedAt  DateTime?
  receivedBy  String?
  trackingNo  String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([fromBranch])
  @@index([toBranch])
}

model InventoryAudit {
  id         String    @id @default(cuid())
  branch     String
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  status     String    @default("in_progress")
  items      Json
  reportedBy String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model AppSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

model Warranty {
  id          String   @id @default(cuid())
  customerId  String
  productName String
  serialNo    String
  startDate   DateTime
  endDate     DateTime
  period      String
  status      String   @default("Active")
  invoiceNo   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([serialNo])
}

model SecurityEvent {
  id                String   @id @default(cuid())
  timestamp         DateTime @default(now())
  detectedPhrase    String
  confidence        Float
  hasSaleInLast5Min Boolean  @default(false)
  branch            String
  staff             String
  details           String?
  createdAt         DateTime @default(now())

  @@index([timestamp])
  @@index([branch])
}

model Campaign {
  id           String    @id @default(cuid())
  name         String
  type         String
  description  String?
  conditions   Json
  discountRate Float?
  pointsRate   Float?
  startDate    DateTime  @default(now())
  endDate      DateTime?
  isActive     Boolean   @default(true)
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([type])
  @@index([isActive])
}

model Coupon {
  id                 String    @id @default(cuid())
  code               String    @unique
  type               String
  value              Float
  minPurchaseAmount  Decimal   @default(0) @db.Decimal(10, 2)
  customerCategoryId String?
  customerId         String?
  expiryDate         DateTime?
  isUsed             Boolean   @default(false)
  usedAt             DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  campaignName       String?
  conditions         Json?
  startDate          DateTime  @default(now())
  usageLimit         Int       @default(1)
  usedCount          Int       @default(0)
  customer           Customer? @relation(fields: [customerId], references: [id])

  @@index([code])
  @@index([customerId])
  @@index([isUsed])
}

model PaymentPlan {
  id               String        @id @default(cuid())
  companyId        String?
  title            String
  totalAmount      Decimal       @db.Decimal(12, 2)
  installmentCount Int
  startDate        DateTime
  description      String?
  type             String        @default("Kredi")
  status           String        @default("Active")
  branch           String?       @default("Merkez")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  customerId       String?
  direction        String        @default("OUT")
  supplierId       String?
  installments     Installment[]

  company Company? @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model Installment {
  id            String      @id @default(cuid())
  paymentPlanId String
  installmentNo Int
  dueDate       DateTime
  amount        Decimal     @db.Decimal(12, 2)
  status        String      @default("Pending")
  paidAt        DateTime?
  transactionId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  paymentPlan   PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([status])
}

// --- RESMİ MUHASEBE (ACCOUNTING CORE) ---

model Account {
  id         String  @id @default(cuid())
  companyId  String?
  code       String // Örn: "100.01.001"
  name       String // Örn: "Merkez Nakit Kasa"
  parentCode String? // Örn: "100.01" (Ağaç yapısı için)

  // Muhasebe Standartları (Yeni Alanlar)
  accountClass  String? // AKTIF | PASIF | OZKAYNAK | GELIR | GIDER
  normalBalance String? // BORC | ALACAK
  reportGroup   String? // Dönen Varlık, Satış, Finansman vb.
  reportType    String? // BILANCO | GELIR_TABLOSU

  type     String // Eski tip (Uyum için tutuluyor: "Borç" / "Alacak")
  balance  Decimal @default(0) @db.Decimal(15, 2)
  isActive Boolean @default(true)

  // Ön Muhasebe ile Eşleştirme (Mapping)
  kasaId     String? @unique
  bankId     String? @unique // Kasa tablosundaki 'Banka' tipli kayıtlar için
  customerId String?
  supplierId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Branching support for accounts
  branch String? @default("Merkez")

  journalItems JournalItem[]
  company      Company?      @relation(fields: [companyId], references: [id])

  @@unique([code, branch, companyId])
  @@index([code])
  @@index([parentCode])
  @@index([companyId])
}

model Journal {
  id          String   @id @default(cuid())
  companyId   String?
  date        DateTime @default(now())
  fisNo       String // Unique per company/year usually, but keep simple unique first
  description String? // Fiş Açıklaması
  type        String   @default("Mahsup") // Tahsil, Tediye, Mahsup

  totalDebt   Decimal @db.Decimal(15, 2)
  totalCredit Decimal @db.Decimal(15, 2)
  isBalanced  Boolean // Borç == Alacak kontrolü

  status String  @default("Draft") // Draft, Approved, Locked (Deftere Yazıldı)
  branch String? @default("Merkez")

  sourceType String? // "Sales", "Purchase", "Payment", "Collection"
  sourceId   String? // Transaction ID, Invoice ID vb.

  isReversal Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items   JournalItem[]
  company Company?      @relation(fields: [companyId], references: [id])

  @@unique([fisNo, companyId, branch])
  @@index([date])
  @@index([fisNo])
  @@index([branch])
  @@index([companyId])
}

model JournalItem {
  id          String  @id @default(cuid())
  journalId   String
  accountId   String
  description String?

  debt   Decimal @default(0) @db.Decimal(15, 2) // Borç
  credit Decimal @default(0) @db.Decimal(15, 2) // Alacak

  // e-Defter Required Fields
  documentType  String? // Örn: "FATURA", "MAKBUZ", "CEK", "BANKA_ISLEM"
  documentNo    String? // Belge No
  documentDate  DateTime? // Belge Tarihi
  paymentMethod String? // Örn: "NAKIT", "KREDI_KARTI", "HAVALE"

  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id])
  journal Journal @relation(fields: [journalId], references: [id], onDelete: Cascade)

  @@index([journalId])
  @@index([accountId])
}

model Quote {
  id          String    @id @default(cuid())
  companyId   String?
  quoteNo     String    @unique
  date        DateTime  @default(now())
  validUntil  DateTime?
  customerId  String
  items       Json
  subTotal    Decimal   @default(0) @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @default(0) @db.Decimal(10, 2)
  status      String    @default("Draft") // Draft, Sent, Accepted, Rejected, Converted
  description String?
  branch      String?   @default("Merkez")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  customer    Customer  @relation(fields: [customerId], references: [id])
  company     Company?  @relation(fields: [companyId], references: [id])

  @@index([customerId])
  @@index([quoteNo])
  @@index([status])
  @@index([companyId])
}

model MarketplaceConfig {
  id        String    @id @default(cuid())
  companyId String?
  type      String    @unique
  settings  Json
  isActive  Boolean   @default(false)
  lastSync  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  company Company? @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model ExternalRequest {
  id              String   @id @default(cuid())
  provider        String   // "NILVERA", "IYZICO"
  idempotencyKey  String
  entityType      String   // "SALES_INVOICE", "SUBSCRIPTION"
  entityId        String
  status          String   // PENDING | SUCCESS | FAILED
  responsePayload Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([provider, idempotencyKey])
  @@index([entityId])
  @@index([status])
}

// ------------------------------------------
// GROWTH & AUTOMATION (PHASE 9)
// ------------------------------------------

model GrowthEvent {
  id        String   @id @default(cuid())
  tenantId  String
  type      String   // INACTIVITY_7D, INACTIVITY_14D, LIMIT_80, GROWTH_SIGNAL
  status    String   @default("PENDING") // PENDING, SENT, FAILED, IGNORED
  payload   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([type])
  @@index([status])
}

model UpsellEvent {
  id           String   @id @default(cuid())
  tenantId     String
  type         String   // SOFT, CONTEXTUAL, HARD
  source       String   // DASHBOARD, INVOICE_PAGE, LIMIT_LOCK
  targetPlanId String?
  converted    Boolean  @default(false)
  payload      Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([type])
  @@index([converted])
}
