generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id           String        @id @default(cuid())
  name         String
  ownerEmail   String
  phone        String?
  status       String        @default("ACTIVE")
  setupState   String        @default("PENDING")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  companies    Company[]
  growthEvents GrowthEvent[]
  subscription Subscription?
  upsellEvents UpsellEvent[]
  users        User[]
}

model Company {
  id                 String                         @id @default(cuid())
  tenantId           String
  name               String
  vkn                String
  taxOffice          String?
  address            String?
  district           String?
  city               String?
  createdAt          DateTime                       @default(now())
  updatedAt          DateTime                       @updatedAt
  accounts           Account[]
  appSettings        AppSettings[]
  bankConnections    BankConnection[]
  bankStatements     BankStatement[]
  bankTransactions   BankTransaction[]
  branches           Branch[]
  cashflowForecasts  CashflowForecast[]
  checks             Check[]
  tenant             Tenant                         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  coupons            Coupon[]
  customers          Customer[]
  customerCategories CustomerCategory[]
  domainEvents       DomainEvent[]
  externalRequests   ExternalRequest[]
  fintechAudits      FintechAudit[]
  integratorSettings IntegratorSettings?
  inventoryLayers    InventoryLayer[]
  Journal            Journal[]
  journalEntries     JournalEntry[]
  kasalar            Kasa[]
  MarketplaceConfig  MarketplaceConfig[]
  orderFinances      MarketplaceOrderFinance[]
  productMaps        MarketplaceProductMap[]
  marketplacePnls    MarketplaceProductPnl[]
  settlements        MarketplaceSettlement[]
  transactionLedgers MarketplaceTransactionLedger[]
  matchingRules      MatchingRule[]
  orders             Order[]
  paymentMatches     PaymentMatch[]
  paymentPlans       PaymentPlan[]
  priceLists         PriceList[]
  autopilotConfigs   PricingAutopilotConfig[]
  products           Product[]
  purchaseInvoices   PurchaseInvoice[]
  quotes             Quote[]
  routes             Route[]
  invoices           SalesInvoice[]
  salesOrders        SalesOrder[]
  visits             SalesVisit[]
  serviceRecords     ServiceRecord[]
  smartPricingRules  SmartPricingRule[]
  staff              Staff[]
  staffTargets       StaffTarget[]
  stockMovements     StockMovement[]
  stockTransfers     StockTransfer[]
  suppliers          Supplier[]
  suspendedSales     SuspendedSale[]
  transactions       Transaction[]
  users              UserCompanyAccess[]

  @@unique([tenantId, vkn])
  @@index([vkn])
}

model IntegratorSettings {
  id          String  @id @default(cuid())
  companyId   String  @unique
  provider    String
  credentials String
  isActive    Boolean @default(true)
  environment String  @default("PRODUCTION")
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Plan {
  id             String         @id @default(cuid())
  name           String
  description    String?
  price          Decimal        @default(0) @db.Decimal(10, 2)
  currency       String         @default("TRY")
  interval       String         @default("MONTHLY")
  iyzicoPlanCode String?
  isActive       Boolean        @default(true)
  features       PlanFeature[]
  limits         PlanLimit[]
  subscriptions  Subscription[]
}

model Feature {
  id          String        @id @default(cuid())
  key         String        @unique
  name        String
  description String?
  plans       PlanFeature[]
}

model PlanFeature {
  planId    String
  featureId String
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)
  plan      Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@id([planId, featureId])
}

model PlanLimit {
  id       String @id @default(cuid())
  planId   String
  resource String
  limit    Int
  plan     Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, resource])
}

model Subscription {
  id         String                @id @default(cuid())
  tenantId   String                @unique
  externalId String?               @unique
  planId     String
  status     String
  period     String
  startDate  DateTime
  endDate    DateTime
  plan       Plan                  @relation(fields: [planId], references: [id])
  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  history    SubscriptionHistory[]
}

model SubscriptionHistory {
  id             String       @id @default(cuid())
  subscriptionId String
  action         String
  prevPlanId     String?
  newPlanId      String
  createdAt      DateTime     @default(now())
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
}

model User {
  id                  String              @id @default(cuid())
  email               String              @unique
  name                String?
  password            String
  role                String              @default("USER")
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  lastActiveAt        DateTime?
  tenantId            String
  permissions         String[]            @default([])
  notifications       Notification[]
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accessibleCompanies UserCompanyAccess[]
}

model UserCompanyAccess {
  userId    String
  companyId String
  role      String
  company   Company @relation(fields: [companyId], references: [id])
  user      User    @relation(fields: [userId], references: [id])

  @@id([userId, companyId])
}

model Order {
  id                String    @id @default(cuid())
  marketplaceId     String
  orderNumber       String
  marketplace       String
  customerName      String
  customerEmail     String?
  totalAmount       Decimal   @db.Decimal(10, 2)
  currency          String    @default("TRY")
  status            String
  orderDate         DateTime
  items             Json
  shippingAddress   Json?
  invoiceAddress    Json?
  cargoTrackingNo   String?
  cargoProvider     String?
  rawData           Json?
  deletedAt         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  branch            String?   @default("Merkez")
  companyId         String
  shipmentPackageId String?
  detailsFetchedAt  DateTime? // Tracking for hydration logic
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, orderNumber])
  @@index([marketplace, orderNumber])
  @@index([customerName])
  @@index([orderDate])
  @@index([status])
  @@index([companyId])
}

model Product {
  id                  String                  @id @default(cuid())
  name                String
  code                String
  barcode             String?
  price               Decimal                 @db.Decimal(10, 2)
  buyPrice            Decimal                 @default(0) @db.Decimal(10, 2)
  stock               Int                     @default(0)
  category            String?
  description         String?
  imageUrl            String?
  minStock            Int                     @default(5)
  brand               String?
  type                String?                 @default("Ürün")
  branch              String?                 @default("Merkez")
  salesVat            Int?                    @default(20)
  salesVatIncluded    Boolean?                @default(true)
  purchaseVat         Int?                    @default(20)
  purchaseVatIncluded Boolean?                @default(true)
  salesOiv            Decimal?                @default(0) @db.Decimal(10, 2)
  salesOtv            Decimal?                @default(0) @db.Decimal(10, 2)
  otvType             String?                 @default("Ö.T.V yok")
  gtip                String?
  purchaseDiscount    Decimal?                @default(0) @db.Decimal(5, 2)
  otvCode             String?                 @default("7")
  deletedAt           DateTime?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  companyId           String
  currency            String                  @default("TRY")
  isParent            Boolean                 @default(false)
  parentId            String?
  purchaseCurrency    String                  @default("TRY")
  supplierName        String?
  unit                String?                 @default("Adet")
  marketplaceMaps     MarketplaceProductMap[]
  marketplacePnls     MarketplaceProductPnl[]
  company             Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent              Product?                @relation("ProductVariants", fields: [parentId], references: [id])
  variants            Product[]               @relation("ProductVariants")
  productPrices       ProductPrice[]
  variantValues       ProductVariantValue[]
  salesOrderItems     SalesOrderItem[]
  pricingRules        SmartPricingRule[]
  stocks              Stock[]
  movements           StockMovement[]

  @@unique([code, branch, companyId])
  @@index([name])
  @@index([barcode])
  @@index([code])
  @@index([category])
  @@index([parentId])
  @@index([companyId])
}

model VariantAttribute {
  id        String                  @id @default(cuid())
  companyId String?
  name      String
  branch    String?                 @default("Merkez")
  values    VariantAttributeValue[]

  @@unique([name, branch, companyId])
}

model VariantAttributeValue {
  id          String                @id @default(cuid())
  attributeId String
  value       String
  products    ProductVariantValue[]
  attribute   VariantAttribute      @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@index([attributeId])
}

model ProductVariantValue {
  productId        String
  attributeValueId String
  attributeValue   VariantAttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)
  product          Product               @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, attributeValueId])
}

model StockMovement {
  id          String   @id @default(cuid())
  productId   String
  branch      String
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  type        String
  referenceId String?
  createdAt   DateTime @default(now())
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([branch])
  @@index([createdAt])
  @@index([companyId])
}

model Stock {
  id        String   @id @default(cuid())
  productId String
  branch    String
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, branch])
  @@index([branch])
}

model MarketplaceProductMap {
  id              String   @id @default(cuid())
  companyId       String
  marketplace     String
  marketplaceCode String
  productId       String
  createdAt       DateTime @default(now())
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, marketplace, marketplaceCode])
  @@index([productId])
  @@index([companyId])
}

model Supplier {
  id            String            @id @default(cuid())
  name          String
  phone         String?
  email         String?
  address       String?
  category      String?
  taxNumber     String?
  taxOffice     String?
  contactPerson String?
  iban          String?
  balance       Decimal           @default(0) @db.Decimal(12, 2)
  branch        String?           @default("Merkez")
  isActive      Boolean           @default(true)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  city          String?
  companyId     String
  district      String?
  checks        Check[]
  invoices      PurchaseInvoice[]
  company       Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([name])
  @@index([taxNumber])
  @@index([phone])
  @@index([companyId])
}

model PurchaseInvoice {
  id          String    @id @default(cuid())
  invoiceNo   String
  invoiceDate DateTime
  dueDate     DateTime?
  amount      Decimal   @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  description String?
  supplierId  String
  items       Json?
  status      String    @default("Bekliyor")
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier    Supplier  @relation(fields: [supplierId], references: [id])

  @@index([invoiceNo])
  @@index([invoiceDate])
  @@index([supplierId])
  @@index([status])
  @@index([companyId])
}

model SalesInvoice {
  id           String    @id @default(cuid())
  invoiceNo    String    @unique
  invoiceDate  DateTime  @default(now())
  amount       Decimal   @db.Decimal(10, 2)
  taxAmount    Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount  Decimal   @db.Decimal(10, 2)
  description  String?
  customerId   String
  items        Json
  status       String    @default("Taslak")
  isFormal     Boolean   @default(false)
  branch       String?   @default("Merkez")
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  companyId    String
  formalId     String?   @unique
  formalStatus String?
  formalType   String?
  formalUuid   String?   @unique
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([invoiceDate])
  @@index([invoiceNo])
  @@index([status])
  @@index([companyId])
}

model Customer {
  id              String             @id @default(cuid())
  name            String
  email           String?
  phone           String?
  address         String?
  taxNumber       String?
  taxOffice       String?
  contactPerson   String?
  iban            String?
  balance         Decimal            @default(0) @db.Decimal(12, 2)
  points          Decimal            @default(0) @db.Decimal(10, 2)
  branch          String?            @default("Merkez")
  categoryId      String?
  supplierClass   String?
  customerClass   String?
  deletedAt       DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  referralCode    String?            @unique
  city            String?
  companyId       String
  district        String?
  isPortalActive  Boolean            @default(false)
  lastPortalLogin DateTime?
  portalPassword  String?
  checks          Check[]
  coupons         Coupon[]
  category        CustomerCategory?  @relation(fields: [categoryId], references: [id])
  company         Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents       CustomerDocument[]
  quotes          Quote[]
  routeStops      RouteStop[]
  invoices        SalesInvoice[]
  salesOrders     SalesOrder[]
  visits          SalesVisit[]
  services        ServiceRecord[]
  transactions    Transaction[]
  warranties      Warranty[]

  @@unique([email, companyId])
  @@index([name])
  @@index([phone])
  @@index([email])
  @@index([taxNumber])
  @@index([companyId])
}

model ServiceRecord {
  id            String    @id @default(cuid())
  customerId    String
  plate         String?
  km            Int?
  nextKm        Int?
  nextDate      DateTime?
  vehicleBrand  String?
  vehicleSerial String?
  notes         String?
  status        String    @default("Tamamlandı")
  totalAmount   Decimal   @db.Decimal(10, 2)
  items         Json
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer      Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([plate])
  @@index([nextDate])
  @@index([status])
  @@index([companyId])
}

model CustomerDocument {
  id         String   @id @default(cuid())
  customerId String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model CustomerCategory {
  id          String     @id @default(cuid())
  companyId   String
  name        String
  description String?
  priceListId String?
  isDefault   Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customers   Customer[]
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  priceList   PriceList? @relation(fields: [priceListId], references: [id])

  @@unique([companyId, name])
  @@index([companyId])
  @@index([priceListId])
}

model PriceList {
  id            String             @id @default(cuid())
  companyId     String
  name          String
  description   String?
  currency      String             @default("TRY")
  isDefault     Boolean            @default(false)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  categories    CustomerCategory[]
  company       Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  productPrices ProductPrice[]

  @@unique([companyId, name])
  @@index([companyId])
}

model ProductPrice {
  id                String    @id @default(cuid())
  companyId         String
  productId         String
  priceListId       String
  price             Decimal   @db.Decimal(12, 2)
  isManualOverride  Boolean   @default(false)
  derivedFromListId String?
  formulaMarkupBps  Int?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  priceList         PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, priceListId], name: "companyId_productId_priceListId")
  @@index([productId])
  @@index([priceListId])
  @@index([companyId])
}

model Kasa {
  id               String          @id @default(cuid())
  name             String
  type             String          @default("Nakit")
  balance          Decimal         @default(0) @db.Decimal(12, 2)
  currency         String          @default("TRY")
  isActive         Boolean         @default(true)
  deletedAt        DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  branch           String?         @default("Merkez")
  companyId        String
  bankConnectionId String?         @unique
  iban             String?
  bankConnection   BankConnection? @relation(fields: [bankConnectionId], references: [id])
  company          Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions     Transaction[]

  @@unique([name, branch, companyId])
  @@index([companyId])
}

model Transaction {
  id           String    @id @default(cuid())
  type         String
  amount       Decimal   @db.Decimal(12, 2)
  description  String?
  date         DateTime  @default(now())
  kasaId       String?
  targetKasaId String?
  customerId   String?
  supplierId   String?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  branch       String?   @default("Merkez")
  companyId    String
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer     Customer? @relation(fields: [customerId], references: [id])
  kasa         Kasa?     @relation(fields: [kasaId], references: [id])
  supplier     Supplier? @relation(fields: [supplierId], references: [id])

  @@index([customerId])
  @@index([supplierId])
  @@index([date])
  @@index([type])
  @@index([kasaId])
  @@index([branch])
  @@index([companyId])
  @@index([createdAt])
}

model Check {
  id          String    @id @default(cuid())
  type        String
  number      String
  bank        String?
  dueDate     DateTime
  amount      Decimal   @db.Decimal(12, 2)
  status      String    @default("Beklemede")
  description String?
  customerId  String?
  supplierId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  branch      String?   @default("Merkez")
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer? @relation(fields: [customerId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  @@index([dueDate])
  @@index([status])
  @@index([number])
  @@index([branch])
  @@index([companyId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userName  String?
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  branch    String?
  createdAt DateTime @default(now())
  after     Json?
  before    Json?
  tenantId  String?
  userAgent String?

  @@index([action, entity])
  @@index([entityId])
  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
}

model LoginAttempt {
  id        String   @id @default(cuid())
  ip        String
  username  String
  success   Boolean
  createdAt DateTime @default(now())

  @@index([ip, createdAt])
  @@index([username, createdAt])
}

model Branch {
  id        Int              @id @default(autoincrement())
  name      String
  type      String           @default("Şube")
  city      String?
  address   String?
  phone     String?
  manager   String?
  status    String           @default("Aktif")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  deletedAt DateTime?
  companyId String
  district  String?
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents BranchDocument[]

  @@unique([companyId, name])
}

model BranchDocument {
  id         String   @id @default(cuid())
  branchId   Int
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
}

model SuspendedSale {
  id        String   @id @default(cuid())
  companyId String?
  label     String
  items     Json
  customer  Json?
  total     Decimal  @db.Decimal(12, 2)
  branch    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Staff {
  id               String          @id @default(cuid())
  username         String          @unique
  password         String?
  email            String?
  name             String
  role             String?
  branch           String?         @default("Merkez")
  type             String?         @default("service")
  status           String?         @default("Boşta")
  currentJob       String?
  permissions      String[]        @default([])
  performance      Int?            @default(100)
  lastActive       DateTime?       @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?
  salary           Decimal?        @default(17002) @db.Decimal(10, 2)
  address          String?
  age              Int?
  companyId        String?
  phone            String?
  tenantId         String?         @default("PLATFORM_ADMIN")
  leaveRequests    LeaveRequest[]
  receivedMessages Message[]       @relation("ReceivedMessages")
  sentMessages     Message[]       @relation("SentMessages")
  payrolls         Payroll[]
  routes           Route[]
  salesOrders      SalesOrder[]
  visits           SalesVisit[]
  shifts           Shift[]
  company          Company?        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents        StaffDocument[]
  targets          StaffTarget[]

  @@index([tenantId])
  @@index([companyId])
  @@index([username])
}

model Message {
  id         String   @id @default(cuid())
  content    String
  senderId   String
  receiverId String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiver   Staff?   @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     Staff    @relation("SentMessages", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([receiverId])
}

model StaffDocument {
  id         String   @id @default(cuid())
  staffId    String
  fileName   String
  fileType   String
  fileSize   Int
  fileData   String
  uploadedAt DateTime @default(now())
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
}

model Shift {
  id        String   @id @default(cuid())
  staffId   String
  start     DateTime
  end       DateTime
  type      String   @default("Normal")
  branch    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([start])
}

model LeaveRequest {
  id         String   @id @default(cuid())
  staffId    String
  type       String
  startDate  DateTime
  endDate    DateTime
  days       Int
  reason     String?
  status     String   @default("Bekliyor")
  approvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  staff      Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([status])
}

model Payroll {
  id         String    @id @default(cuid())
  staffId    String
  period     String
  salary     Decimal   @db.Decimal(10, 2)
  bonus      Decimal   @default(0) @db.Decimal(10, 2)
  deductions Decimal   @default(0) @db.Decimal(10, 2)
  netPay     Decimal   @db.Decimal(10, 2)
  status     String    @default("Bekliyor")
  paidAt     DateTime?
  note       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  staff      Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, period])
  @@index([period])
}

model Notification {
  id        String   @id @default(cuid())
  type      String   @default("INFO")
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  link      String?
  message   String
  title     String
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}

model PendingProduct {
  id          String   @id @default(cuid())
  productData Json
  requestedBy String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PendingTransfer {
  id           String   @id @default(cuid())
  transferData Json
  requestedBy  String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model StockTransfer {
  id          String    @id @default(cuid())
  productId   String
  productName String
  productCode String
  qty         Int
  fromBranch  String
  toBranch    String
  status      String    @default("IN_TRANSIT")
  requestedBy String?
  shippedAt   DateTime  @default(now())
  receivedAt  DateTime?
  receivedBy  String?
  trackingNo  String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyId   String?
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([companyId])
  @@index([fromBranch])
  @@index([toBranch])
}

model InventoryAudit {
  id         String    @id @default(cuid())
  branch     String
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  status     String    @default("in_progress")
  items      Json
  reportedBy String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model AppSettings {
  id        String   @id @default(cuid())
  companyId String
  key       String
  value     Json
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, key])
  @@index([companyId])
}

model Warranty {
  id          String   @id @default(cuid())
  customerId  String
  productName String
  serialNo    String
  startDate   DateTime
  endDate     DateTime
  period      String
  status      String   @default("Active")
  invoiceNo   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([serialNo])
}

model SecurityEvent {
  id                String   @id @default(cuid())
  timestamp         DateTime @default(now())
  detectedPhrase    String
  confidence        Float
  hasSaleInLast5Min Boolean  @default(false)
  branch            String
  staff             String
  details           String?
  createdAt         DateTime @default(now())

  @@index([timestamp])
  @@index([branch])
}

model Campaign {
  id           String    @id @default(cuid())
  name         String
  type         String
  description  String?
  conditions   Json
  discountRate Float?
  pointsRate   Float?
  startDate    DateTime  @default(now())
  endDate      DateTime?
  isActive     Boolean   @default(true)
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([type])
  @@index([isActive])
}

model Coupon {
  id                 String    @id @default(cuid())
  companyId          String?
  code               String    @unique
  type               String
  value              Float
  minPurchaseAmount  Decimal   @default(0) @db.Decimal(10, 2)
  customerCategoryId String?
  customerId         String?
  expiryDate         DateTime?
  isUsed             Boolean   @default(false)
  usedAt             DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  campaignName       String?
  conditions         Json?
  startDate          DateTime  @default(now())
  usageLimit         Int       @default(1)
  usedCount          Int       @default(0)
  company            Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer           Customer? @relation(fields: [customerId], references: [id])

  @@index([code])
  @@index([customerId])
  @@index([isUsed])
  @@index([companyId])
}

model PaymentPlan {
  id               String        @id @default(cuid())
  title            String
  totalAmount      Decimal       @db.Decimal(12, 2)
  installmentCount Int
  startDate        DateTime
  description      String?
  type             String        @default("Kredi")
  status           String        @default("Active")
  branch           String?       @default("Merkez")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  customerId       String?
  direction        String        @default("OUT")
  supplierId       String?
  companyId        String?
  installments     Installment[]
  company          Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Installment {
  id            String      @id @default(cuid())
  paymentPlanId String
  installmentNo Int
  dueDate       DateTime
  amount        Decimal     @db.Decimal(12, 2)
  status        String      @default("Pending")
  paidAt        DateTime?
  transactionId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  paymentPlan   PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([status])
}

model Account {
  id            String        @id @default(cuid())
  code          String
  name          String
  parentCode    String?
  accountClass  String?
  normalBalance String?
  reportGroup   String?
  reportType    String?
  type          String
  balance       Decimal       @default(0) @db.Decimal(15, 2)
  isActive      Boolean       @default(true)
  kasaId        String?       @unique
  bankId        String?       @unique
  customerId    String?
  supplierId    String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  branch        String?       @default("Merkez")
  companyId     String?
  company       Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalItems  JournalItem[]

  @@unique([code, branch, companyId])
  @@index([code])
  @@index([parentCode])
  @@index([companyId])
}

model Journal {
  id          String        @id @default(cuid())
  date        DateTime      @default(now())
  fisNo       String
  description String?
  type        String        @default("Mahsup")
  totalDebt   Decimal       @db.Decimal(15, 2)
  totalCredit Decimal       @db.Decimal(15, 2)
  isBalanced  Boolean
  status      String        @default("Draft")
  branch      String?       @default("Merkez")
  sourceType  String?
  sourceId    String?
  isReversal  Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  companyId   String?
  company     Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items       JournalItem[]

  @@unique([fisNo, companyId, branch])
  @@index([date])
  @@index([fisNo])
  @@index([branch])
  @@index([companyId])
}

model JournalItem {
  id            String    @id @default(cuid())
  journalId     String
  accountId     String
  description   String?
  debt          Decimal   @default(0) @db.Decimal(15, 2)
  credit        Decimal   @default(0) @db.Decimal(15, 2)
  documentType  String?
  documentNo    String?
  documentDate  DateTime?
  paymentMethod String?
  createdAt     DateTime  @default(now())
  account       Account   @relation(fields: [accountId], references: [id])
  journal       Journal   @relation(fields: [journalId], references: [id], onDelete: Cascade)

  @@index([journalId])
  @@index([accountId])
}

model Quote {
  id          String    @id @default(cuid())
  quoteNo     String    @unique
  date        DateTime  @default(now())
  validUntil  DateTime?
  customerId  String
  items       Json
  subTotal    Decimal   @default(0) @db.Decimal(10, 2)
  taxAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount Decimal   @default(0) @db.Decimal(10, 2)
  status      String    @default("Draft")
  description String?
  branch      String?   @default("Merkez")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyId   String?
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([quoteNo])
  @@index([status])
  @@index([companyId])
}

model MarketplaceConfig {
  id        String    @id @default(cuid())
  type      String
  settings  Json
  isActive  Boolean   @default(false)
  lastSync  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  companyId String
  deletedAt DateTime?
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, type])
  @@index([companyId])
  @@index([deletedAt])
}

model ExternalRequest {
  id              String   @id @default(cuid())
  companyId       String?
  provider        String
  idempotencyKey  String
  entityType      String
  entityId        String
  status          String
  responsePayload Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  company         Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([provider, idempotencyKey])
  @@index([entityId])
  @@index([status])
  @@index([companyId])
}

model GrowthEvent {
  id        String   @id @default(cuid())
  tenantId  String
  type      String
  status    String   @default("PENDING")
  payload   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([status])
}

model UpsellEvent {
  id           String   @id @default(cuid())
  tenantId     String
  type         String
  source       String
  targetPlanId String?
  converted    Boolean  @default(false)
  payload      Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([converted])
}

model CmsPage {
  id          String       @id @default(cuid())
  slug        String       @unique
  title       String
  description String?
  keywords    String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  sections    CmsSection[]
}

model CmsSection {
  id       String  @id @default(cuid())
  pageId   String
  type     String
  order    Int     @default(0)
  content  Json
  isActive Boolean @default(true)
  page     CmsPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
}

model CmsMenu {
  id        String   @id @default(cuid())
  name      String
  items     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CmsGeneralSettings {
  id             String   @id @default(cuid())
  logoUrl        String?
  faviconUrl     String?
  siteTitle      String   @default("Periodya")
  footerText     String?
  primaryColor   String   @default("#446ee7")
  contactEmail   String?
  whatsappNumber String?
  customCss      String?
  updatedAt      DateTime @updatedAt
}

model Route {
  id        String      @id @default(cuid())
  companyId String
  staffId   String
  name      String
  date      DateTime
  status    String      @default("PENDING")
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff     Staff       @relation(fields: [staffId], references: [id], onDelete: Cascade)
  stops     RouteStop[]

  @@index([companyId])
  @@index([staffId])
  @@index([date])
}

model RouteStop {
  id          String       @id @default(cuid())
  routeId     String
  customerId  String
  sequence    Int
  status      String       @default("PENDING")
  plannedTime DateTime?
  customer    Customer     @relation(fields: [customerId], references: [id])
  route       Route        @relation(fields: [routeId], references: [id], onDelete: Cascade)
  visits      SalesVisit[]

  @@index([routeId])
  @@index([customerId])
}

model SalesVisit {
  id               String       @id @default(cuid())
  companyId        String
  routeStopId      String?
  customerId       String
  staffId          String
  checkInTime      DateTime     @default(now())
  checkOutTime     DateTime?
  checkInLocation  Json?
  checkOutLocation Json?
  notes            String?
  photos           String[]
  isOutOfRange     Boolean      @default(false)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  orders           SalesOrder[]
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer         Customer     @relation(fields: [customerId], references: [id])
  stop             RouteStop?   @relation(fields: [routeStopId], references: [id])
  staff            Staff        @relation(fields: [staffId], references: [id])

  @@index([companyId])
  @@index([staffId])
  @@index([customerId])
  @@index([checkInTime])
}

model SalesOrder {
  id          String           @id @default(cuid())
  companyId   String
  visitId     String?
  customerId  String
  staffId     String
  totalAmount Decimal          @db.Decimal(10, 2)
  status      String           @default("PENDING")
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer         @relation(fields: [customerId], references: [id])
  staff       Staff            @relation(fields: [staffId], references: [id])
  visit       SalesVisit?      @relation(fields: [visitId], references: [id])
  items       SalesOrderItem[]

  @@index([companyId])
  @@index([visitId])
  @@index([customerId])
}

model SalesOrderItem {
  id          String     @id @default(cuid())
  orderId     String
  productId   String
  productName String
  quantity    Int
  unitPrice   Decimal    @db.Decimal(10, 2)
  totalPrice  Decimal    @db.Decimal(10, 2)
  order       SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product    @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model StaffTarget {
  id           String   @id @default(cuid())
  staffId      String
  companyId    String
  type         String
  targetValue  Decimal  @db.Decimal(12, 2)
  currentValue Decimal  @default(0) @db.Decimal(12, 2)
  period       String
  month        Int?
  year         Int?
  startDate    DateTime
  endDate      DateTime
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  staff        Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model DomainEvent {
  id            String   @id @default(cuid())
  companyId     String
  tenantId      String?
  eventType     String
  aggregateType String
  aggregateId   String
  payload       Json
  metadata      Json?
  createdAt     DateTime @default(now())
  createdBy     String?
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, aggregateType, createdAt])
  @@index([aggregateId])
}

model InventoryLayer {
  id                String                 @id @default(cuid())
  companyId         String
  productId         String
  sourceEventId     String
  quantityInitial   Decimal                @db.Decimal(15, 4)
  quantityRemaining Decimal                @db.Decimal(15, 4)
  unitCost          Decimal                @db.Decimal(15, 4)
  branch            String?                @default("Merkez")
  createdAt         DateTime               @default(now())
  consumptions      InventoryConsumption[]
  company           Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([productId, quantityRemaining, createdAt])
  @@index([companyId])
}

model InventoryConsumption {
  id                 String         @id @default(cuid())
  companyId          String
  layerId            String
  consumptionEventId String
  quantity           Decimal        @db.Decimal(15, 4)
  unitCostAtTime     Decimal        @db.Decimal(15, 4)
  createdAt          DateTime       @default(now())
  layer              InventoryLayer @relation(fields: [layerId], references: [id])

  @@index([layerId])
  @@index([consumptionEventId])
}

model JournalEntry {
  id            String        @id @default(cuid())
  entryNumber   Int           @unique @default(autoincrement())
  companyId     String
  sourceEventId String?       @unique
  description   String
  date          DateTime      @default(now())
  createdAt     DateTime      @default(now())
  createdBy     String?
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines         JournalLine[]

  @@index([companyId, date])
}

model JournalLine {
  id                String       @id @default(cuid())
  journalEntryId    String
  accountCode       String
  debit             Decimal      @default(0) @db.Decimal(15, 2)
  credit            Decimal      @default(0) @db.Decimal(15, 2)
  externalReference String?
  companyId         String
  isOpen            Boolean      @default(true)
  journalEntry      JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@index([accountCode, companyId, isOpen])
}

model MarketplaceOrderFinance {
  id                String    @id @default(cuid())
  companyId         String
  orderId           String    @unique
  orderNumber       String
  marketplace       String
  commissionRate    Decimal   @db.Decimal(5, 2)
  commissionAmount  Decimal   @db.Decimal(15, 2)
  shippingFee       Decimal   @db.Decimal(15, 2)
  otherFees         Decimal   @db.Decimal(15, 2)
  netProfit         Decimal   @db.Decimal(15, 2)
  receivableBalance Decimal   @db.Decimal(15, 2)
  isSettled         Boolean   @default(false)
  currency          String    @default("TRY")
  lastMatchedAt     DateTime?
  createdAt         DateTime  @default(now())
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, marketplace])
}

model MarketplaceSettlement {
  id                String    @id @default(cuid())
  companyId         String
  marketplace       String
  settlementId      String    @unique
  periodStart       DateTime
  periodEnd         DateTime
  totalAmount       Decimal   @db.Decimal(15, 2)
  commissionTotal   Decimal   @db.Decimal(15, 2)
  payoutAmount      Decimal   @db.Decimal(15, 2)
  status            String    @default("PENDING")
  externalReference String?
  journalEntryId    String?
  reconciledAt      DateTime?
  createdAt         DateTime  @default(now())
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, marketplace, status])
}

model MarketplaceTransactionLedger {
  id                     String         @id @default(cuid())
  companyId              String
  marketplace            String
  externalReference      String         @unique
  orderId                String?
  orderNumber            String?
  transactionType        String
  amount                 Decimal        @db.Decimal(15, 2)
  transactionDate        DateTime
  processingStatus       String         @default("PENDING")
  reconciliationStatus   String?
  journalEntryId         String?
  matchedBankStatementId String?
  createdAt              DateTime       @default(now())
  company                Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bankStatement          BankStatement? @relation(fields: [matchedBankStatementId], references: [id])

  @@index([companyId, marketplace, processingStatus])
  @@index([externalReference])
}

model BankStatement {
  id               String                         @id @default(cuid())
  companyId        String
  bankAccountCode  String
  statementDate    DateTime
  referenceNo      String                         @unique
  description      String
  debit            Decimal                        @db.Decimal(15, 2)
  credit           Decimal                        @db.Decimal(15, 2)
  balance          Decimal?                       @db.Decimal(15, 2)
  isMatched        Boolean                        @default(false)
  matchedJournalId String?
  createdAt        DateTime                       @default(now())
  company          Company                        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transLedgers     MarketplaceTransactionLedger[]

  @@index([companyId, statementDate])
  @@index([referenceNo])
}

model MarketplaceProductPnl {
  id               String   @id @default(cuid())
  companyId        String
  productId        String
  marketplace      String
  grossRevenue     Decimal  @default(0) @db.Decimal(15, 2)
  commissionTotal  Decimal  @default(0) @db.Decimal(15, 2)
  shippingTotal    Decimal  @default(0) @db.Decimal(15, 2)
  otherFeesTotal   Decimal  @default(0) @db.Decimal(15, 2)
  fifoCostTotal    Decimal  @default(0) @db.Decimal(15, 2)
  refundCostTotal  Decimal  @default(0) @db.Decimal(15, 2)
  netProfit        Decimal  @default(0) @db.Decimal(15, 2)
  profitMargin     Decimal  @default(0) @db.Decimal(5, 2)
  saleCount        Int      @default(0)
  refundCount      Int      @default(0)
  lastUpdatedAt    DateTime @updatedAt
  refundedQuantity Int      @default(0)
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, marketplace])
  @@index([companyId, marketplace])
}

model SmartPricingRule {
  id           String   @id @default(cuid())
  companyId    String
  productId    String
  marketplace  String
  targetMargin Decimal  @db.Decimal(5, 2)
  minPrice     Decimal  @db.Decimal(15, 2)
  maxPrice     Decimal  @db.Decimal(15, 2)
  isActive     Boolean  @default(true)
  lastUpdated  DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([companyId, productId, marketplace])
}

model BankConnection {
  id                   String               @id @default(cuid())
  companyId            String
  bankName             String
  iban                 String               @unique
  currency             String               @default("TRY")
  lastSyncAt           DateTime?
  status               String               @default("DRAFT")
  createdAt            DateTime             @default(now())
  bankId               String?
  connectionType       String               @default("OPEN_BANKING")
  consecutiveFailures  Int                  @default(0)
  credentialsEncrypted Json?
  credentialsVersion   Int                  @default(1)
  integrationMethod    String               @default("MANUAL_UPLOAD")
  lastErrorAt          DateTime?
  lastErrorCode        String?
  lastErrorMessage     String?
  nextRetryAt          DateTime?
  updatedAt            DateTime             @updatedAt
  balances             BankAccountBalance[]
  company              Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions         BankTransaction[]
  kasalar              Kasa?

  @@index([companyId])
  @@index([companyId, bankId])
}

model BankAccountBalance {
  id               String         @id @default(cuid())
  bankConnectionId String
  balance          Decimal        @db.Decimal(15, 2)
  currency         String
  asOf             DateTime
  createdAt        DateTime       @default(now())
  connection       BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
}

model BankTransaction {
  id                     String         @id @default(cuid())
  companyId              String
  bankConnectionId       String
  transactionId          String
  amount                 Decimal        @db.Decimal(14, 2)
  currency               String
  description            String?
  transactionDate        DateTime
  valueDate              DateTime?
  direction              String
  rawPayload             Json
  createdAt              DateTime       @default(now())
  bankRef                String?
  transactionFingerprint String
  connection             BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
  company                Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  matches                PaymentMatch[]

  @@unique([bankConnectionId, transactionFingerprint])
  @@index([companyId, transactionDate])
}

model PricingAutopilotConfig {
  id                    String   @id @default(cuid())
  companyId             String
  marketplace           String
  enabled               Boolean  @default(false)
  minMargin             Decimal  @db.Decimal(5, 2)
  maxDailyChangePct     Decimal  @db.Decimal(5, 2)
  pauseOnNegativeStock  Boolean  @default(true)
  pauseOnHighReturnRate Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, marketplace])
}

model PaymentMatch {
  id                String          @id @default(cuid())
  companyId         String
  bankTransactionId String
  ledgerId          String?
  matchType         String
  confidenceScore   Int             @default(100)
  confidenceBucket  String          @default("HIGH")
  status            String          @default("PENDING")
  journalEntryId    String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  bankTransaction   BankTransaction @relation(fields: [bankTransactionId], references: [id], onDelete: Cascade)
  company           Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
}

model MatchingRule {
  id          String   @id @default(cuid())
  companyId   String
  pattern     String
  targetType  String
  entityName  String?
  accountCode String?
  confidence  Int      @default(100)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, pattern])
}

model CashflowForecast {
  id           String   @id @default(cuid())
  companyId    String
  horizonDays  Int
  expectedIn   Decimal  @db.Decimal(15, 2)
  expectedOut  Decimal  @db.Decimal(15, 2)
  netPosition  Decimal  @db.Decimal(15, 2)
  calculatedAt DateTime @default(now())
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, calculatedAt])
}

model FintechAudit {
  id            String   @id @default(cuid())
  companyId     String
  who           String
  action        String
  details       String?
  before        Json?
  after         Json?
  sourceEventId String?
  createdAt     DateTime @default(now())
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, action])
  @@index([createdAt])
}

model MarketplaceActionAudit {
  id              String    @id @default(cuid())
  companyId       String
  marketplace     String
  orderId         String?
  actionKey       String
  idempotencyKey  String    @unique
  status          String
  requestPayload  Json?
  responsePayload Json?
  errorMessage    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  jobId           String?
  lockExpiresAt   DateTime?
  failureHistory  Json?
  retryCount      Int       @default(0)

  @@index([companyId, marketplace, createdAt])
  @@index([orderId])
}

model MarketplaceLabel {
  id                String   @id @default(cuid())
  companyId         String
  marketplace       String
  shipmentPackageId String
  storageKey        String
  sha256            String
  size              Int
  contentType       String   @default("application/pdf")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([companyId, marketplace, shipmentPackageId])
  @@index([companyId, createdAt])
}
